<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Horse Racing - Ultimate Edition</title>
    <link rel="apple-touch-icon" href="icon.png">
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background-color: #333; color: white; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* --- [1] ê²½ê¸°ì¥ ì˜ì—­ --- */
        #race-track { 
            flex: 1.3; 
            background: #2c3e50; position: relative; overflow: hidden; 
            border-bottom: 5px solid #f1c40f; 
            display: flex; flex-direction: column; 
            padding-top: 20px; 
        }
        
        .track-line { 
            flex: 1; 
            border-bottom: 1px dashed rgba(255,255,255,0.15); 
            position: relative; display: flex; align-items: center; 
        }
        
        .horse { 
            font-size: 32px; 
            position: absolute; left: 10px; 
            transition: left 0.1s linear, transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            z-index: 10; transform: scaleX(-1); 
            transform-origin: center bottom;
        }
        
        /* [ì¶”ê°€] ë¹„í‹€ê±°ë¦¬ëŠ” íš¨ê³¼ (ìƒíƒœì´ìƒ) */
        .stumbling {
            filter: grayscale(100%); /* í‘ë°± ì²˜ë¦¬ */
            transform: scaleX(-1) rotate(15deg) !important; /* ì•ìœ¼ë¡œ ê³ ê¾¸ë¼ì§ */
            transition: transform 0.2s;
        }

        .horse-name-tag {
            position: absolute; top: -16px; left: 0; font-size: 10px; 
            background: rgba(0,0,0,0.6); color: #fff; padding: 2px 6px; border-radius: 4px; 
            white-space: nowrap; transform: scaleX(-1); pointer-events: none;
        }
        
        .tag-S { background: linear-gradient(45deg, #ffd700, #ffaa00); color: #000; font-weight: bold; box-shadow: 0 0 5px #ffd700; }
        .tag-A { background: #3498db; font-weight: bold; }
        .tag-F { background: #555; color: #aaa; }

        .finish-line { 
            position: absolute; right: 30px; top: 0; height: 100%; width: 5px; 
            background: repeating-linear-gradient(45deg, white, white 10px, black 10px, black 20px); 
            z-index: 5;
        }

        /* --- [2] ë°°íŒ… íŒ¨ë„ --- */
        #betting-panel { 
            flex: 1; background: #fff; color: #333; padding: 10px; 
            overflow-y: auto; display: flex; flex-direction: column; 
            box-shadow: 0 -5px 20px rgba(0,0,0,0.3); z-index: 20;
        }
        
        .info-bar { display: flex; justify-content: space-between; align-items: center; font-weight: bold; padding-bottom: 10px; border-bottom: 2px solid #eee; margin-bottom: 10px; }
        .my-money { color: #d35400; font-size: 18px; }
        
        .top-btn-group { display: flex; gap: 8px; }
        .icon-btn { background: #95a5a6; color: white; border: none; border-radius: 15px; padding: 4px 10px; font-size: 12px; cursor: pointer; font-weight: bold; }
        .btn-tip { background: #2c3e50; color: #f1c40f; border: 1px solid #f1c40f; }

        .horse-list { display: flex; flex-direction: column; gap: 8px; padding-bottom: 10px;}
        
        .horse-card { 
            display: flex; flex-direction: column; 
            background: #f9f9f9; padding: 10px; border-radius: 10px; border: 1px solid #eee; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .card-top { display: flex; align-items: center; justify-content: space-between; width: 100%; margin-bottom: 8px; }
        .card-bottom { display: flex; align-items: center; justify-content: space-between; width: 100%; background: #eee; padding: 5px; border-radius: 8px;}

        .h-info { flex: 1; }
        .h-name { font-weight: bold; font-size: 15px; color: #333; display: flex; align-items: center; gap: 5px; }
        .tier-badge { font-size: 10px; padding: 1px 5px; border-radius: 3px; color: white; font-weight: bold; min-width: 15px; text-align: center; }
        
        .tier-S { background: linear-gradient(135deg, #ffd700, #f1c40f); color: black; box-shadow: 0 0 5px #f1c40f; }
        .tier-A { background: #e74c3c; }
        .tier-B { background: #3498db; }
        .tier-C { background: #2ecc71; }
        .tier-D { background: #95a5a6; }
        .tier-F { background: #7f8c8d; opacity: 0.7; }

        .h-stats { font-size: 12px; color: #666; margin-top: 3px; }
        .h-odds { font-size: 18px; font-weight: bold; color: #c0392b; width: 80px; text-align: right;}
        
        .bet-btn-group { display: flex; gap: 4px; flex: 1; }
        .bet-btn { 
            padding: 6px 8px; border: none; border-radius: 5px; font-size: 11px; font-weight: bold; 
            cursor: pointer; background: #fff; border: 1px solid #ccc; color: #555; transition: 0.1s;
        }
        .bet-btn:active { background: #ddd; transform: scale(0.95); }
        .btn-allin { background: #e74c3c; color: white; border: 1px solid #c0392b; }

        .bet-input { 
            width: 70px; padding: 6px; border: 1px solid #ccc; border-radius: 5px; 
            text-align: right; font-size: 14px; margin-left: 5px;
        }
        .btn-reset { background: #e67e22; color: white; width: 80px; flex: none; box-shadow: 0 4px 0 #d35400; margin-right: 5px; }
        .btn-reset:active { transform: translateY(4px); box-shadow: none; }
        
        .control-bar { margin-top: auto; padding-top: 10px; display: flex; gap: 10px; }
        .btn { flex: 1; padding: 15px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 16px; transition: 0.2s; }
        .btn-start { background: #27ae60; color: white; box-shadow: 0 4px 0 #219150; }
        .btn-start:active { transform: translateY(4px); box-shadow: none; }
        .btn-start:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; }
        .btn-back { background: #95a5a6; color: white; width: 80px; flex: none; box-shadow: 0 4px 0 #7f8c8d; }

        #caster-msg {
            position: absolute; top: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: #f1c40f; padding: 8px 20px; border-radius: 30px;
            font-size: 16px; font-weight: bold; pointer-events: none; display: none; z-index: 30;
            white-space: nowrap; box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-shadow: 0 2px 4px black;
        }

        /* ëª¨ë‹¬ ê³µí†µ */
        .modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); z-index: 9999; display: none; 
            justify-content: center; align-items: center; backdrop-filter: blur(2px); 
        }
        
        /* ì˜ˆìƒì§€ ìŠ¤íƒ€ì¼ */
        .tip-paper { 
            background: #f4e1d2; color: #333; width: 90%; max-width: 500px; max-height: 90vh; 
            overflow-y: auto; padding: 20px; border-radius: 5px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.8); border: 1px solid #d3c0b0;
            font-family: 'Gungsuh', 'Batang', serif; position: relative;
        }
        .tip-header { text-align: center; border-bottom: 3px double #333; padding-bottom: 10px; margin-bottom: 15px; }
        .tip-title { font-size: 22px; font-weight: bold; color: #c0392b; text-decoration: underline; word-break: keep-all;}
        .tip-date { font-size: 12px; color: #555; margin-top: 5px; }
        .tip-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .tip-table th { background: #333; color: #f4e1d2; padding: 5px; font-size: 12px; }
        .tip-table td { border-bottom: 1px solid #bbb; padding: 8px 5px; font-size: 13px; vertical-align: middle; }
        .tip-highlight { color: #c0392b; font-weight: bold; background: rgba(255,0,0,0.1); }
        .stamp-box { border: 3px solid #c0392b; border-radius: 10px; padding: 10px; text-align: center; margin-top: 15px; transform: rotate(-2deg); }
        .stamp-text { color: #c0392b; font-weight: bold; font-size: 18px; }

        /* ë„ì›€ë§ ìŠ¤íƒ€ì¼ */
        .help-content { 
            background: white; color: #333; width: 85%; max-width: 400px; max-height: 80vh; 
            overflow-y: auto; padding: 25px; border-radius: 15px; 
            line-height: 1.6; font-size: 14px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* ê²°ê³¼ í™”ë©´ ìŠ¤íƒ€ì¼ */
        .result-paper { 
            background: white; color: #333; width: 90%; max-width: 500px; max-height: 90vh; 
            overflow-y: auto; padding: 25px; border-radius: 15px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.8); border: 4px solid #f1c40f;
        }
        .result-header { font-size: 24px; font-weight: bold; text-align: center; margin-bottom: 20px; color: #d35400; text-decoration: underline; }
        .result-msg { 
            text-align: center; background: #fff3cd; padding: 15px; 
            border-radius: 10px; margin-bottom: 20px; font-weight: bold; color: #856404; 
            line-height: 1.5; border: 1px solid #ffeeba;
        }
        .result-section-title { font-size: 14px; font-weight: bold; color: #555; margin-bottom: 5px; margin-top: 15px; }
        
        .rank-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .rank-table th { background: #333; color: white; padding: 8px; text-align: center; }
        .rank-table td { border-bottom: 1px solid #ddd; padding: 8px; text-align: center; }
        .rank-1st { background: #fffbe6; font-weight: bold; color: #d35400; }
        .rank-injured { color: #aaa; text-decoration: line-through; }

        .log-box { 
            background: #2c3e50; color: #ecf0f1; height: 120px; overflow-y: auto; 
            padding: 10px; border-radius: 5px; font-size: 12px; line-height: 1.6; border: 1px solid #34495e;
        }
        .log-item { margin-bottom: 4px; border-bottom: 1px dashed #444; padding-bottom: 2px; }
    </style>
</head>
<body>

    <div id="race-track">
        <div class="finish-line"></div>
        <div id="caster-msg">ì¤‘ê³„ ì‹œì‘...</div>
        <div class="track-line" id="lane-0"></div>
        <div class="track-line" id="lane-1"></div>
        <div class="track-line" id="lane-2"></div>
        <div class="track-line" id="lane-3"></div>
        <div class="track-line" id="lane-4"></div>
    </div>

    <div id="betting-panel">
        <div class="info-bar">
            <div>
                <span>ë‚´ ì§€ê°‘: <span id="wallet-bal" class="my-money">0</span></span>
                <span style="margin-left: 10px; font-size: 14px; color: #555;">(ì´ ë°°íŒ…: <span id="total-bet" style="color: #c0392b; font-weight: bold;">0</span>)</span>
            </div>
            <div class="top-btn-group">
                <button class="icon-btn btn-tip" onclick="toggleTip()">ğŸ“° ì˜ˆìƒì§€</button>
                <button class="icon-btn" onclick="toggleHelp()">?</button>
            </div>
        </div>

        <div id="horse-list" class="horse-list"></div>

        <div class="control-bar">
            <button class="btn btn-back" onclick="location.href='game3.html'">ë‚˜ê°€ê¸°</button>
            <button class="btn btn-reset" onclick="resetAllBets()">ì´ˆê¸°í™”</button>
            <button id="btn-start" class="btn btn-start" onclick="startRace()" disabled>ë°°íŒ…í•˜ì„¸ìš”</button>
        </div>
    </div>

    <div id="tip-modal" class="modal" onclick="toggleTip()">
        <div class="tip-paper" onclick="event.stopPropagation()">
            <div class="tip-header">
                <div class="tip-title">âš¡ ê¸ˆìš” ê²½ë§ˆ ì ì¤‘ ì˜ˆìƒì§€ âš¡</div>
                <div class="tip-date">ì œ 3ê²½ì£¼ - íŠ¹ë³„ ëŒ€ìƒ ê²½ì£¼</div>
            </div>
            <table class="tip-table">
                <thead>
                    <tr>
                        <th width="15%">ë²ˆí˜¸</th>
                        <th width="20%">ìµœê·¼ì„±ì </th>
                        <th>ì „ë¬¸ê°€ ë¶„ì„ (í•œì¤„í‰)</th>
                    </tr>
                </thead>
                <tbody id="tip-list-body"></tbody>
            </table>
            <div class="stamp-box">
                <div>â˜… ì˜¤ëŠ˜ì˜ ê°•ë ¥ ì¶”ì²œ â˜…</div>
                <div id="recommend-horse" class="stamp-text">???</div>
            </div>
            <button class="btn btn-back" style="width:100%; margin-top:15px; background:#555;" onclick="toggleTip()">ë®ê¸°</button>
        </div>
    </div>

    <div id="help-modal" class="modal" onclick="toggleHelp()">
        <div class="help-content" onclick="event.stopPropagation()">
            <h3 style="text-align:center; border-bottom:2px solid #ddd; padding-bottom:10px; margin-top:0;">ğŸ“– ê²Œì„ ê°€ì´ë“œ</h3>
            <p style="font-size:16px; font-weight:bold; margin-bottom:5px; color:#2c3e50;">1. ë“±ê¸‰ê³¼ ë°°ë‹¹</p>
            <ul style="padding-left:20px; margin-top:0; color:#555;">
                <li><b style="color:#f1c40f; background:#333; padding:0 4px; border-radius:3px;">S/Aê¸‰</b> : ìš°ìŠ¹ í™•ë¥ ì´ ë†’ì§€ë§Œ ë°°ë‹¹ì´ ë‚®ìŠµë‹ˆë‹¤.</li>
                <li><b style="color:#fff; background:#7f8c8d; padding:0 4px; border-radius:3px;">F/Dê¸‰</b> : ìš°ìŠ¹í•˜ê¸° í˜ë“¤ì§€ë§Œ, í„°ì§€ë©´ <b>ìˆ˜ì‹­ ë°°ì˜ ì¸ìƒ ì—­ì „</b>ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
            </ul>
            <p style="font-size:16px; font-weight:bold; margin-bottom:5px; margin-top:15px; color:#c0392b;">2. ê³µí¬ì˜ í”¼ë¡œë„ ì‹œìŠ¤í…œ (ğŸ˜«)</p>
            <div style="background:#fff0f0; padding:10px; border-radius:8px; border:1px solid #ffcccc; font-size:13px;">
                ëª¨ë“  ë§ì€ ëœë¤í•œ <b>í”¼ë¡œë„(0~99)</b>ë¥¼ ê°€ì§‘ë‹ˆë‹¤.
                <br><br>
                <b style="color:#e74c3c;">ğŸ’¦ ê¸‰ê°ì† (ë¹„í‹€ê±°ë¦¼)</b><br>
                í”¼ë¡œë„ê°€ ë†’ì„ìˆ˜ë¡ ë‹¬ë¦¬ëŠ” ë„ì¤‘ ì§€ì³ì„œ <b>1~2ì´ˆê°„</b> ì†ë„ê°€ ëš ë–¨ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                <br><br>
                <b style="color:#c0392b;">ğŸš‘ ë¶€ìƒ (ê²½ê¸° í¬ê¸°)</b><br>
                í”¼ë¡œë„ê°€ <b>30 ì´ìƒ</b>ì¸ ë§ì€ ê²½ê¸° ë„ì¤‘ ë¶€ìƒì„ ì…ê³  <b>ì¦‰ì‹œ íƒˆë½(ì‹¤ê²©)</b>í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!
            </div>
            <p style="font-size:16px; font-weight:bold; margin-bottom:5px; margin-top:15px; color:#27ae60;">3. ëŠ¥ë ¥ì¹˜ ì„¤ëª…</p>
            <ul style="padding-left:20px; margin-top:0; color:#555; font-size:13px;">
                <li><b>ğŸš€ ìŠ¤í”¼ë“œ:</b> ê¸°ë³¸ ì£¼í–‰ ì†ë„ì…ë‹ˆë‹¤.</li>
                <li><b>â¤ï¸ ìŠ¤íƒœë¯¸ë„ˆ:</b> í›„ë°˜ê¹Œì§€ ì†ë„ë¥¼ ìœ ì§€í•˜ëŠ” í˜ì…ë‹ˆë‹¤.</li>
                <li><b>ğŸ€ í–‰ìš´:</b> ìŠ¤í¼íŠ¸ë‚˜ ë³€ìˆ˜ê°€ ë°œìƒí•  í™•ë¥ ì…ë‹ˆë‹¤.</li>
            </ul>
            <button class="btn btn-back" style="width:100%; margin-top:20px; background:#333;" onclick="toggleHelp()">ì´í•´í–ˆìŠµë‹ˆë‹¤!</button>
        </div>
    </div>

    <div id="result-modal" class="modal">
        <div class="result-paper" onclick="event.stopPropagation()">
            <div class="result-header">ğŸ† ê²½ê¸° ê²°ê³¼ ë°œí‘œ ğŸ†</div>
            <div id="result-msg" class="result-msg"></div>
            <div class="result-section-title">ğŸ“Š ìµœì¢… ìˆœìœ„</div>
            <table class="rank-table">
                <thead><tr><th>ìˆœìœ„</th><th>ë§ˆëª… (ë“±ê¸‰)</th><th>ê¸°ë¡/ìƒíƒœ</th></tr></thead>
                <tbody id="rank-tbody"></tbody>
            </table>
            <div class="result-section-title">ğŸ™ï¸ ì¤‘ê³„ ë‹¤ì‹œë³´ê¸°</div>
            <div id="race-log-box" class="log-box"></div>
            <button class="btn btn-start" style="width:100%; margin-top:15px;" onclick="location.reload()">ë‹¤ìŒ ê²½ê¸° ì¤€ë¹„ (ìƒˆë¡œê³ ì¹¨)</button>
        </div>
    </div>

    <script type="module">
        // [ëª¨ë‹¬ ì•ˆì „ì¥ì¹˜: ëª¨ë°”ì¼ ë·° ê¹¨ì§ ë°©ì§€]
        const moveModalToBody = (id) => {
            const el = document.getElementById(id);
            if(el && el.parentElement !== document.body) { document.body.appendChild(el); }
        };
        moveModalToBody('tip-modal');
        moveModalToBody('help-modal');
        moveModalToBody('result-modal');

        // [Firebase ë¼ì´ë¸ŒëŸ¬ë¦¬]
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, increment } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // [ì´ë¦„ ë°ì´í„°]
        const ADJECTIVES = [
            "ì¬ë˜¥", "ê²½í™˜", "ì¬ì€", "ê°±ê°±", "ì˜¤ë¹ ", "ì„¤ì‚¬", 
            "ë°”ëŒ", "ì²œë‘¥", "í™©ê¸ˆ", "ë¶ˆê½ƒ", "ë¬´ì ", "ë‚ ìŒ˜", "ê±°ëŒ€", "ë¯¸ì¹œ", "í–‰ìš´", "í­í’", 
            "ê°•ì² ", "ì‹ ë¹„", "ì–¼ìŒ", "ì–´ë‘ ", "ë¹›ì˜", "í‘¸ë¥¸", "ë¶‰ì€", "í•˜ì–€", "ê²€ì€", "ìŠˆí¼", 
            "ëŒ€ì™•", "í‚¹ê°“", "ì „ì„¤", "ì§€ì˜¥", "ì²œì‚¬", "ì•…ë§ˆ", "ê·¸ë¦¼ì", "ìš°ì£¼", "ì°¨ì›", "ë§ˆë²•",
            "ë°©êµ¬", "ë˜¥", "ì½”", "í•µ", "ì‚¬ë‘", "ê·€ì—¼", "ê¹œì°", "ëª»ë‚œ", "ì—‰ë©", "ë±ƒì‚´", 
            "íƒˆëª¨", "ë°œëƒ„ìƒˆ", "ê²¨í„¸", "ì½§ë¬¼", "ì¹¨ì§ˆì§ˆ", "ì™•ë°œ", "ìˆë‹¤ë¦¬", "ë¡±ë‹¤ë¦¬", "ë°°ê³ í”ˆ", "ì¡¸ë¦°",
            "ë¯¸ëŒ", "ëˆì ", "ë¬¼ë ", "ë”±ë”±", "íë¬¼", "ì­ˆê¸€", "íƒ±íƒ±", "ì„¹ì‹œ", "ë„ë§", "ì—­ì „"
        ];
        const NOUNS = [
            "ì¿µì•¼", "ëŒì§€", 
            "ê²½í™˜", "ì¬ì€", "ê°±ê°±", "ì˜¤ë¹ ", "ì„¤ì‚¬", 
            "ëŒì´", "ìˆœì´", "í† ë§ˆ", "ëŒ€ì¥", "ê¸°ì‚¬", "ìš”ì •", "ë§ì¹˜", "ì£¼ë¨¹", "ë‹¤ë¦¬", "ë‚ ê°œ", 
            "ë°œí†±", "ì´ë¹¨", "ê¼¬ë¦¬", "í˜¸ë‘", "ì‚¬ì", "í† ë¼", "ê±°ë¶", "ë…ìˆ˜ë¦¬", "ìƒì–´", "ê³ ë˜", 
            "ë“œë˜ê³¤", "í”¼ë‹‰ìŠ¤", "íƒ€ì´íƒ„", "ìŠ¬ë¼ì„", "ì˜¤í¬", "ì—˜í”„", "íˆì–´ë¡œ", "ë§ˆì™•", "ì‹ ", "êµ°ì£¼",
            "ì¹˜í‚¨", "í”¼ì", "ë²„ê±°", "êµ­ë°¥", "ë¼ë©´", "ê³µì£¼", "ì™•ì", "ê±°ì§€", "ë…¸ë¹„", "ë°”ë³´",
            "ì²œì¬", "ë³€íƒœ", "ì•„ì¬", "í• ë°°", "ì´ˆë”©", "ê´€ì¢…", "ë°±ìˆ˜", "ì‚¬ì¥", "ì•Œë°”", "ëª¨ê¸°",
            "íŒŒë¦¬", "ë°”í€´", "ì§€ë ì´", "ë©”ëšœê¸°", "ë°©êµ¬", "ì½§ë¬¼", "ë¹„ë“¬", "ê°ì§ˆ", "ì—¬ë“œë¦„", "ì¹˜ì§ˆ"
        ];
        const TIERS = ['F', 'D', 'C', 'B', 'A', 'S'];
        const COMMENT_DB = {
            highTier: ["ìš°ìŠ¹ì´ ë‹¹ì—°ì‹œë¨.", "ì»¨ë””ì…˜ ì ˆì •.", "ì•ˆì •ì ì¸ ì£¼í–‰.", "ê¸°ìˆ˜ì™€ì˜ í˜¸í¡ í™˜ìƒ.", "ì§€ë‚œ ëŒ€íšŒ ìš°ìŠ¹ë§ˆ."],
            midTier: ["ì…ìƒ ê°€ëŠ¥ì„± ì¶©ë¶„.", "ê¸°ë³µì´ ìˆìœ¼ë‚˜ í•´ë³¼ ë§Œí•¨.", "ì¤‘ìœ„ê¶Œ ì‹¸ì›€ì˜ í•µì‹¬.", "ì´ˆë°˜ ìŠ¤íƒ€íŠ¸ê°€ ê´€ê±´.", "ëˆˆì—¬ê²¨ë³¼ ë³µë³‘."],
            lowTier: ["ì ì¬ë ¥ ìˆìŒ.", "ìƒˆë²½ í›ˆë ¨ ì‹œ ê´´ë ¥ ë°œíœ˜!", "ìˆ˜ìƒí•˜ë‹¤.", "ì‚¬ê³  ì¹  ê´€ìƒ.", "ë°°ë‹¹íŒì˜ í•µí­íƒ„.", "ì¸ìƒ ì—­ì „ì˜ ê¸°íšŒ."]
        };

        const firebaseConfig = {
          apiKey: "AIzaSyDTMfB6Fl6QiiJdcTjpcU9nha2GP4Ne_6o",
          authDomain: "lovechatproject-2db11.firebaseapp.com",
          projectId: "lovechatproject-2db11",
          storageBucket: "lovechatproject-2db11.firebasestorage.app",
          messagingSenderId: "1069136590072",
          appId: "1:1069136590072:web:7712e718db03c70bff370d",
          measurementId: "G-ERG2LL283F"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let myId = localStorage.getItem('chat_uid');
        const userRef = doc(db, "users", myId);

        let horses = [];
        let myBalance = 0;
        let isRacing = false;
        let raceInterval = null;
        let raceLogs = [];
        const FINISH_DIST = 86; 

        function initGame() {
            raceLogs = [];
            getDoc(userRef).then(snap => {
                if(snap.exists()) {
                    myBalance = snap.data().coins;
                    updateBalanceUI();
                }
            });

            horses = [];
            let totalPower = 0;
            const horseListEl = document.getElementById('horse-list');
            horseListEl.innerHTML = "";

            for(let i=0; i<5; i++) {
                // [ì´ë¦„ ìƒì„± ë¡œì§]
                let adj = ADJECTIVES[Math.floor(Math.random() * ADJECTIVES.length)];
                let noun = NOUNS[Math.floor(Math.random() * NOUNS.length)];
                let name = adj + noun;
                if(horses.some(h => h.name === name)) name += "ì£¼ë‹ˆì–´";

                let tierIdx = Math.floor(Math.random() * TIERS.length); 
                let tier = TIERS[tierIdx];
                let multiplier = 0.7 + (tierIdx * 0.1); 

                let baseSpd = Math.floor(Math.random() * 50) + 30; 
                let baseSta = Math.floor(Math.random() * 60) + 40; 
                let baseLuk = Math.floor(Math.random() * 90) + 10; 
                
                // â–¼â–¼â–¼ [ëˆ„ë½ë˜ì—ˆë˜ spd, sta, luk ë³€ìˆ˜ ì •ì˜ ë³µêµ¬] â–¼â–¼â–¼
                let spd = Math.floor(baseSpd * multiplier);
                let sta = Math.floor(baseSta * multiplier);
                let luk = baseLuk; 
                // â–²â–²â–²

                // [í”¼ë¡œë„ ìƒì„±: 0~99 ëœë¤]
                let baseFatigue = Math.floor(Math.random() * 100); 
                
                // ì´ì œ spdê°€ ì •ì˜ë˜ì—ˆìœ¼ë¯€ë¡œ ì—ëŸ¬ê°€ ë‚˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                let power = (spd * 2.5) + (sta * 1.5) + (luk * 0.5);
                totalPower += power;

                let records = [];
                for(let k=0; k<3; k++) {
                    let r = 0;
                    if(tier === 'S' || tier === 'A') r = Math.floor(Math.random() * 3) + 1;
                    else if(tier === 'F' || tier === 'D') r = Math.floor(Math.random() * 5) + 4;
                    else r = Math.floor(Math.random() * 6) + 2;
                    records.push(r + "ì°©");
                }
                let recordStr = records.join("-");

                horses.push({ 
                    id: i, name, tier, spd, sta, luk, power, 
                    pos: 0, curSta: sta, odds: 0, bet: 0, lastSpurt: false,
                    recordStr: recordStr, 
                    fatigue: baseFatigue, isInjured: false,
                    stumbleTimer: 0 // ìƒíƒœì´ìƒ íƒ€ì´ë¨¸
                });

                const lane = document.getElementById(`lane-${i}`);
                const tagClass = tier === 'S' ? 'tag-S' : (tier === 'F' ? 'tag-F' : (tier === 'A' ? 'tag-A' : ''));
                lane.innerHTML = `<div class="horse" id="horse-icon-${i}">ğŸ<div class="horse-name-tag ${tagClass}">${name}</div></div>`;
            }

            // ë°°ë‹¹ë¥  ê³„ì‚°
            let tempOddsList = [];
            let inverseOddsSum = 0; 
            horses.forEach(h => {
                let winRate = h.power / totalPower;
                let tierBonus = {'F': 5.0, 'D': 3.5, 'C': 2.5, 'B': 1.5, 'A': 1.2, 'S': 1.0};
                let rawOdds = (1 / winRate) * tierBonus[h.tier];
                tempOddsList.push(rawOdds);
                inverseOddsSum += (1 / rawOdds);
            });
            const TARGET_OVERROUND = 1.15; 
            let scaleFactor = inverseOddsSum / TARGET_OVERROUND; 

            horses.forEach((h, idx) => {
                let adjustedOdds = tempOddsList[idx] * scaleFactor;
                if (adjustedOdds < 1.1) adjustedOdds = 1.1;
                if (adjustedOdds > 300) adjustedOdds = 300; 
                h.odds = adjustedOdds.toFixed(1);

                const card = document.createElement('div');
                card.className = 'horse-card';
                let fatigueColor = h.fatigue >= 30 ? '#e74c3c' : '#2ecc71'; 
                
                card.innerHTML = `
                    <div class="card-top">
                        <div class="h-info">
                            <div class="h-name"><span class="tier-badge tier-${h.tier}">${h.tier}</span>${h.name}</div>
                            <div class="h-stats">
                                ğŸš€${h.spd} â¤ï¸${h.sta} ğŸ€${h.luk}
                                <span style="color:${fatigueColor}; font-weight:bold; margin-left:3px;">ğŸ˜«${h.fatigue}</span>
                            </div>
                        </div>
                        <div class="h-odds">x${h.odds}</div>
                    </div>
                    <div class="card-bottom">
                        <div class="bet-btn-group">
                            <button class="bet-btn" onclick="addBet(${h.id}, 100)">+100</button>
                            <button class="bet-btn" onclick="addBet(${h.id}, 1000)">+1ì²œ</button>
                            <button class="bet-btn" onclick="addBet(${h.id}, 10000)">+1ë§Œ</button>
                            <button class="bet-btn btn-allin" onclick="addBet(${h.id}, 'ALL')">ì˜¬ì¸</button>
                        </div>
                        <input type="number" id="input-${h.id}" class="bet-input" placeholder="0" oninput="updateBet(${h.id}, this.value)">
                    </div>`;
                horseListEl.appendChild(card);
            });

            updateTipSheetUI();
        }

        // [ìŠ¤ë§ˆíŠ¸ ì˜ˆìƒì§€ ë¡œì§]
        function updateTipSheetUI() {
            const tbody = document.getElementById('tip-list-body');
            tbody.innerHTML = "";
            
            horses.forEach(h => {
                let comments = [];
                if (h.fatigue >= 40) comments.push("ë‹¤ë¦¬ê°€ ë¬´ê±°ì›Œ ë³´ì„.", "ìµœê·¼ í›ˆë ¨ ê°•ë„ê°€ ë†’ì•˜ìŒ.", "í”¼ë¡œ ëˆ„ì ì´ ë³€ìˆ˜.", "í›„ë°˜ì— í¼ì§ˆ ìœ„í—˜ ìˆìŒ.");
                else if (h.fatigue <= 10) comments.push("ëª¸ë†€ë¦¼ì´ ë§¤ìš° ê°€ë²¼ì›€!", "ìµœìƒì˜ ì»¨ë””ì…˜ ìœ ì§€.", "ìƒˆë²½ ì¡°êµ ìƒíƒœ ìµœìƒ.", "ì˜¤ëŠ˜ ì‚¬ê³  ì¹  ê¸°ì„¸.");
                if (h.spd >= 80) comments.push("ì´ì•Œ ê°™ì€ ìŠ¤íƒ€íŠ¸ ëŠ¥ë ¥.", "ì´ˆë°˜ ì„ ë‘ ì¥ì•… ìœ ë ¥.", "ë‹¨ê±°ë¦¬ ì£¼íŒŒ ëŠ¥ë ¥ íƒì›”.");
                else if (h.sta >= 80) comments.push("ì§€ì¹˜ì§€ ì•ŠëŠ” ì‹¬ì¥.", "ë§‰íŒ ì—­ì „ê·¹ì˜ ì£¼ì¸ê³µ.", "í›„ë°˜ ìŠ¤í¼íŠ¸ê°€ ê´€ê±´.");
                else if (h.luk >= 80) comments.push("ìŠ¹ë¦¬ì˜ ì—¬ì‹ ì´ í•¨ê»˜í•¨.", "ì „ê°œ ìš´ì´ ë”°ë¥¼ ë“¯.", "ì•Œ ìˆ˜ ì—†ëŠ” í˜ì´ ëŠê»´ì§.");
                if (comments.length === 0) {
                    if(h.tier === 'S' || h.tier === 'A') comments = COMMENT_DB.highTier;
                    else if(h.tier === 'F' || h.tier === 'D') comments = COMMENT_DB.lowTier;
                    else comments = COMMENT_DB.midTier;
                }
                h.analyzedComment = comments[Math.floor(Math.random() * comments.length)];
            });

            let recommendHorse = null;
            let recommendReason = "";
            let dice = Math.random();

            if (dice < 0.6) { 
                let bestHorses = [...horses].sort((a,b) => (a.power - a.fatigue * 1.5) - (b.power - b.fatigue * 1.5));
                recommendHorse = bestHorses[bestHorses.length-1];
                recommendReason = "â˜… ì˜¤ëŠ˜ì˜ ê°•ë ¥ ì¶”ì²œ â˜…";
            } else if (dice < 0.9) {
                let darkHorses = horses.filter(h => h.tier !== 'S' && h.tier !== 'A' && h.fatigue < 20);
                if (darkHorses.length > 0) {
                    darkHorses.sort((a,b) => b.luk - a.luk);
                    recommendHorse = darkHorses[0];
                    recommendReason = "âš¡ ê¸°ìê°€ ëª°ë˜ í”½í•œ ë³µë³‘ âš¡";
                } else {
                    recommendHorse = horses.reduce((p, c) => (p.power > c.power ? p : c));
                    recommendReason = "â˜… ì˜¤ëŠ˜ì˜ ê°•ë ¥ ì¶”ì²œ â˜…";
                }
            } else {
                let riskyHorses = [...horses].sort((a,b) => a.power - b.power); 
                recommendHorse = riskyHorses[0]; 
                recommendReason = "ğŸ’£ ì¸ìƒ ì—­ì „ ë…¸ë¦¼ìˆ˜ ğŸ’£";
            }

            document.getElementById('recommend-horse').innerHTML = 
                `<div style="font-size:12px; margin-bottom:5px; color:#555;">${recommendReason}</div>
                 <span style="font-size:16px; font-weight:bold;">${recommendHorse.name}</span> 
                 <span style="font-size:14px; color:#c0392b;">(x${recommendHorse.odds})</span>`;

            horses.forEach(h => {
                const tr = document.createElement('tr');
                let highlightClass = (h.id === recommendHorse.id) ? 'tip-highlight' : '';
                let commentStyle = h.fatigue >= 40 ? "color:#e74c3c; font-weight:bold;" : "";
                if(h.id === recommendHorse.id) commentStyle = "color:#c0392b; font-weight:bold; background:rgba(255,0,0,0.1);";

                tr.innerHTML = `
                    <td><span class="tier-badge tier-${h.tier}">${h.tier}</span><br><b>${h.name}</b></td>
                    <td style="font-size:11px; color:#555;">${h.recordStr}</td>
                    <td style="${commentStyle}; font-size:13px;">${h.analyzedComment}</td>`;
                tbody.appendChild(tr);
            });
        }

        window.addBet = (id, amount) => {
            if(isRacing) return;
            let currentBet = horses[id].bet;
            let currentTotalBet = horses.reduce((sum, h) => sum + h.bet, 0);
            let remainingMoney = myBalance - currentTotalBet;
            let addAmount = (amount === 'ALL') ? remainingMoney : Math.min(amount, remainingMoney);
            if (addAmount <= 0 && amount !== 'ALL') return; 

            let newBet = currentBet + addAmount;
            document.getElementById(`input-${id}`).value = newBet > 0 ? newBet : '';
            updateBet(id, newBet); 
        };

        window.updateBet = (id, amount) => {
            if(isRacing) return;
            amount = parseInt(amount);
            if(isNaN(amount) || amount < 0) amount = 0;
            horses[id].bet = amount;

            let total = horses.reduce((sum, h) => sum + h.bet, 0);
            document.getElementById('total-bet').innerText = total.toLocaleString();

            const btn = document.getElementById('btn-start');
            if(total > 0) {
                btn.disabled = false; 
                if (total > myBalance) {
                    btn.innerText = "ì”ì•¡ ë¶€ì¡±! (ì¶©ì „ í•„ìš”)";
                    btn.style.background = "#e74c3c"; btn.style.animation = "pulse 1s infinite";
                } else {
                    btn.innerText = `ê²½ê¸° ì‹œì‘! (-${total.toLocaleString()})`;
                    btn.style.background = "#27ae60"; btn.style.animation = "none";
                }
            } else {
                btn.disabled = true;
                btn.innerText = "ë°°íŒ…í•˜ì„¸ìš”";
                btn.style.background = "#ccc"; btn.style.animation = "none";
            }
        };

        window.resetAllBets = () => {
            if(isRacing) return; 
            horses.forEach(h => {
                h.bet = 0;
                const inputEl = document.getElementById(`input-${h.id}`);
                if(inputEl) inputEl.value = '';
            });
            const btn = document.getElementById('btn-start');
            btn.disabled = true; btn.innerText = "ë°°íŒ…í•˜ì„¸ìš”"; btn.style.background = "#ccc";
            document.getElementById('total-bet').innerText = "0";
        };

        function updateBalanceUI() {
            document.getElementById('wallet-bal').innerText = myBalance.toLocaleString();
        }

        window.startRace = async () => {
            let totalBet = horses.reduce((sum, h) => sum + h.bet, 0);
            if(totalBet === 0) return;
            if(totalBet > myBalance) return alert("ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
            if(!confirm(`ì´ ${totalBet.toLocaleString()} ì½”ì¸ì„ ê±¸ê³  ì‹œì‘í• ê¹Œìš”?`)) return;

            myBalance -= totalBet;
            await updateDoc(userRef, { coins: myBalance });
            updateBalanceUI();

            isRacing = true;
            document.getElementById('betting-panel').style.pointerEvents = "none";
            document.getElementById('betting-panel').style.opacity = "0.6";
            
            showCaster("ğŸ ì¶œë°œí–ˆìŠµë‹ˆë‹¤!!!!", 2000);
            raceInterval = setInterval(gameLoop, 100);
        };

        function gameLoop() {
            let leader = null;
            let maxPos = 0;
            let isFinished = false;

            horses.forEach(h => {
                const horseIcon = document.getElementById(`horse-icon-${h.id}`);
                
                if(h.isInjured) return; 
                if(h.pos >= FINISH_DIST) { isFinished = true; return; }

                let baseSpeed = h.spd * 0.01; 
                let condition = Math.random(); 
                if(h.tier === 'F' || h.tier === 'D') { if(Math.random() < 0.15) condition *= 2.5; else condition *= 0.6; }

                let move = baseSpeed * (0.8 + condition); 
                let burnRate = 0.15 + (h.spd * 0.003); 
                h.curSta -= burnRate;

                if (h.curSta < 20) move *= 0.7;
                if (h.curSta <= 0) { move *= 0.4; h.curSta = 0; }

                if(Math.random() < 0.015 && (Math.random() * 100 < h.luk)) {
                    move += 5.0; showCaster(`ğŸ”¥ ${h.name}, ë¯¸ì¹œë“¯í•œ ì§ˆì£¼!!!`, 800);
                }

                if(h.pos > 70 && h.pos < 82 && !h.lastSpurt) {
                    if(h.curSta > 10 && Math.random() > 0.4) {
                        h.lastSpurt = true; move += 4.5; showCaster(`âš¡ ${h.name}, ë§ˆì§€ë§‰ ìŠ¤í¼íŠ¸!`, 1000);
                    }
                }

                // [í”¼ë¡œë„ ë¡œì§: ë¶€ìƒ ë° ê¸‰ê°ì†(íƒ€ì´ë¨¸ ì ìš©)]
                // 1. ë¶€ìƒ ì²´í¬
                if (h.fatigue >= 30 && Math.random() < (h.fatigue * 0.00001)) {
                    h.isInjured = true;
                    showCaster(`ğŸš‘ ${h.name}, ë¶€ìƒ ë°œìƒ! ê²½ê¸° í¬ê¸°!`, 2500);
                    horseIcon.style.filter = "grayscale(100%) blur(1px)";
                    horseIcon.innerHTML = "ğŸ¥"; 
                    return; 
                }

                // 2. ê¸‰ê°ì† (ë¹„í‹€ê±°ë¦¼) - ì§€ì†í˜•
                if (h.stumbleTimer > 0) {
                    h.stumbleTimer--; // íƒ€ì´ë¨¸ ê°ì†Œ
                    move *= 0.2; // ì†ë„ ëŒ€í­ ê°ì†Œ
                    horseIcon.classList.add('stumbling'); // ì‹œê° íš¨ê³¼
                } else {
                    // í™•ë¥  ì²´í¬ (0.0005)
                    if (Math.random() < (h.fatigue * 0.0005)) {
                        h.stumbleTimer = Math.floor(Math.random() * 10) + 10; // 1~2ì´ˆ ì§€ì†
                        showCaster(`ğŸ’¦ ${h.name}, ì§€ì³¤ë‚˜ìš”? ê¸‰ê²©íˆ ëŠë ¤ì§‘ë‹ˆë‹¤!`, 1000);
                    } else {
                        horseIcon.classList.remove('stumbling');
                    }
                }

                h.pos += move;
                horseIcon.style.left = Math.min(h.pos, FINISH_DIST) + '%';
                if(h.pos > maxPos) { maxPos = h.pos; leader = h; horseIcon.style.zIndex = 100; }
            });

            if(Math.random() < 0.02 && leader) {
                const comments = [`í˜„ì¬ ì„ ë‘ ${leader.name}!`, `${leader.name} ë¹ ë¦…ë‹ˆë‹¤!`, `ë’¤ìª½ ë§ë“¤ì´ ë¬´ì„­ê²Œ ì«“ì•„ì˜µë‹ˆë‹¤!`, `ì•„ì§ ê²°ê³¼ëŠ” ëª¨ë¦…ë‹ˆë‹¤!!`, `ê°€ìì•„ì•„ì•„!!!`];
                showCaster(comments[Math.floor(Math.random() * comments.length)], 1000);
            }
            if (isFinished) finishRace();
        }

        let casterTimer = null;
        function showCaster(msg, duration = 2000) {
            const el = document.getElementById('caster-msg');
            el.innerText = msg; el.style.display = 'block';
            if(casterTimer) clearTimeout(casterTimer);
            casterTimer = setTimeout(() => { el.style.display = 'none'; }, duration);
            if(raceLogs.length === 0 || raceLogs[raceLogs.length-1] !== msg) {
                raceLogs.push(msg);
            }
        }

        async function finishRace() {
            clearInterval(raceInterval);
            isRacing = false;
            
            horses.sort((a, b) => b.pos - a.pos);
            const winner = horses[0];
            showCaster(`ğŸ‰ ê²½ê¸° ì¢…ë£Œ! ìš°ìŠ¹ë§ˆëŠ” [${winner.name}] ì…ë‹ˆë‹¤!`, 5000);

            let winningMoney = 0;
            let resultText = "";
            if (winner.bet > 0) {
                winningMoney = Math.floor(winner.bet * winner.odds);
                resultText = `ì¶•í•˜í•©ë‹ˆë‹¤! <span style="color:#c0392b;">${winner.name}</span> ìš°ìŠ¹!<br>
                              ë°°ë‹¹ë¥  <span style="color:#d35400;">x${winner.odds}</span> ì ì¤‘!<br>
                              <span style="font-size:20px; color:#27ae60;">ğŸ’° +${winningMoney.toLocaleString()} íšë“</span>`;
                await updateDoc(userRef, { coins: increment(winningMoney) });
            } else {
                resultText = `ì•„ì‰½ìŠµë‹ˆë‹¤. <span style="color:#c0392b;">${winner.name}</span>(ì´)ê°€ ìš°ìŠ¹í–ˆìŠµë‹ˆë‹¤.<br>
                              (ë°°ë‹¹ë¥ : x${winner.odds})<br><span style="font-size:14px; color:#7f8c8d;">ë‹¤ìŒ ê¸°íšŒì— ëŒ€ë°•ì„ ë…¸ë ¤ë³´ì„¸ìš”!</span>`;
            }

            document.getElementById('result-msg').innerHTML = resultText;
            const rankBody = document.getElementById('rank-tbody');
            rankBody.innerHTML = "";
            horses.forEach((h, index) => {
                const tr = document.createElement('tr');
                if(index === 0) tr.classList.add('rank-1st');
                let rankDisplay = `${index + 1}ìœ„`;
                let statusDisplay = "ì™„ì£¼";
                if(h.isInjured) {
                    tr.classList.add('rank-injured');
                    rankDisplay = "ì‹¤ê²©";
                    statusDisplay = "ğŸš‘ ë¶€ìƒ(DNF)";
                }
                tr.innerHTML = `<td>${rankDisplay}</td><td><span class="tier-badge tier-${h.tier}">${h.tier}</span> ${h.name} ${h.id === winner.id ? 'ğŸ¥‡' : ''}</td><td>${statusDisplay}</td>`;
                rankBody.appendChild(tr);
            });

            const logBox = document.getElementById('race-log-box');
            logBox.innerHTML = raceLogs.map(log => `<div class="log-item">â–ª ${log}</div>`).join('');
            logBox.scrollTop = logBox.scrollHeight;

            setTimeout(() => {
                const modal = document.getElementById('result-modal');
                modal.style.display = 'flex';
            }, 1000);
        }

        window.toggleTip = () => { 
            const modal = document.getElementById('tip-modal'); 
            const raceTrack = document.getElementById('race-track');
            if (modal.style.display === 'none' || modal.style.display === '') {
                modal.style.display = 'flex'; raceTrack.style.display = 'none';
            } else {
                modal.style.display = 'none'; raceTrack.style.display = 'flex';
            }
        };
        window.toggleHelp = () => { 
            const modal = document.getElementById('help-modal'); 
            const raceTrack = document.getElementById('race-track');
            if (modal.style.display === 'none' || modal.style.display === '') {
                modal.style.display = 'flex'; raceTrack.style.display = 'none';
            } else {
                modal.style.display = 'none'; raceTrack.style.display = 'flex';
            }
        };

        initGame();
    </script>
</body>
</html>