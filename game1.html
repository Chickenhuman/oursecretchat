<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì‹¤ì‹œê°„ ì˜¤ëª©</title>
<link rel="apple-touch-icon" href="icon.png">

<link rel="icon" href="icon.png">

<link rel="manifest" href="manifest.json">
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background-color: #fff0f0; margin: 0; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow-y: auto; touch-action: pan-y; }
        
        .main-wrapper { display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 450px; padding: 15px 0; }

        /* ì°¸ê°€ì ì •ë³´ */
        .player-board { display: flex; justify-content: space-between; width: 90%; margin-bottom: 10px; gap: 10px; }
        .player-card { flex: 1; background: white; padding: 10px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; border: 2px solid transparent; opacity: 0.5; transition: 0.3s; }
        .player-card.active { opacity: 1; border-color: #ff6b6b; background: #fff5f5; transform: scale(1.02); }
        .player-card.filled { opacity: 1; } 
        .role-badge { font-size: 11px; color: white; padding: 2px 8px; border-radius: 10px; margin-bottom: 5px; background: #bbb; display: inline-block;}
        .player-card.active .role-badge { background: #ff6b6b; }
        .player-name { font-weight: bold; font-size: 14px; color: #333; }

        /* ì˜¤ëª©íŒ */
        #board-area { position: relative; margin-bottom: 10px; }
        #board-container { background: #eecfa1; padding: 10px; border-radius: 5px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        canvas { background: #eecfa1; cursor: pointer; display: block; }

        /* ì—­í•  ì„ íƒ ì˜¤ë²„ë ˆì´ */
        #role-selection { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.85); z-index: 10; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 15px; border-radius: 5px; backdrop-filter: blur(2px); }
        .select-btn { width: 180px; padding: 15px; border: none; border-radius: 30px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .select-btn:hover { transform: scale(1.05); }
        .btn-black { background: #333; color: white; }
        .btn-white { background: white; color: #333; border: 1px solid #ddd; }
        .btn-disabled { background: #ccc; cursor: not-allowed; color: #666; }

        /* ìƒíƒœ ë©”ì‹œì§€ */
        #game-status { font-size: 16px; font-weight: bold; color: #555; margin-bottom: 10px; height: 20px; text-align: center; }

        /* ë²„íŠ¼ ê·¸ë£¹ & ì•Œë¦¼ ë±ƒì§€ */
        .btn-group { display: flex; gap: 10px; margin-bottom: 15px; width: 90%; justify-content: center; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative; }
        .btn-reset { background: #ff6b6b; color: white; }
        .btn-back { background: white; color: #555; text-decoration: none; display: flex; align-items: center; }
        
        /* ğŸ”´ ì±„íŒ…ë°© ìƒˆ ë©”ì‹œì§€ ì•Œë¦¼ ì  */
        .new-msg-badge { position: absolute; top: -5px; right: -5px; width: 12px; height: 12px; background: red; border-radius: 50%; border: 2px solid white; display: none; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* ğŸ”¥ ì¸ê²Œì„ ë¯¸ë‹ˆ ì±„íŒ… */
        .mini-chat-container { width: 90%; background: white; border-radius: 12px; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; display: flex; flex-direction: column; height: 180px; }
        .chat-title { font-size: 12px; font-weight: bold; color: #888; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 5px; }
        .chat-list { flex: 1; overflow-y: auto; font-size: 13px; display: flex; flex-direction: column; gap: 5px; }
        .chat-item { padding: 4px 8px; border-radius: 8px; max-width: 80%; word-wrap: break-word; }
        .chat-my { align-self: flex-end; background: #ffeb33; color: #333; }
        .chat-other { align-self: flex-start; background: #f0f0f0; color: #333; }
        .chat-system { align-self: center; font-size: 11px; color: #aaa; background: none; }
        .chat-input-area { display: flex; gap: 5px; margin-top: 5px; border-top: 1px solid #eee; padding-top: 5px; }
        #mini-input { flex: 1; border: 1px solid #ddd; border-radius: 15px; padding: 5px 10px; font-size: 13px; }
        #mini-send { background: #333; color: white; border: none; border-radius: 15px; padding: 5px 12px; font-size: 12px; cursor: pointer; }

        /* ì „ì  ê¸°ë¡ */
        .history-container { width: 90%; background: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .history-title { font-size: 14px; font-weight: bold; color: #888; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .history-list { max-height: 100px; overflow-y: auto; font-size: 13px; }
        .history-item { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #f9f9f9; }
        .winner-mark { font-weight: bold; }
        .win-black { color: #333; }
        .win-white { color: #888; }
        .history-time { color: #aaa; font-size: 11px; }

        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; display: flex; justify-content: center; align-items: center; color: white; flex-direction: column; }
    </style>
</head>
<body>

    <div id="loading">ì˜¤ëª©íŒ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

    <div class="main-wrapper">
        <h2>âš« ì‹¤ì‹œê°„ ì˜¤ëª© âšª</h2>

        <div class="player-board">
            <div id="p1-card" class="player-card">
                <span class="role-badge">í‘ëŒ (ì„ ê³µ)</span>
                <div class="player-name" id="p1-name">ì„ íƒ ëŒ€ê¸°...</div>
            </div>
            <div id="p2-card" class="player-card">
                <span class="role-badge">ë°±ëŒ (í›„ê³µ)</span>
                <div class="player-name" id="p2-name">ì„ íƒ ëŒ€ê¸°...</div>
            </div>
        </div>

        <div id="game-status">ì—­í• ì„ ì„ íƒí•´ì£¼ì„¸ìš”!</div>

        <div id="board-area">
            <div id="role-selection">
                <h3>í”Œë ˆì´ í•  ëŒì„ ì„ íƒí•˜ì„¸ìš”</h3>
                <button class="select-btn btn-black" id="btn-select-black" onclick="selectRole('black')">
                    <span style="width:12px;height:12px;background:white;border-radius:50%;"></span> í‘ëŒ ì¡ê¸°
                </button>
                <button class="select-btn btn-white" id="btn-select-white" onclick="selectRole('white')">
                    <span style="width:12px;height:12px;background:black;border-radius:50%;"></span> ë°±ëŒ ì¡ê¸°
                </button>
            </div>
            <div id="board-container">
                <canvas id="omokBoard"></canvas>
            </div>
        </div>

        <div class="btn-group">
            <a href="index.html" class="btn btn-back">
                ğŸ’¬ ì±„íŒ…ë°©
                <span id="new-msg-badge" class="new-msg-badge"></span>
            </a>
            <button class="btn btn-reset" onclick="resetGame()">ğŸ”„ íŒ ì—ê¸° (ì—­í•  ì´ˆê¸°í™”)</button>
        </div>

        <div class="mini-chat-container">
            <div class="chat-title">ğŸ’¬ ê²Œì„ ì±„íŒ…</div>
            <div id="mini-chat-list" class="chat-list"></div>
            <div class="chat-input-area">
                <input type="text" id="mini-input" placeholder="ëŒ€í™”í•˜ê¸°..." onkeypress="if(event.keyCode==13) sendGameMsg()">
                <button id="mini-send" onclick="sendGameMsg()">ì „ì†¡</button>
            </div>
        </div>

        <div class="history-container">
            <div class="history-title">ğŸ“œ ê²½ê¸° ê¸°ë¡</div>
            <div id="history-list" class="history-list">
                <div style="text-align:center; color:#ccc; padding:10px;">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, getDoc, arrayUnion, addDoc, collection, query, orderBy, limit, deleteDoc, getDocs, serverTimestamp } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ğŸ”´ [í•„ìˆ˜] ë³¸ì¸ì˜ firebaseConfigë¡œ êµì²´í•˜ì„¸ìš”!
    const firebaseConfig = {
      apiKey: "AIzaSyDTMfB6Fl6QiiJdcTjpcU9nha2GP4Ne_6o",
      authDomain: "lovechatproject-2db11.firebaseapp.com",
      projectId: "lovechatproject-2db11",
      storageBucket: "lovechatproject-2db11.firebasestorage.app",
      messagingSenderId: "1069136590072",
      appId: "1:1069136590072:web:7712e718db03c70bff370d",
      measurementId: "G-ERG2LL283F"
    };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const gameDocRef = doc(db, "games", "couple_omok");
        // ì¸ê²Œì„ ì±„íŒ…ìš© ì»¬ë ‰ì…˜ (ê²Œì„ ë¬¸ì„œ í•˜ìœ„ê°€ ì•„ë‹Œ ë³„ë„ ì»¬ë ‰ì…˜ìœ¼ë¡œ ê´€ë¦¬)
        const gameChatRef = collection(db, "game_chats");

        let myId = localStorage.getItem('chat_uid');
        let myName = localStorage.getItem('chat_nickname') || "ìµëª…"; 
        if(!myId) { myId = 'user_' + Date.now(); localStorage.setItem('chat_uid', myId); }

        let myColor = 0; 
        let currentTurn = 1; 
        let board = [];
        const size = 15; 
        let boardSize = 300; 
        let cellSize = 20;
        let pageLoadTime = new Date(); // í˜ì´ì§€ ë¡œë“œ ì‹œê°„ (ì•Œë¦¼ìš©)

        const canvas = document.getElementById('omokBoard');
        const ctx = canvas.getContext('2d');

        // 1. ê²Œì„ ì ‘ì†
        async function joinGame() {
            const docSnap = await getDoc(gameDocRef);
            if (!docSnap.exists()) {
                await setDoc(gameDocRef, {
                    board: Array(size * size).fill(0), turn: 1, status: 'waiting',
                    black: "", blackName: "", white: "", whiteName: "", winner: 0, history: []
                });
            }
            document.getElementById('loading').style.display = 'none';
            resizeBoard();
            
            // ë©”ì¸ ì±„íŒ…ë°© ìƒˆ ë©”ì‹œì§€ ê°ì‹œ
            watchMainChat();
            // ì¸ê²Œì„ ì±„íŒ… ê°ì‹œ
            watchGameChat();
        }

        // 2. ì˜¤ëª© ë°ì´í„° ë™ê¸°í™”
        onSnapshot(gameDocRef, (doc) => {
            if (doc.exists()) {
                const data = doc.data();
                board = [];
                for(let i=0; i<size; i++) board.push(data.board.slice(i*size, (i+1)*size));
                currentTurn = data.turn;

                // ë‚´ ìƒ‰ê¹” í™•ì¸
                if (data.black === myId) myColor = 1;
                else if (data.white === myId) myColor = 2;
                else myColor = 0;

                updateUI(data);
                drawBoard();
                drawAllStones();
                renderHistory(data.history || []);
            }
        });

        // 3. UI ì—…ë°ì´íŠ¸
        function updateUI(data) {
            const overlay = document.getElementById('role-selection');
            const p1Card = document.getElementById('p1-card');
            const p2Card = document.getElementById('p2-card');
            const statusDiv = document.getElementById('game-status');
            const btnBlack = document.getElementById('btn-select-black');
            const btnWhite = document.getElementById('btn-select-white');

            document.getElementById('p1-name').innerText = data.blackName || "ì„ íƒ ëŒ€ê¸°...";
            document.getElementById('p2-name').innerText = data.whiteName || "ì„ íƒ ëŒ€ê¸°...";

            p1Card.className = data.black ? "player-card filled" : "player-card";
            p2Card.className = data.white ? "player-card filled" : "player-card";

            // ë²„íŠ¼ ìƒíƒœ (ë‚´ê°€ ì„ íƒí–ˆìœ¼ë©´ í™œì„±, ë‚¨ì´ í–ˆìœ¼ë©´ ë¹„í™œì„±)
            btnBlack.className = (data.black && data.black !== myId) ? "select-btn btn-disabled" : "select-btn btn-black";
            btnBlack.innerHTML = data.black ? (data.black === myId ? "âœ… í‘ëŒ (ë‚˜)" : `${data.blackName}`) : `<span style="width:12px;height:12px;background:white;border-radius:50%;"></span> í‘ëŒ ì¡ê¸°`;
            
            btnWhite.className = (data.white && data.white !== myId) ? "select-btn btn-disabled" : "select-btn btn-white";
            btnWhite.innerHTML = data.white ? (data.white === myId ? "âœ… ë°±ëŒ (ë‚˜)" : `${data.whiteName}`) : `<span style="width:12px;height:12px;background:black;border-radius:50%;"></span> ë°±ëŒ ì¡ê¸°`;

            if (data.black && data.white) {
                overlay.style.display = 'none'; 
                if (data.winner !== 0) {
                    statusDiv.innerText = (data.winner === 1 ? "âš« í‘ëŒ" : "âšª ë°±ëŒ") + " ìŠ¹ë¦¬! ğŸ‰";
                    statusDiv.style.color = "#ff6b6b";
                } else {
                    if (data.turn === 1) {
                        p1Card.classList.add('active'); p2Card.classList.remove('active');
                        statusDiv.innerText = (myColor === 1) ? "ğŸ‘‰ ë‹¹ì‹  ì°¨ë¡€ì…ë‹ˆë‹¤!" : "âš« í‘ëŒ ì°¨ë¡€ì…ë‹ˆë‹¤";
                        statusDiv.style.color = (myColor === 1) ? "#ff6b6b" : "#333";
                    } else {
                        p2Card.classList.add('active'); p1Card.classList.remove('active');
                        statusDiv.innerText = (myColor === 2) ? "ğŸ‘‰ ë‹¹ì‹  ì°¨ë¡€ì…ë‹ˆë‹¤!" : "âšª ë°±ëŒ ì°¨ë¡€ì…ë‹ˆë‹¤";
                        statusDiv.style.color = (myColor === 2) ? "#ff6b6b" : "#333";
                    }
                }
            } else {
                overlay.style.display = 'flex';
                statusDiv.innerText = "ì—­í• ì„ ì„ íƒí•´ì£¼ì„¸ìš”!";
            }
        }

        // 4. [ìˆ˜ì •ë¨] ì—­í•  ì„ íƒ (ìŠ¤ìœ„ì¹­ ê¸°ëŠ¥)
        window.selectRole = async function(role) {
            const docSnap = await getDoc(gameDocRef);
            const data = docSnap.data();
            const updates = {};

            // 1. ë‚´ê°€ ì´ë¯¸ ë‹¤ë¥¸ ì—­í• ì„ ë§¡ê³  ìˆë‹¤ë©´ ê·¸ ìë¦¬ë¥¼ ë¹„ì›€ (ìŠ¤ìœ„ì¹­)
            if (role === 'black' && data.white === myId) { updates.white = ""; updates.whiteName = ""; }
            if (role === 'white' && data.black === myId) { updates.black = ""; updates.blackName = ""; }

            // 2. ìƒˆ ì—­í•  ë°°ì •
            if (role === 'black') {
                if (!data.black || data.black === myId) { updates.black = myId; updates.blackName = myName; }
                else return alert("ì´ë¯¸ í‘ëŒì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
                if (!data.white || data.white === myId) { updates.white = myId; updates.whiteName = myName; }
                else return alert("ì´ë¯¸ ë°±ëŒì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.");
            }

            await updateDoc(gameDocRef, updates);
        };

        // 5. ëŒ ë‘ê¸°
        canvas.addEventListener('mousedown', handleInput);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); handleInput(e); }, { passive: false });

        async function handleInput(e) {
            if (myColor === 0) return; 
            const statusText = document.getElementById('game-status').innerText;
            if (statusText.includes("ìŠ¹ë¦¬") || statusText.includes("ì„ íƒ")) return;
            if (currentTurn !== myColor) { alert("ìƒëŒ€ë°© ì°¨ë¡€ì…ë‹ˆë‹¤."); return; }

            const rect = canvas.getBoundingClientRect();
            let clientX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
            let clientY = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
            const x = Math.round((clientX - rect.left - cellSize) / cellSize);
            const y = Math.round((clientY - rect.top - cellSize) / cellSize);

            if (x >= 0 && x < size && y >= 0 && y < size) {
                if (board[y][x] === 0) await makeMove(x, y);
            }
        }

        async function makeMove(x, y) {
            board[y][x] = myColor;
            const flatBoard = board.flat();
            let winner = 0;
            
            if (checkWin(x, y, myColor)) {
                winner = myColor;
                const winName = myColor === 1 ? document.getElementById('p1-name').innerText : document.getElementById('p2-name').innerText;
                const winColorStr = myColor === 1 ? "í‘ëŒ" : "ë°±ëŒ";
                const today = new Date();
                const dateStr = `${today.getMonth()+1}/${today.getDate()} ${today.getHours()}:${String(today.getMinutes()).padStart(2,'0')}`;
                
                await updateDoc(gameDocRef, {
                    board: flatBoard, turn: myColor === 1 ? 2 : 1, winner: winner,
                    history: arrayUnion({ winnerName: winName, winnerColor: winColorStr, date: dateStr })
                });
            } else {
                await updateDoc(gameDocRef, { board: flatBoard, turn: myColor === 1 ? 2 : 1, winner: winner });
            }
        }

        window.resetGame = async function() {
            if (confirm("íŒì„ ì—ê³  ì—­í• ì„ ë‹¤ì‹œ ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                await updateDoc(gameDocRef, {
                    board: Array(size * size).fill(0), turn: 1, winner: 0,
                    black: "", blackName: "", white: "", whiteName: ""
                });
            }
        };

        // --- ì¸ê²Œì„ ì±„íŒ… ê¸°ëŠ¥ (ìµœëŒ€ 10ê°œ ìœ ì§€) ---
        window.sendGameMsg = async function() {
            const input = document.getElementById('mini-input');
            const text = input.value;
            if(!text.trim()) return;

            // 1. ë©”ì‹œì§€ ì¶”ê°€
            await addDoc(gameChatRef, {
                text: text, sender: myName, timestamp: serverTimestamp()
            });
            input.value = '';

            // 2. 10ê°œ ë„˜ìœ¼ë©´ ì˜¤ë˜ëœ ê²ƒ ì‚­ì œ
            const q = query(gameChatRef, orderBy("timestamp", "asc"));
            const snapshot = await getDocs(q);
            if(snapshot.size > 10) {
                // ê°€ì¥ ì˜¤ë˜ëœ ë¬¸ì„œ ì‚­ì œ
                await deleteDoc(snapshot.docs[0].ref); 
            }
        };

        function watchGameChat() {
            const q = query(gameChatRef, orderBy("timestamp", "asc"));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('mini-chat-list');
                list.innerHTML = "";
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const isMe = data.sender === myName;
                    list.innerHTML += `
                        <div class="chat-item ${isMe ? 'chat-my' : 'chat-other'}">
                            <b>${isMe ? '' : data.sender + ': '}</b>${data.text}
                        </div>`;
                });
                list.scrollTop = list.scrollHeight;
            });
        }

        // --- ë©”ì¸ ì±„íŒ…ë°© ì•Œë¦¼ ê°ì‹œ ---
        function watchMainChat() {
            // ìµœê·¼ 1ê°œ ë©”ì‹œì§€ë§Œ ê°ì‹œ
            const q = query(collection(db, "chats"), orderBy("timestamp", "desc"), limit(1));
            onSnapshot(q, (snapshot) => {
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if(data.timestamp) {
                        const msgTime = data.timestamp.toDate();
                        // í˜ì´ì§€ ë¡œë“œ ì´í›„ì— ì˜¨ ë©”ì‹œì§€ë©´ì„œ + ë‚´ê°€ ë³´ë‚¸ê²Œ ì•„ë‹ˆë©´ ì•Œë¦¼
                        if (msgTime > pageLoadTime && data.sender !== myName) {
                            document.getElementById('new-msg-badge').style.display = 'block';
                        }
                    }
                });
            });
        }

        // --- ë Œë”ë§ í—¬í¼ ---
        function renderHistory(history) {
            const list = document.getElementById('history-list');
            if (history.length === 0) { list.innerHTML = '<div style="text-align:center; color:#ccc; padding:10px;">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
            const reversed = [...history].reverse();
            list.innerHTML = reversed.map(item => `
                <div class="history-item"><span class="winner-mark ${item.winnerColor === 'í‘ëŒ' ? 'win-black' : 'win-white'}">${item.winnerColor === 'í‘ëŒ' ? 'âš«' : 'âšª'} ${item.winnerName} ìŠ¹ë¦¬!</span><span class="history-time">${item.date}</span></div>`).join('');
        }

        function resizeBoard() {
            const screenWidth = Math.min(window.innerWidth - 40, 400);
            boardSize = screenWidth; cellSize = boardSize / (size + 1);
            canvas.width = boardSize; canvas.height = boardSize;
            drawBoard(); drawAllStones();
        }
        function drawBoard() {
            ctx.fillStyle = "#eecfa1"; ctx.fillRect(0, 0, boardSize, boardSize); ctx.strokeStyle = "#555"; ctx.lineWidth = 1;
            for (let i = 0; i < size; i++) {
                ctx.beginPath(); ctx.moveTo(cellSize, (i+1) * cellSize); ctx.lineTo(boardSize - cellSize, (i+1) * cellSize); ctx.stroke();
                ctx.beginPath(); ctx.moveTo((i+1) * cellSize, cellSize); ctx.lineTo((i+1) * cellSize, boardSize - cellSize); ctx.stroke();
            }
            drawDot(3, 3); drawDot(11, 3); drawDot(7, 7); drawDot(3, 11); drawDot(11, 11);
        }
        function drawDot(x, y) { ctx.fillStyle = "#555"; ctx.beginPath(); ctx.arc((x+1) * cellSize, (y+1) * cellSize, 3, 0, Math.PI * 2); ctx.fill(); }
        function drawStone(x, y, color) {
            const cx = (x+1) * cellSize; const cy = (y+1) * cellSize; const r = cellSize * 0.4;
            ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI * 2);
            const grad = ctx.createRadialGradient(cx - r/3, cy - r/3, r/10, cx, cy, r);
            if (color === 1) { grad.addColorStop(0, "#555"); grad.addColorStop(1, "black"); } else { grad.addColorStop(0, "white"); grad.addColorStop(1, "#ddd"); }
            ctx.fillStyle = grad; ctx.fill();
        }
        function drawAllStones() { if(!board || board.length === 0) return; for (let y = 0; y < size; y++) for (let x = 0; x < size; x++) if (board[y][x] !== 0) drawStone(x, y, board[y][x]); }
        function checkWin(x, y, color) {
            const directions = [[1, 0], [0, 1], [1, 1], [1, -1]];
            for (let [dx, dy] of directions) {
                let count = 1;
                for (let i = 1; i < 5; i++) { if (isValid(x + dx * i, y + dy * i) && board[y + dy * i][x + dx * i] === color) count++; else break; }
                for (let i = 1; i < 5; i++) { if (isValid(x - dx * i, y - dy * i) && board[y - dy * i][x - dx * i] === color) count++; else break; }
                if (count >= 5) return true;
            } return false;
        }
        function isValid(x, y) { return x >= 0 && x < size && y >= 0 && y < size; }

        window.addEventListener('resize', resizeBoard);
        joinGame();
    </script>
</body>
</html>