<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Our Calendar</title>
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2076/2076218.png">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/2076/2076218.png">
    <style>
        body { 
            font-family: 'Apple SD Gothic Neo', sans-serif; 
            background-color: #fff0f5; /* íŒŒìŠ¤í…” í•‘í¬ */
            margin: 0; display: flex; justify-content: center; 
            height: 100vh; overflow: hidden; color: #555;
        }
        
        .container { 
            width: 100%; max-width: 450px; background: white; 
            height: 100%; display: flex; flex-direction: column; 
            box-shadow: 0 0 20px rgba(0,0,0,0.1); position: relative;
        }

        /* í—¤ë” */
        .header { 
            padding: 20px; background: #ff6b6b; color: white; 
            font-weight: bold; font-size: 18px; 
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
        }
        .back-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; text-decoration: none; }
        .month-nav { display: flex; align-items: center; gap: 15px; }
        .nav-btn { background: none; border: none; color: white; font-size: 20px; cursor: pointer; }

        /* ë‹¬ë ¥ ê·¸ë¦¬ë“œ */
        .calendar-body { flex: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; }
        .weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-weight: bold; margin-bottom: 10px; color: #888; font-size: 14px; }
        .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        
        /* ë‚ ì§œ ì¹¸ ìŠ¤íƒ€ì¼ */
        .day-cell { 
            aspect-ratio: 1/1.2; background: #f9f9f9; border-radius: 8px; 
            border: 1px solid #eee; cursor: pointer; position: relative;
            display: flex; flex-direction: column; align-items: center; padding-top: 5px;
            transition: 0.2s; overflow: hidden; /* ë‚´ìš© ë„˜ì¹¨ ë°©ì§€ */
        }
        .day-cell:active { background: #ffe0e6; border-color: #ff6b6b; }
        .day-num { font-size: 14px; font-weight: bold; color: #333; margin-bottom: 2px; flex-shrink: 0; }
        .today { background: #fff5f5; border: 1px solid #ff6b6b; }
        .other-month { opacity: 0.3; pointer-events: none; }
        
        /* [ìˆ˜ì •ë¨] ì¼ì • í‘œì‹œ (ë§ì¤„ì„í‘œ ì ìš©) */
        .event-dot { 
            background: #ff6b6b; color: white; font-size: 10px; 
            padding: 2px 4px; border-radius: 4px; margin-top: 2px;
            width: 90%; /* ë„ˆë¹„ ê½‰ ì±„ì›€ */
            text-align: center; 
            
            /* ë§ì¤„ì„í‘œ í•µì‹¬ ì†ì„± */
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis;
            display: block;
        }

        /* íŒì—… (ì¼ì • ì…ë ¥) */
        #event-modal { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); z-index: 100; display: none; 
            justify-content: center; align-items: center; 
        }
        .modal-content { 
            background: white; width: 85%; padding: 25px; border-radius: 20px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.2); text-align: center;
        }
        .modal-date { font-size: 18px; font-weight: bold; color: #ff6b6b; margin-bottom: 15px; display: block; }
        input, textarea { 
            width: 100%; padding: 12px; margin-bottom: 10px; 
            border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; 
            font-family: inherit; font-size: 14px;
        }
        textarea { height: 100px; resize: none; }
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 14px; }
        .btn-save { background: #ff6b6b; color: white; }
        .btn-cancel { background: #eee; color: #555; }
        .btn-delete { background: #333; color: white; margin-top: 10px; width: 100%; }

        /* ë¡œë”© */
        #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #ff6b6b; font-weight: bold; display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <a href="index.html" class="back-btn">â†</a>
        <div class="month-nav">
            <button class="nav-btn" onclick="changeMonth(-1)">â—€</button>
            <span id="month-year">2025. 12</span>
            <button class="nav-btn" onclick="changeMonth(1)">â–¶</button>
        </div>
        <div style="width: 24px;"></div>
    </div>

    <div class="calendar-body">
        <div class="weekdays">
            <span style="color:#ff6b6b">ì¼</span><span>ì›”</span><span>í™”</span><span>ìˆ˜</span><span>ëª©</span><span>ê¸ˆ</span><span style="color:#339af0">í† </span>
        </div>
        <div id="calendar-grid" class="days-grid"></div>
        <div id="loading">ì¼ì • ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>

    <div id="event-modal">
        <div class="modal-content">
            <span id="modal-date-display" class="modal-date"></span>
            <input type="text" id="event-title" placeholder="ì œëª© (ë‹¬ë ¥ì— í‘œì‹œë¨)" maxlength="15">
            <textarea id="event-desc" placeholder="ìƒì„¸ ë‚´ìš©ì„ ì ì–´ë³´ì„¸ìš”."></textarea>
            
            <div class="btn-group">
                <button class="btn btn-cancel" onclick="closeModal()">ì·¨ì†Œ</button>
                <button class="btn btn-save" onclick="saveEvent()">ì €ì¥</button>
            </div>
            <button class="btn btn-delete" onclick="deleteEvent()">ì¼ì • ì‚­ì œ</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc, onSnapshot, query, where } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ğŸ”´ [í•„ìˆ˜] ë³¸ì¸ì˜ firebaseConfigë¡œ ê¼­ êµì²´í•˜ì„¸ìš”!
    const firebaseConfig = {
      apiKey: "AIzaSyDTMfB6Fl6QiiJdcTjpcU9nha2GP4Ne_6o",
      authDomain: "lovechatproject-2db11.firebaseapp.com",
      projectId: "lovechatproject-2db11",
      storageBucket: "lovechatproject-2db11.firebasestorage.app",
      messagingSenderId: "1069136590072",
      appId: "1:1069136590072:web:7712e718db03c70bff370d",
      measurementId: "G-ERG2LL283F"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    let currentDate = new Date();
    let selectedDateStr = "";
    let eventsCache = {}; 

    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth(); 

        document.getElementById('month-year').innerText = `${year}. ${String(month + 1).padStart(2, '0')}`;

        const firstDay = new Date(year, month, 1).getDay(); 
        const lastDate = new Date(year, month + 1, 0).getDate(); 
        const prevLastDate = new Date(year, month, 0).getDate(); 

        const grid = document.getElementById('calendar-grid');
        grid.innerHTML = "";

        for (let i = firstDay; i > 0; i--) {
            grid.innerHTML += `<div class="day-cell other-month"><div class="day-num">${prevLastDate - i + 1}</div></div>`;
        }

        const todayStr = new Date().toISOString().split('T')[0];
        for (let i = 1; i <= lastDate; i++) {
            const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
            const isToday = dateKey === todayStr ? 'today' : '';
            
            let eventHtml = '';
            if (eventsCache[dateKey]) {
                // [ìˆ˜ì •ë¨] 2ê¸€ì ìë¥´ê¸° ì‚­ì œ -> ì „ì²´ ì œëª© ì‚¬ìš© (CSSê°€ ... ì²˜ë¦¬)
                const fullTitle = eventsCache[dateKey].title;
                eventHtml = `<div class="event-dot">${fullTitle}</div>`;
            }

            grid.innerHTML += `
                <div class="day-cell ${isToday}" onclick="openModal('${dateKey}')">
                    <div class="day-num" style="color:${getDayColor(year, month, i)}">${i}</div>
                    ${eventHtml}
                </div>`;
        }
    }

    function getDayColor(year, month, day) {
        const dayOfWeek = new Date(year, month, day).getDay();
        if (dayOfWeek === 0) return '#ff6b6b'; 
        if (dayOfWeek === 6) return '#339af0'; 
        return '#333';
    }

    window.changeMonth = (delta) => {
        currentDate.setMonth(currentDate.getMonth() + delta);
        loadEvents(); 
    };

    function loadEvents() {
        document.getElementById('loading').style.display = 'block';
        // ì „ì²´ ì´ë²¤íŠ¸ë¥¼ ì‹¤ì‹œê°„ êµ¬ë… (ë°ì´í„° ì–‘ì´ ë§ì§€ ì•Šìœ¼ë¯€ë¡œ íš¨ìœ¨ì )
        const colRef = collection(db, "calendar_events");
        onSnapshot(colRef, (snapshot) => {
            eventsCache = {}; 
            snapshot.forEach(doc => {
                eventsCache[doc.id] = doc.data();
            });
            renderCalendar();
            document.getElementById('loading').style.display = 'none';
        });
    }

    window.openModal = (dateStr) => {
        selectedDateStr = dateStr;
        document.getElementById('modal-date-display').innerText = dateStr;
        document.getElementById('event-modal').style.display = 'flex';
        
        if (eventsCache[dateStr]) {
            document.getElementById('event-title').value = eventsCache[dateStr].title;
            document.getElementById('event-desc').value = eventsCache[dateStr].desc;
        } else {
            document.getElementById('event-title').value = "";
            document.getElementById('event-desc').value = "";
        }
    };

    window.closeModal = () => {
        document.getElementById('event-modal').style.display = 'none';
    };

    window.saveEvent = async () => {
        const title = document.getElementById('event-title').value;
        const desc = document.getElementById('event-desc').value;

        if (!title.trim()) return alert("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");

        try {
            await setDoc(doc(db, "calendar_events", selectedDateStr), {
                title: title,
                desc: desc,
                updatedAt: new Date()
            });
            closeModal();
        } catch(e) {
            alert("ì €ì¥ ì‹¤íŒ¨: " + e.message);
        }
    };

    window.deleteEvent = async () => {
        if(!confirm("ì´ ë‚ ì§œì˜ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?")) return;
        try {
            await deleteDoc(doc(db, "calendar_events", selectedDateStr));
            closeModal();
        } catch(e) {
            alert("ì‚­ì œ ì‹¤íŒ¨");
        }
    };

    loadEvents();

</script>
</body>
</html>