<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Our Calendar</title>
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2076/2076218.png">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/2076/2076218.png">
    <style>
        body { 
            font-family: 'Apple SD Gothic Neo', sans-serif; 
            background-color: #fff0f5; /* íŒŒìŠ¤í…” í•‘í¬ */
            margin: 0; display: flex; justify-content: center; 
            height: 100vh; overflow: hidden; color: #555;
        }
        
        .container { 
            width: 100%; max-width: 450px; background: white; 
            height: 100%; display: flex; flex-direction: column; 
            box-shadow: 0 0 20px rgba(0,0,0,0.1); position: relative;
        }

        /* í—¤ë” */
        .header { 
            padding: 20px; background: #ff6b6b; color: white; 
            font-weight: bold; font-size: 18px; 
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
        }
        .back-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; text-decoration: none; }
        .month-nav { display: flex; align-items: center; gap: 15px; }
        .nav-btn { background: none; border: none; color: white; font-size: 20px; cursor: pointer; }

        /* ë‹¬ë ¥ ê·¸ë¦¬ë“œ */
        .calendar-body { flex: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; }
        .weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-weight: bold; margin-bottom: 10px; color: #888; font-size: 14px; }
        .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        
        /* ë‚ ì§œ ì¹¸ ìŠ¤íƒ€ì¼ */
        .day-cell { 
            aspect-ratio: 1/1.2; background: #f9f9f9; border-radius: 8px; 
            border: 1px solid #eee; cursor: pointer; position: relative;
            display: flex; flex-direction: column; align-items: center; padding-top: 5px;
            transition: 0.2s; overflow: hidden; /* ë‚´ìš© ë„˜ì¹¨ ë°©ì§€ */
        }
        .day-cell:active { background: #ffe0e6; border-color: #ff6b6b; }
        .day-num { font-size: 14px; font-weight: bold; color: #333; margin-bottom: 2px; flex-shrink: 0; }
        .today { background: #fff5f5; border: 1px solid #ff6b6b; }
        .other-month { opacity: 0.3; pointer-events: none; }
        
        /* ì¼ì • í‘œì‹œ (ë§ì¤„ì„í‘œ ì ìš©) */
        .event-dot { 
            background: #ff6b6b; color: white; font-size: 10px; 
            padding: 2px 4px; border-radius: 4px; margin-top: 2px;
            width: 90%; text-align: center; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            display: block;
        }
        /* ì•Œë¦¼ ì„¤ì •ëœ ì¼ì •ì€ ì•„ì´ì½˜ í‘œì‹œ */
        .event-dot.notified::before { content: "ğŸ”” "; font-size: 8px; }

        /* íŒì—… (ì¼ì • ì…ë ¥) */
        #event-modal { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); z-index: 100; display: none; 
            justify-content: center; align-items: center; 
        }
        .modal-content { 
            background: white; width: 85%; padding: 25px; border-radius: 20px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.2); text-align: center;
        }
        .modal-date { font-size: 18px; font-weight: bold; color: #ff6b6b; margin-bottom: 15px; display: block; }
        input, textarea { 
            width: 100%; padding: 12px; margin-bottom: 10px; 
            border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; 
            font-family: inherit; font-size: 14px;
        }
        textarea { height: 100px; resize: none; }
        
        /* ìŠ¤ìœ„ì¹˜ ìŠ¤íƒ€ì¼ (ì•Œë¦¼ ì„¤ì •) */
        .switch-container { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; background: #f9f9f9; padding: 10px; border-radius: 10px; }
        .switch-label { font-size: 14px; color: #555; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #ff6b6b; }
        input:checked + .slider:before { transform: translateX(18px); }

        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 14px; }
        .btn-save { background: #ff6b6b; color: white; }
        .btn-cancel { background: #eee; color: #555; }
        .btn-delete { background: #333; color: white; margin-top: 10px; width: 100%; }

        #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #ff6b6b; font-weight: bold; display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <a href="index.html" class="back-btn">â†</a>
        <div class="month-nav">
            <button class="nav-btn" onclick="changeMonth(-1)">â—€</button>
            <span id="month-year">2025. 12</span>
            <button class="nav-btn" onclick="changeMonth(1)">â–¶</button>
        </div>
        <div style="width: 24px;"></div>
    </div>

    <div class="calendar-body">
        <div class="weekdays">
            <span style="color:#ff6b6b">ì¼</span><span>ì›”</span><span>í™”</span><span>ìˆ˜</span><span>ëª©</span><span>ê¸ˆ</span><span style="color:#339af0">í† </span>
        </div>
        <div id="calendar-grid" class="days-grid"></div>
        <div id="loading">ì¼ì • ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>

    <div id="event-modal">
        <div class="modal-content">
            <span id="modal-date-display" class="modal-date"></span>
            <input type="text" id="event-title" placeholder="ì œëª© (ë‹¬ë ¥ì— í‘œì‹œë¨)" maxlength="15">
            <textarea id="event-desc" placeholder="ìƒì„¸ ë‚´ìš©ì„ ì ì–´ë³´ì„¸ìš”."></textarea>
            
            <div class="switch-container">
                <span class="switch-label">ğŸ”” ì•Œë¦¼ ë°›ê¸°</span>
                <label class="switch">
                    <input type="checkbox" id="event-notify">
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-cancel" onclick="closeModal()">ì·¨ì†Œ</button>
                <button class="btn btn-save" onclick="saveEvent()">ì €ì¥</button>
            </div>
            <button class="btn btn-delete" onclick="deleteEvent()">ì¼ì • ì‚­ì œ</button>
        </div>
    </div>
</div>

<script type="module">
 import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc, onSnapshot, query, where } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
// ğŸ‘‡ [ì¶”ê°€] ì¸ì¦ ëª¨ë“ˆ ê°€ì ¸ì˜¤ê¸°
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // ğŸ”´ [í•„ìˆ˜] ë³¸ì¸ì˜ firebaseConfigë¡œ êµì²´í•˜ì„¸ìš”!
    const firebaseConfig = {
      apiKey: "AIzaSyDTMfB6Fl6QiiJdcTjpcU9nha2GP4Ne_6o",
      authDomain: "lovechatproject-2db11.firebaseapp.com",
      projectId: "lovechatproject-2db11",
      storageBucket: "lovechatproject-2db11.firebasestorage.app",
      messagingSenderId: "1069136590072",
      appId: "1:1069136590072:web:7712e718db03c70bff370d",
      measurementId: "G-ERG2LL283F"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let currentDate = new Date();
    let selectedDateStr = "";
    let eventsCache = {}; 


	// ğŸ‘‡ [ì¶”ê°€] ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ í›„ ìº˜ë¦°ë” ë¡œë”©
    onAuthStateChanged(auth, (user) => {
        if (user) {
            console.log("ìº˜ë¦°ë” ì ‘ì† ì„±ê³µ!");
            loadEvents(); // ë¡œê·¸ì¸ì´ í™•ì¸ë˜ë©´ ê·¸ë•Œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜´
        } else {
            // ë¡œê·¸ì¸ì´ ì•ˆ ë˜ì–´ ìˆë‹¤ë©´ ìµëª… ë¡œê·¸ì¸ ì‹œë„
            signInAnonymously(auth).catch((error) => {
                console.error("ì ‘ì† ì‹¤íŒ¨:", error);
            });
        }
    });

    // [ì•Œë¦¼ ê¸°ëŠ¥] ê¶Œí•œ ìš”ì²­
    function requestNotiPermission() {
        if ("Notification" in window && Notification.permission !== "granted") {
            Notification.requestPermission();
        }
    }

    // 1. ë‹¬ë ¥ ê·¸ë¦¬ê¸° í•¨ìˆ˜
    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth(); 

        document.getElementById('month-year').innerText = `${year}. ${String(month + 1).padStart(2, '0')}`;

        const firstDay = new Date(year, month, 1).getDay(); 
        const lastDate = new Date(year, month + 1, 0).getDate(); 
        const prevLastDate = new Date(year, month, 0).getDate(); 

        const grid = document.getElementById('calendar-grid');
        grid.innerHTML = "";

        for (let i = firstDay; i > 0; i--) {
            grid.innerHTML += `<div class="day-cell other-month"><div class="day-num">${prevLastDate - i + 1}</div></div>`;
        }

        const todayStr = new Date().toISOString().split('T')[0];
        for (let i = 1; i <= lastDate; i++) {
            const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
            const isToday = dateKey === todayStr ? 'today' : '';
            
            let eventHtml = '';
            if (eventsCache[dateKey]) {
                const fullTitle = eventsCache[dateKey].title;
                const notiClass = eventsCache[dateKey].notify ? 'notified' : '';
                eventHtml = `<div class="event-dot ${notiClass}">${fullTitle}</div>`;
            }

            grid.innerHTML += `
                <div class="day-cell ${isToday}" onclick="openModal('${dateKey}')">
                    <div class="day-num" style="color:${getDayColor(year, month, i)}">${i}</div>
                    ${eventHtml}
                </div>`;
        }
    }

    function getDayColor(year, month, day) {
        const dayOfWeek = new Date(year, month, day).getDay();
        if (dayOfWeek === 0) return '#ff6b6b'; 
        if (dayOfWeek === 6) return '#339af0'; 
        return '#333';
    }

    window.changeMonth = (delta) => {
        currentDate.setMonth(currentDate.getMonth() + delta);
        loadEvents(); 
    };

    function loadEvents() {
        document.getElementById('loading').style.display = 'block';
        const colRef = collection(db, "calendar_events");
        onSnapshot(colRef, (snapshot) => {
            eventsCache = {}; 
            snapshot.forEach(doc => {
                eventsCache[doc.id] = doc.data();
            });
            renderCalendar();
            checkDailyNotifications(); // ë°ì´í„° ë¡œë“œë  ë•Œ ì•Œë¦¼ ì²´í¬
            document.getElementById('loading').style.display = 'none';
        });
    }

    // [í•µì‹¬] ì˜¤ëŠ˜/ë‚´ì¼ ì¼ì • ì²´í¬í•´ì„œ ì•Œë¦¼ ë³´ë‚´ê¸°
    function checkDailyNotifications() {
        if (Notification.permission !== "granted") return;

        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);

        const todayStr = today.toISOString().split('T')[0];
        const tomorrowStr = tomorrow.toISOString().split('T')[0];

        // ì˜¤ëŠ˜ ì¼ì • ì•Œë¦¼
        if (eventsCache[todayStr] && eventsCache[todayStr].notify) {
            // ì´ë¯¸ ì•Œë¦¼ ë³´ëƒˆëŠ”ì§€ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ë¡œ ì²´í¬ (ì¤‘ë³µ ë°©ì§€)
            const logKey = `noti_${todayStr}`;
            if (!localStorage.getItem(logKey)) {
                new Notification(`ğŸ“… ì˜¤ëŠ˜ ì¼ì •: ${eventsCache[todayStr].title}`, {
                    body: eventsCache[todayStr].desc || "ìŠì§€ ë§ˆì„¸ìš”!",
                    icon: 'https://cdn-icons-png.flaticon.com/512/2076/2076218.png'
                });
                localStorage.setItem(logKey, "sent");
            }
        }

        // ë‚´ì¼ ì¼ì • ì•Œë¦¼ (ë¯¸ë¦¬ ì•Œë¦¼)
        if (eventsCache[tomorrowStr] && eventsCache[tomorrowStr].notify) {
            const logKey = `noti_pre_${tomorrowStr}`;
            if (!localStorage.getItem(logKey)) {
                new Notification(`ğŸ”” ë‚´ì¼ ì¼ì •: ${eventsCache[tomorrowStr].title}`, {
                    body: "ë‚´ì¼ ì¼ì •ì´ ìˆìŠµë‹ˆë‹¤. ì¤€ë¹„í•´ì£¼ì„¸ìš”!",
                    icon: 'https://cdn-icons-png.flaticon.com/512/2076/2076218.png'
                });
                localStorage.setItem(logKey, "sent");
            }
        }
    }

    window.openModal = (dateStr) => {
        selectedDateStr = dateStr;
        document.getElementById('modal-date-display').innerText = dateStr;
        document.getElementById('event-modal').style.display = 'flex';
        
        if (eventsCache[dateStr]) {
            document.getElementById('event-title').value = eventsCache[dateStr].title;
            document.getElementById('event-desc').value = eventsCache[dateStr].desc;
            document.getElementById('event-notify').checked = eventsCache[dateStr].notify || false;
        } else {
            document.getElementById('event-title').value = "";
            document.getElementById('event-desc').value = "";
            document.getElementById('event-notify').checked = false;
        }
    };

    window.closeModal = () => {
        document.getElementById('event-modal').style.display = 'none';
    };

    window.saveEvent = async () => {
        const title = document.getElementById('event-title').value;
        const desc = document.getElementById('event-desc').value;
        const notify = document.getElementById('event-notify').checked;

        if (!title.trim()) return alert("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");

        // ì•Œë¦¼ ì¼  ê²½ìš° ê¶Œí•œ ìš”ì²­
        if (notify) requestNotiPermission();

        try {
            await setDoc(doc(db, "calendar_events", selectedDateStr), {
                title: title,
                desc: desc,
                notify: notify, // ì•Œë¦¼ ì—¬ë¶€ ì €ì¥
                updatedAt: new Date()
            });
            closeModal();
        } catch(e) {
            alert("ì €ì¥ ì‹¤íŒ¨: " + e.message);
        }
    };

    window.deleteEvent = async () => {
        if(!confirm("ì´ ë‚ ì§œì˜ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?")) return;
        try {
            await deleteDoc(doc(db, "calendar_events", selectedDateStr));
            closeModal();
        } catch(e) {
            alert("ì‚­ì œ ì‹¤íŒ¨");
        }
    };

    requestNotiPermission(); // ì ‘ì† ì‹œ ê¶Œí•œ ìš”ì²­

</script>
</body>
</html>