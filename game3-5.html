<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Stable</title>
    <link rel="apple-touch-icon" href="icon.png">
    <style>
        body { 
            font-family: 'Apple SD Gothic Neo', sans-serif; 
            background-color: #1e272e; color: white; margin: 0; 
            display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }

        /* í—¤ë” */
        .header { 
            padding: 15px; background: #2f3640; display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 10;
        }
        .title { font-weight: bold; font-size: 18px; display: flex; align-items: center; gap: 5px; }
        .coin-box { background: #000; padding: 5px 12px; border-radius: 20px; color: #f1c40f; font-weight: bold; font-size: 14px; border: 1px solid #444; }

        /* ë©”ì¸ ì»¨í…ì¸  (ìŠ¤í¬ë¡¤ ê°€ëŠ¥) */
        .content { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; padding-bottom: 80px; }

        /* 1. ë§ ìƒíƒœì°½ */
        .horse-card {
            background: linear-gradient(135deg, #353b48, #2f3640);
            border-radius: 15px; padding: 20px; border: 2px solid #444;
            display: flex; flex-direction: column; align-items: center; text-align: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3); position: relative;
        }
        .horse-avatar { font-size: 80px; margin-bottom: 10px; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5)); transition: 0.3s; }
        .horse-avatar.training { animation: bounce 0.5s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        .horse-info h2 { margin: 0; font-size: 24px; color: #f5f6fa; }
        .horse-grade { 
            background: #e74c3c; color: white; padding: 2px 8px; border-radius: 5px; 
            font-size: 12px; font-weight: bold; vertical-align: middle; margin-left: 5px; 
        }

        /* ìŠ¤íƒ¯ ë°” */
        .stat-grid { width: 100%; margin-top: 20px; display: grid; grid-template-columns: 1fr; gap: 8px; }
        .stat-row { display: flex; align-items: center; gap: 10px; font-size: 14px; }
        .stat-label { width: 50px; font-weight: bold; color: #aaa; }
        .bar-bg { flex: 1; height: 10px; background: #111; border-radius: 5px; overflow: hidden; position: relative; }
        .bar-fill { height: 100%; border-radius: 5px; transition: width 0.5s; }
        .stat-val { width: 40px; text-align: right; font-weight: bold; }

        /* í”¼ë¡œë„ (íŠ¹ë³„ ì·¨ê¸‰) */
        .fatigue-box { 
            width: 100%; background: #111; border-radius: 10px; padding: 10px; margin-top: 15px; 
            display: flex; align-items: center; justify-content: space-between; box-sizing: border-box;
            border: 1px solid #444;
        }
        .fatigue-text { font-size: 12px; color: #aaa; }
        .fatigue-val { font-weight: bold; color: #e74c3c; }

        /* 2. ì¥ë¹„ ìŠ¬ë¡¯ */
        .equip-section { display: flex; gap: 10px; justify-content: center; }
        .equip-slot { 
            width: 60px; height: 60px; background: #222; border: 2px dashed #555; border-radius: 10px; 
            display: flex; justify-content: center; align-items: center; font-size: 24px; color: #555;
            position: relative;
        }
        .equip-slot.equipped { border: 2px solid #f1c40f; background: #2c2c2c; color: #fff; }
        .equip-badge { position: absolute; bottom: -5px; right: -5px; font-size: 10px; background: #c0392b; color: white; padding: 2px 4px; border-radius: 4px; }

        /* 3. í–‰ë™ ë²„íŠ¼ ê·¸ë¦¬ë“œ */
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .act-btn {
            background: #34495e; border: none; border-radius: 10px; padding: 15px; 
            color: white; text-align: left; cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; gap: 5px; border-bottom: 4px solid #2c3e50;
        }
        .act-btn:active { transform: translateY(4px); border-bottom: 0; margin-bottom: 4px; }
        .act-btn h3 { margin: 0; font-size: 16px; }
        .act-btn p { margin: 0; font-size: 11px; color: #bdc3c7; }
        .act-cost { font-size: 12px; color: #f1c40f; font-weight: bold; }

        /* íƒ­ ë²„íŠ¼ */
        .tab-menu { display: flex; gap: 5px; margin-bottom: 10px; }
        .tab-btn { flex: 1; padding: 10px; background: #222; border: none; color: #777; font-weight: bold; cursor: pointer; border-radius: 5px; }
        .tab-btn.active { background: #f1c40f; color: #000; }

        /* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; background: #222; 
            display: flex; border-top: 1px solid #444; z-index: 20;
        }
        .nav-btn { flex: 1; padding: 15px; background: none; border: none; color: #aaa; font-weight: bold; cursor: pointer; }
        .nav-btn.back { background: #c0392b; color: white; }

        /* ëª¨ë‹¬ (ë¶„ì–‘, ê°€ì±  ê²°ê³¼ ë“±) */
        .modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); z-index: 100; display: none; 
            justify-content: center; align-items: center; 
        }
        .modal-box { 
            background: #fff; color: #333; width: 85%; max-width: 350px; padding: 25px; 
            border-radius: 15px; text-align: center; box-shadow: 0 0 20px rgba(255,255,255,0.1);
        }
        .btn-main { background: #2ecc71; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 15px; width: 100%; }

        /* [ì¶”ê°€] ì…ë ¥ì°½ ë° ì´ë¦„ ë³€ê²½ ìŠ¤íƒ€ì¼ */
        .name-input {
            width: 80%; padding: 10px; font-size: 16px; 
            border: 2px solid #ddd; border-radius: 8px; 
            text-align: center; margin-bottom: 10px; font-weight: bold;
        }
        .btn-edit {
            background: none; border: none; cursor: pointer; 
            font-size: 16px; margin-left: 5px; opacity: 0.7; transition: 0.2s;
        }
        .btn-edit:hover { opacity: 1; transform: scale(1.2); }
        
        .btn-sub { 
            background: #95a5a6; color: white; border: none; 
            padding: 10px 20px; border-radius: 8px; font-weight: bold; 
            cursor: pointer; margin-top: 10px; width: 100%; 
        }

    </style>
</head>
<body>

    <div class="header">
        <div class="title">ğŸ›– ë‚´ ë§ˆêµ¬ê°„</div>
        <div class="coin-box" id="my-coin">0 ğŸ’°</div>
    </div>

    <div id="loading-screen" class="content" style="align-items:center; justify-content:center;">
        <h2>ë§ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h2>
    </div>

    <div id="main-screen" class="content" style="display:none;">
        
        <div class="horse-card">
            <div id="h-avatar" class="horse-avatar">ğŸ</div>
            <div class="horse-info">
                <div style="display:flex; align-items:center; justify-content:center; gap:5px;">
                    <h2 id="h-name">ì´ë¦„ì—†ìŒ</h2>
                    <button class="btn-edit" onclick="openRenameModal()">âœï¸</button>
                </div>

                <div style="margin-top:5px;">
                    <span id="h-grade" class="horse-grade">Fê¸‰</span>
                    <span style="font-size:12px; color:#aaa; margin-left:5px;">(ì¹œë°€ë„ <span id="h-bond">0</span>)</span>
                </div>
            </div>

            <div class="stat-grid">
                <div class="stat-row">
                    <span class="stat-label">SPD</span>
                    <div class="bar-bg"><div id="bar-spd" class="bar-fill" style="width:0%; background:#e67e22;"></div></div>
                    <span id="val-spd" class="stat-val">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">STA</span>
                    <div class="bar-bg"><div id="bar-sta" class="bar-fill" style="width:0%; background:#27ae60;"></div></div>
                    <span id="val-sta" class="stat-val">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">LUK</span>
                    <div class="bar-bg"><div id="bar-luk" class="bar-fill" style="width:0%; background:#9b59b6;"></div></div>
                    <span id="val-luk" class="stat-val">0</span>
                </div>
            </div>

            <div class="fatigue-box">
                <span class="fatigue-text">í”¼ë¡œë„ (100ë˜ë©´ ì…ì›ğŸ¥)</span>
                <span id="h-fatigue" class="fatigue-val">0 / 100</span>
            </div>
        </div>

        <div style="text-align:center; margin-bottom:-10px; font-size:14px; font-weight:bold; color:#aaa;">ì¥ì°© ì¥ë¹„</div>
        <div class="equip-section">
            <div id="slot-0" class="equip-slot">ğŸ‘Ÿ</div> <div id="slot-1" class="equip-slot">ğŸ’º</div> <div id="slot-2" class="equip-slot">ğŸ­</div> </div>

        <div>
            <div class="tab-menu">
                <button class="tab-btn active" onclick="switchTab('feed')">ğŸ¥• ë¨¹ì´</button>
                <button class="tab-btn" onclick="switchTab('train')">ğŸ‹ï¸ í›ˆë ¨</button>
                <button class="tab-btn" onclick="switchTab('shop')">ğŸ ë½‘ê¸°</button>
            </div>

            <div id="tab-feed" class="action-grid"></div>

            <div id="tab-train" class="action-grid" style="display:none;"></div>

            <div id="tab-shop" class="action-grid" style="display:none; grid-template-columns:1fr;">
                <button class="act-btn" style="border-color:#9b59b6; background:#8e44ad;" onclick="drawGacha()">
                    <h3>ğŸ ì¥ë¹„ ë½‘ê¸° (ëœë¤)</h3>
                    <p>C ~ SSë“±ê¸‰ ì¥ë¹„ íšë“ (ê¸°ì¡´ ì¥ë¹„ íŒŒê´´ë¨)</p>
                    <span class="act-cost">50,000 ì½”ì¸</span>
                </button>
                <div style="font-size:12px; color:#aaa; padding:10px;">
                    * SSê¸‰(1%) / Sê¸‰(4%) / Aê¸‰(10%) / Bê¸‰(25%) / Cê¸‰(60%)<br>
                    * ì¥ë¹„ëŠ” ìŠ¤íƒ¯ì„ ì˜êµ¬ì ìœ¼ë¡œ ì˜¬ë ¤ì¤ë‹ˆë‹¤.
                </div>
            </div>
        </div>
    </div>

    <div class="nav-bar">
        <button class="nav-btn back" onclick="location.href='game3.html'">ë‚˜ê°€ê¸°</button>
        <button class="nav-btn" onclick="location.reload()">ìƒˆë¡œê³ ì¹¨</button>
    </div>

    <div id="adopt-modal" class="modal">
        <div class="modal-box">
            <h2>ğŸ´ ë§ˆêµ¬ê°„ì´ ë¹„ì—ˆìŠµë‹ˆë‹¤</h2>
            <p>ë‚˜ë§Œì˜ ê²½ì£¼ë§ˆë¥¼ ë¶„ì–‘ë°›ìœ¼ì„¸ìš”!<br>(ì´ˆê¸° ì´ë¦„ ì„¤ì •)</p>
            
            <input type="text" id="input-first-name" class="name-input" placeholder="ì´ë¦„ (ìµœëŒ€ 10ì)" maxlength="10">

            <div style="margin:20px 0; font-size:50px;">ğŸ“¦</div>
            <button class="btn-main" onclick="createFirstHorse()">ë¶„ì–‘ë°›ê¸°</button>
        </div>
    </div>

    <div id="rename-modal" class="modal">
        <div class="modal-box">
            <h2>âœï¸ ì´ë¦„ ë³€ê²½</h2>
            <p>ìƒˆë¡œìš´ ì´ë¦„ì„ ì§€ì–´ì£¼ì„¸ìš”.</p>
            <input type="text" id="input-rename" class="name-input" placeholder="ìƒˆ ì´ë¦„ (ìµœëŒ€ 10ì)" maxlength="10">
            <button class="btn-main" onclick="confirmRename()">ë³€ê²½í•˜ê¸°</button>
            <button class="btn-sub" onclick="document.getElementById('rename-modal').style.display='none'">ì·¨ì†Œ</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, increment } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        import { FOODS, TRAININGS, GACHA_PRICE, EQUIPMENT_TIERS, ADJECTIVES, NOUNS } from "./js/items.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDTMfB6Fl6QiiJdcTjpcU9nha2GP4Ne_6o",
          authDomain: "lovechatproject-2db11.firebaseapp.com",
          projectId: "lovechatproject-2db11",
          storageBucket: "lovechatproject-2db11.firebasestorage.app",
          messagingSenderId: "1069136590072",
          appId: "1:1069136590072:web:7712e718db03c70bff370d",
          measurementId: "G-ERG2LL283F"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let myId = localStorage.getItem('chat_uid');
        const userRef = doc(db, "users", myId);

        let myData = null;
        let myHorse = null;

        // 1. ì´ˆê¸°í™”
        async function init() {
            const snap = await getDoc(userRef);
            if(!snap.exists()) { alert("ë¡œê·¸ì¸ ì •ë³´ ì—†ìŒ"); location.href='game3.html'; return; }

            myData = snap.data();
            updateCoinUI();

            if(myData.horse) {
                myHorse = myData.horse;
                renderMainScreen();
            } else {
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('adopt-modal').style.display = 'flex';
            }
        }

        function updateCoinUI() {
            document.getElementById('my-coin').innerText = (myData.coins || 0).toLocaleString() + " ğŸ’°";
        }

        window.switchTab = (tabName) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.action-grid').forEach(d => d.style.display = 'none');
            
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).style.display = (tabName === 'shop' ? 'grid' : 'grid');
        };

        function renderMainScreen() {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('main-screen').style.display = 'flex';

            document.getElementById('h-name').innerText = myHorse.name;
            document.getElementById('h-grade').innerText = myHorse.grade || 'Fê¸‰';
            document.getElementById('h-bond').innerText = myHorse.bond || 0;
            
            const spdP = Math.min(100, (myHorse.spd / 200) * 100);
            const staP = Math.min(100, (myHorse.sta / 200) * 100);
            const lukP = Math.min(100, (myHorse.luk / 200) * 100);

            document.getElementById('bar-spd').style.width = spdP + '%';
            document.getElementById('val-spd').innerText = myHorse.spd;
            document.getElementById('bar-sta').style.width = staP + '%';
            document.getElementById('val-sta').innerText = myHorse.sta;
            document.getElementById('bar-luk').style.width = lukP + '%';
            document.getElementById('val-luk').innerText = myHorse.luk;

            const fatigue = myHorse.fatigue || 0;
            const fEl = document.getElementById('h-fatigue');
            fEl.innerText = `${fatigue} / 100`;
            fEl.style.color = fatigue > 80 ? 'red' : (fatigue > 50 ? 'orange' : '#2ecc71');

            const gears = myHorse.equip || [null, null, null];
            const slots = ['ğŸ‘Ÿ','ğŸ’º','ğŸ­'];
            gears.forEach((g, idx) => {
                const el = document.getElementById(`slot-${idx}`);
                if(g) {
                    el.classList.add('equipped');
                    el.innerHTML = `${slots[idx]}<div class="equip-badge" style="background:${g.color}">${g.grade}</div>`;
                } else {
                    el.classList.remove('equipped');
                    el.innerHTML = slots[idx];
                }
            });

            renderActionButtons();
        }

        function renderActionButtons() {
            const feedContainer = document.getElementById('tab-feed');
            feedContainer.innerHTML = "";
            FOODS.forEach(food => {
                feedContainer.innerHTML += `
                    <button class="act-btn" onclick="feedHorse('${food.id}')">
                        <h3>${food.name}</h3>
                        <p>${food.desc}</p>
                        <span class="act-cost">-${food.price.toLocaleString()} ì½”ì¸</span>
                    </button>`;
            });

            const trainContainer = document.getElementById('tab-train');
            trainContainer.innerHTML = "";
            TRAININGS.forEach(tr => {
                trainContainer.innerHTML += `
                    <button class="act-btn" onclick="trainHorse('${tr.id}')">
                        <h3>${tr.name}</h3>
                        <p>${tr.desc}</p>
                        <span class="act-cost">-${tr.cost.toLocaleString()} ì½”ì¸</span>
                    </button>`;
            });
        }

        // --- [ìˆ˜ì •ë¨] 1. ë§ ìƒì„± (ì´ˆê¸° ìŠ¤íƒ¯ í•˜í–¥ & ì´ë¦„ ì…ë ¥) ---
        window.createFirstHorse = async () => {
            const nameInput = document.getElementById('input-first-name');
            const name = nameInput.value.trim();

            if(!name) return alert("ë§ì˜ ì´ë¦„ì„ ì§€ì–´ì£¼ì„¸ìš”!");
            if(name.length > 10) return alert("ì´ë¦„ì€ 10ì ì´ë‚´ì—¬ì•¼ í•©ë‹ˆë‹¤.");

            // ì´ˆê¸° ìŠ¤íƒ¯ ëŒ€í­ í•˜í–¥ (5 ~ 15)
            const baseStat = () => Math.floor(Math.random() * 11) + 5; 

            const newHorse = {
                name: name,
                grade: 'F',
                spd: baseStat(),
                sta: baseStat(),
                luk: baseStat(),
                bond: 0,
                fatigue: 0,
                equip: [null, null, null] 
            };

            await updateDoc(userRef, { horse: newHorse });
            
            document.getElementById('adopt-modal').style.display = 'none';
            alert(`ì¶•í•˜í•©ë‹ˆë‹¤! '${newHorse.name}'(ì´)ê°€ íƒœì–´ë‚¬ìŠµë‹ˆë‹¤!\nì—´ì‹¬íˆ í›ˆë ¨ì‹œì¼œì£¼ì„¸ìš”.`);
            location.reload();
        };

        // --- [ì¶”ê°€ë¨] ì´ë¦„ ë³€ê²½ ê¸°ëŠ¥ ---
        window.openRenameModal = () => {
            document.getElementById('input-rename').value = myHorse.name;
            document.getElementById('rename-modal').style.display = 'flex';
        };

        window.confirmRename = async () => {
            const input = document.getElementById('input-rename');
            const newName = input.value.trim();

            if(!newName) return alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            if(newName.length > 10) return alert("ì´ë¦„ì€ 10ì ì´ë‚´ì—¬ì•¼ í•©ë‹ˆë‹¤.");

            myHorse.name = newName;
            await updateDoc(userRef, { horse: myHorse });

            document.getElementById('h-name').innerText = newName;
            document.getElementById('rename-modal').style.display = 'none';
            alert(`ì´ë¦„ì´ '${newName}'(ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        };

        window.feedHorse = async (foodId) => {
            const item = FOODS.find(f => f.id === foodId);
            if(myData.coins < item.price) return alert("ëˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤!");
            if(myHorse.fatigue <= 0 && item.fatigueRec > 0) return alert("ë§ì´ ì´ë¯¸ ìŒ©ìŒ©í•©ë‹ˆë‹¤!");

            let newFatigue = Math.max(0, (myHorse.fatigue || 0) - item.fatigueRec);
            let newBond = (myHorse.bond || 0) + item.bond;
            let newCoins = myData.coins - item.price;

            myHorse.fatigue = newFatigue;
            myHorse.bond = newBond;
            myData.coins = newCoins;

            await updateDoc(userRef, { coins: newCoins, horse: myHorse });

            alert(`${item.name}ì„(ë¥¼) ë¨¹ì˜€ìŠµë‹ˆë‹¤.\ní”¼ë¡œë„ê°€ íšŒë³µë˜ê³  ì¹œë°€ë„ê°€ ì˜¬ëìŠµë‹ˆë‹¤! â¤ï¸`);
            updateCoinUI();
            renderMainScreen();
        };

        window.trainHorse = async (trainId) => {
            const tr = TRAININGS.find(t => t.id === trainId);
            if(myData.coins < tr.cost) return alert("í›ˆë ¨ë¹„ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!");
            if((myHorse.fatigue || 0) >= 100) return alert("ë§ì´ ë„ˆë¬´ ì§€ì³¤ìŠµë‹ˆë‹¤! ì…ì›í•˜ê¸° ì‹«ìœ¼ë©´ ì‰¬ì„¸ìš”. ğŸ¥");

            const avatar = document.getElementById('h-avatar');
            avatar.classList.add('training');
            setTimeout(() => avatar.classList.remove('training'), 1000);

            const fatiguePenalty = (myHorse.fatigue || 0) / 200; 
            const finalFailRate = tr.fail + fatiguePenalty;
            const isFail = Math.random() < finalFailRate;

            let msg = "";
            let newCoins = myData.coins - tr.cost;
            let newFatigue = Math.min(100, (myHorse.fatigue || 0) + tr.fatigue);

            if(isFail) {
                msg = `ğŸ’¥ í›ˆë ¨ ì‹¤íŒ¨!\në§ì´ ë¶€ìƒì„ ì…ì—ˆìŠµë‹ˆë‹¤.\nìŠ¤íƒ¯ì´ ì˜¤ë¥´ì§€ ì•Šê³  í”¼ë¡œë„ë§Œ ìŒ“ì…ë‹ˆë‹¤.`;
            } else {
                let gain = Math.floor(Math.random() * (tr.max - tr.min + 1)) + tr.min;
                if(myHorse.bond >= 50 && Math.random() < 0.3) {
                    gain += 1; msg = "âœ¨ ëŒ€ì„±ê³µ! (ì£¼ì¸ë‹˜ì„ ìœ„í•´ í˜ëƒˆìŠµë‹ˆë‹¤!)\n";
                }

                if(tr.stat === 'all') {
                    myHorse.spd += gain; myHorse.sta += gain; myHorse.luk += gain;
                    msg += `ëª¨ë“  ëŠ¥ë ¥ì¹˜ê°€ +${gain} ìƒìŠ¹í–ˆìŠµë‹ˆë‹¤!`;
                } else {
                    myHorse[tr.stat] += gain;
                    msg += `${tr.stat.toUpperCase()} +${gain} ìƒìŠ¹í–ˆìŠµë‹ˆë‹¤!`;
                }
            }

            myHorse.fatigue = newFatigue;
            myData.coins = newCoins;

            await updateDoc(userRef, { coins: newCoins, horse: myHorse });
            
            setTimeout(() => {
                alert(msg);
                updateCoinUI();
                renderMainScreen();
            }, 500);
        };

        window.drawGacha = async () => {
            if(myData.coins < GACHA_PRICE) return alert("ëˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤! (5ë§Œ ì½”ì¸ í•„ìš”)");
            if(!confirm("50,000 ì½”ì¸ì„ ì‚¬ìš©í•˜ì—¬ ì¥ë¹„ë¥¼ ë½‘ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê¸°ì¡´ ì¥ë¹„ëŠ” ì‚¬ë¼ì§‘ë‹ˆë‹¤!)")) return;

            const rand = Math.random() * 100; 
            let cumulative = 0;
            let picked = EQUIPMENT_TIERS[0]; 

            for(let t of EQUIPMENT_TIERS) {
                cumulative += t.prob;
                if(rand <= cumulative) { picked = t; break; }
            }

            const slotIdx = Math.floor(Math.random() * 3);
            const slotNames = ["í™©ê¸ˆ í¸ì", "ê°€ì£½ ì•ˆì¥", "í–‰ìš´ì˜ ê°€ë©´"];
            
            const newGear = {
                grade: picked.grade,
                power: picked.power,
                color: picked.color,
                name: `${picked.grade}ê¸‰ ${slotNames[slotIdx]}`
            };

            if(!myHorse.equip) myHorse.equip = [null, null, null];
            myHorse.equip[slotIdx] = newGear;
            
            await updateDoc(userRef, {
                coins: increment(-GACHA_PRICE),
                horse: myHorse
            });

            myData.coins -= GACHA_PRICE;
            updateCoinUI();
            renderMainScreen();

            alert(`[ë½‘ê¸° ê²°ê³¼]\n${newGear.name} íšë“!\në“±ê¸‰: ${picked.grade} (ëŠ¥ë ¥ì¹˜ +${picked.power})`);
        };

        init();
    </script>
</body>
</html>