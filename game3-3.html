<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Casino - High Low (Real Odds)</title>
    <link rel="apple-touch-icon" href="icon.png">
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background-color: #1a1a1a; color: white; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        .header { 
            padding: 15px; background: #2c3e50; 
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.5); z-index: 20; 
        }
        .title-group { display: flex; align-items: center; gap: 8px; }
        .btn-help {
            width: 24px; height: 24px; border-radius: 50%; background: white; color: #333;
            border: none; font-weight: bold; font-size: 14px; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
        }
        .money-box { font-size: 18px; font-weight: bold; color: #f1c40f; }

        .game-area { 
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; 
            background: #27ae60; position: relative; border-bottom: 5px solid #1e8449; 
            overflow: hidden;
        }
        
        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card-zone { display: flex; gap: 20px; align-items: center; z-index: 10; margin-bottom: 20px; transition: 0.3s; }
        .card { 
            width: 120px; height: 180px; background: white; border-radius: 10px; 
            display: flex; flex-direction: column; justify-content: space-between; padding: 10px; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.3); position: relative; 
            font-family: 'Times New Roman', serif; font-weight: bold;
        }
        .card-val-top { font-size: 24px; }
        .card-suit-center { font-size: 60px; align-self: center; }
        .card-val-bot { font-size: 24px; transform: rotate(180deg); }
        
        .card.red { color: #c0392b; }
        .card.black { color: #2c3e50; }
        .card.back { background: repeating-linear-gradient(45deg, #c0392b, #c0392b 10px, #e74c3c 10px, #e74c3c 20px); border: 4px solid white; display: flex; align-items: center; justify-content: center; }
        .card.back::after { content: 'â™ '; font-size: 50px; color: rgba(255,255,255,0.2); }

        .vs-badge { background: rgba(0,0,0,0.5); color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold; font-size: 14px; }

        .message-box { 
            background: rgba(0,0,0,0.6); padding: 10px 20px; 
            border-radius: 20px; font-weight: bold; min-height: 24px; text-align: center;
            z-index: 10;
        }
        .pot-display {
            font-size: 24px; color: #f1c40f; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 10px; display: none;
        }

        /* ì‚¬ìš©ëœ ì¹´ë“œ (íˆìŠ¤í† ë¦¬) */
        .history-zone {
            position: absolute; bottom: 10px; left: 10px; height: 80px; width: 300px;
            pointer-events: none;
        }
        .mini-card {
            width: 50px; height: 75px; background: white; border-radius: 5px;
            position: absolute; bottom: 0; border: 1px solid #ccc;
            display: flex; justify-content: center; align-items: center;
            font-weight: bold; font-size: 14px; box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            transition: 0.3s;
        }

        /* ì»¨íŠ¸ë¡¤ ì˜ì—­ */
        .control-panel { background: #222; padding: 20px; padding-bottom: 30px; border-top: 2px solid #444; position: relative; z-index: 20; }
        
        /* ë°°íŒ… ëª¨ë“œ */
        .bet-mode { display: block; }

        .bet-row { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
        .bet-controls { display: flex; gap: 5px; }
        .bet-btn-small { flex: 1; background: #444; color: white; border: none; padding: 8px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 12px; }
        .bet-btn-allin { flex: 1; background: #c0392b; color: white; border: none; padding: 8px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 12px; }
        
        .bet-input-wrapper { display: flex; align-items: center; justify-content: space-between; background: #333; padding: 0 10px; border-radius: 5px; border: 1px solid #555; }
        .bet-input { background: transparent; border: none; color: white; padding: 10px; font-size: 16px; width: 100px; text-align: right; font-weight: bold; outline: none; }

        .btn-group { display: flex; gap: 10px; height: 60px; margin-bottom: 15px; }
        .btn-choice { flex: 1; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.1s; color: white; position: relative;}
        .btn-choice:disabled { opacity: 0.3; cursor: not-allowed; background: #555; box-shadow: none; transform: none; }
        .btn-choice span { font-size: 14px; color: #eee; font-weight: bold; margin-top: 2px; }
        
        .btn-high { background: #e74c3c; box-shadow: 0 4px 0 #c0392b; }
        .btn-high:active { transform: translateY(4px); box-shadow: none; }
        
        .btn-low { background: #3498db; box-shadow: 0 4px 0 #2980b9; }
        .btn-low:active { transform: translateY(4px); box-shadow: none; }

        .btn-collect { 
            width: 100%; background: #f1c40f; color: #333; border: none; border-radius: 10px; 
            padding: 12px; font-size: 18px; font-weight: bold; margin-bottom: 15px; 
            box-shadow: 0 4px 0 #d35400; cursor: pointer; display: none;
        }
        .btn-collect:active { transform: translateY(4px); box-shadow: none; }

        .bottom-actions { display: flex; gap: 10px; }
        .btn-sub { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; transition: 0.1s; }
        
        .btn-back { background: #7f8c8d; box-shadow: 0 4px 0 #5f6c6d; }
        .btn-back:active { transform: translateY(4px); box-shadow: none; }

        .btn-reset { background: #e67e22; box-shadow: 0 4px 0 #d35400; }
        .btn-reset:active { transform: translateY(4px); box-shadow: none; }

        /* ë„ì›€ë§ ëª¨ë‹¬ */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; display: none; justify-content: center; align-items: center; }
        .modal-content { 
            background: #fff; color: #333; width: 80%; max-width: 350px; padding: 25px; 
            border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); text-align: left;
            border: 1px solid #ddd; position: relative;
        }
        .modal-title { font-size: 20px; font-weight: bold; margin-bottom: 15px; text-align: center; border-bottom: 2px solid #eee; padding-bottom: 10px;}
        .modal-text { font-size: 14px; line-height: 1.6; margin-bottom: 20px; color: #555; }
        .modal-close { background: #333; color: white; width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        .rank-info { display: flex; justify-content: space-around; align-items: center; background: #eee; padding: 10px; border-radius: 8px; margin-bottom: 15px; }
        .rank-item { text-align: center; }
        .rank-card { display: inline-block; width: 30px; height: 45px; background: white; border: 1px solid #ccc; border-radius: 4px; line-height: 45px; font-weight: bold; }

    </style>
</head>
<body>

    <div class="header">
        <div class="title-group">
            <span>ğŸƒ High / Low </span>
            <button class="btn-help" onclick="toggleHelp()">?</button>
        </div>
        <div class="money-box" id="wallet-bal">0</div>
    </div>

    <div class="game-area">
        <div id="pot-display" class="pot-display">Pot: 0</div>
        
        <div class="card-zone">
            <div class="card black" id="current-card">
                <div class="card-val-top">?</div>
                <div class="card-suit-center">?</div>
                <div class="card-val-bot">?</div>
            </div>
            
            <div class="vs-badge">VS</div>

            <div class="card back" id="next-card"></div>
        </div>
        <div class="message-box" id="msg-box">ë°°íŒ… í›„ ì‹œì‘í•˜ì„¸ìš”.</div>

        <div id="history-zone" class="history-zone"></div>
    </div>

    <div class="control-panel">
        <div id="bet-panel" class="bet-mode">
            <div class="bet-row">
                <div class="bet-input-wrapper">
                    <span style="color:#aaa; font-size:14px;">ì‹œì‘ ë°°íŒ…ê¸ˆ</span>
                    <input type="number" id="bet-input" class="bet-input" placeholder="0" value="1000">
                </div>
                <div class="bet-controls">
                    <button class="bet-btn-small" onclick="addBet(1000)">+1ì²œ</button>
                    <button class="bet-btn-small" onclick="addBet(10000)">+1ë§Œ</button>
                    <button class="bet-btn-allin" onclick="addBet('ALL')">ì˜¬ì¸</button>
                </div>
            </div>
        </div>

        <button id="btn-collect" class="btn-collect" onclick="collectWinnings()">
            ğŸ’° 0 íšë“í•˜ê³  íŠ€ê¸° (Stop)
        </button>

        <div class="btn-group">
            <button id="btn-high" class="btn-choice btn-high" onclick="playRound('HIGH')">
                HIGH â–²
                <span id="label-high">(x1.90)</span>
            </button>
            <button id="btn-low" class="btn-choice btn-low" onclick="playRound('LOW')">
                LOW â–¼
                <span id="label-low">(x1.90)</span>
            </button>
        </div>

        <div class="bottom-actions">
            <button class="btn-sub btn-back" onclick="location.href='game3.html'">ë‚˜ê°€ê¸°</button>
            <button id="btn-reset" class="btn-sub btn-reset" onclick="resetBet()">ì´ˆê¸°í™”</button>
        </div>
    </div>

    <div id="help-modal" class="modal" onclick="toggleHelp()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-title">ğŸ“– ê°€ë³€ ë°°ë‹¹ ì‹œìŠ¤í…œ</div>
            <div class="modal-text">
                <b>1. ì‹¤ì‹œê°„ ë°°ë‹¹ë¥  (Odds)</b><br>
                ë‚¨ì€ ì¹´ë“œ ì¤‘ <b>ì´ê¸¸ í™•ë¥ ì´ ë†’ì„ìˆ˜ë¡ ë°°ë‹¹ì€ ë‚®ì•„ì§€ê³ </b>, í™•ë¥ ì´ ë‚®ìœ¼ë©´ <b>ë°°ë‹¹ì´ í­ë°œì ìœ¼ë¡œ ì¦ê°€</b>í•©ë‹ˆë‹¤.<br>
                (ì˜ˆ: í˜„ì¬ ì¹´ë“œê°€ 3ì¼ ë•Œ Lowì— ê±¸ë©´ x10ë°°!)<br><br>
                <b>2. ë¬»ê³  ë”ë¸”ë¡œ ê°€</b><br>
                ìŠ¹ë¦¬ ì‹œ íšë“í•œ ê¸ˆì•¡ì„ ê·¸ëŒ€ë¡œ ë‹¤ìŒ íŒì— ê²ë‹ˆë‹¤. ì—°ìŠ¹í•˜ë©´ ëˆì´ ê¸°í•˜ê¸‰ìˆ˜ì ìœ¼ë¡œ ë¶ˆì–´ë‚©ë‹ˆë‹¤.<br><br>
                <b>3. ë¬´ìŠ¹ë¶€ (Tie)</b><br>
                ìˆ«ìê°€ ê°™ìœ¼ë©´ <b>íŒëˆ ìœ ì§€ (Push)</b>ë¡œ ê³µì§œ ì¬ë„ì „ ê¸°íšŒë¥¼ ì–»ìŠµë‹ˆë‹¤.<br><br>
                <b>4. ì¹´ë“œ ì„œì—´</b><br>
                A(1) < 2...10 < J < Q < K(13)
            </div>
            <button class="modal-close" onclick="toggleHelp()">ì´í•´í–ˆìŠµë‹ˆë‹¤!</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, increment } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDTMfB6Fl6QiiJdcTjpcU9nha2GP4Ne_6o",
          authDomain: "lovechatproject-2db11.firebaseapp.com",
          projectId: "lovechatproject-2db11",
          storageBucket: "lovechatproject-2db11.firebasestorage.app",
          messagingSenderId: "1069136590072",
          appId: "1:1069136590072:web:7712e718db03c70bff370d",
          measurementId: "G-ERG2LL283F"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let myId = localStorage.getItem('chat_uid');
        const userRef = doc(db, "users", myId);

        let myBalance = 0;
        
        // ê²Œì„ ìƒíƒœ ë³€ìˆ˜
        let isStreak = false; 
        let currentPot = 0;   
        let isProcessing = false; 
        
        // ê°€ë³€ ë°°ë‹¹ë¥  ë³€ìˆ˜
        let curOddsHigh = 0;
        let curOddsLow = 0;

        // ì¹´ë“œ ë± ê´€ë ¨
        const SUITS = ['â™ ', 'â™¥', 'â™¦', 'â™£'];
        const RANKS = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
        let deck = [];
        let currentCard = null;

        getDoc(userRef).then(snap => {
            if(snap.exists()) {
                myBalance = snap.data().coins;
                updateUI();
            }
        });

        // ë± ì´ˆê¸°í™”
        function initDeck() {
            deck = [];
            for(let s=0; s<SUITS.length; s++) {
                for(let r=0; r<RANKS.length; r++) {
                    deck.push({
                        rank: RANKS[r],
                        suit: SUITS[s],
                        val: r + 1, // 1 ~ 13
                        isRed: (SUITS[s] === 'â™¥' || SUITS[s] === 'â™¦')
                    });
                }
            }
            // Shuffle
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            document.getElementById('history-zone').innerHTML = '';
        }

        function drawCard() {
            if(deck.length === 0) initDeck(); 
            return deck.pop();
        }

        // [ì¤‘ìš”] ì‹¤ì‹œê°„ ë°°ë‹¹ë¥  ê³„ì‚° í•¨ìˆ˜
        function updateButtonOdds() {
            if (!currentCard || deck.length === 0) return;

            // ë‚¨ì€ ë±ì—ì„œ ìŠ¹ë¦¬ ì¹´ë“œê°€ ëª‡ ì¥ì¸ì§€ ì¹´ìš´íŠ¸
            let higherCount = deck.filter(c => c.val > currentCard.val).length;
            let lowerCount = deck.filter(c => c.val < currentCard.val).length;
            let total = deck.length;

            const HOUSE_EDGE = 0.96; // 4% í•˜ìš°ìŠ¤ ì—£ì§€

            // High ë°°ë‹¹ ê³„ì‚°
            if (higherCount > 0) {
                let rawOdds = total / higherCount;
                curOddsHigh = rawOdds * HOUSE_EDGE;
                if(curOddsHigh < 1.01) curOddsHigh = 1.01; // ìµœì†Œ ë°°ë‹¹
                
                document.getElementById('btn-high').disabled = false;
                document.getElementById('label-high').innerText = `(x${curOddsHigh.toFixed(2)})`;
            } else {
                // ì´ê¸¸ í™•ë¥  0%
                document.getElementById('btn-high').disabled = true;
                document.getElementById('label-high').innerText = `(ë¶ˆê°€)`;
            }

            // Low ë°°ë‹¹ ê³„ì‚°
            if (lowerCount > 0) {
                let rawOdds = total / lowerCount;
                curOddsLow = rawOdds * HOUSE_EDGE;
                if(curOddsLow < 1.01) curOddsLow = 1.01;

                document.getElementById('btn-low').disabled = false;
                document.getElementById('label-low').innerText = `(x${curOddsLow.toFixed(2)})`;
            } else {
                document.getElementById('btn-low').disabled = true;
                document.getElementById('label-low').innerText = `(ë¶ˆê°€)`;
            }
        }

        // ì´ˆê¸° í™”ë©´ ì„¸íŒ…
        function resetGameDisplay() {
            isStreak = false;
            currentPot = 0;
            
            initDeck();
            currentCard = drawCard();
            renderCard('current-card', currentCard);
            
            updateButtonOdds(); // ë°°ë‹¹ ì—…ë°ì´íŠ¸

            document.getElementById('bet-panel').style.display = 'block';
            document.getElementById('bet-input').disabled = false;
            document.getElementById('btn-reset').disabled = false;
            document.getElementById('btn-collect').style.display = 'none';
            document.getElementById('pot-display').style.display = 'none';
            document.getElementById('next-card').className = 'card back';
            document.getElementById('next-card').innerHTML = '';
            document.getElementById('msg-box').innerText = "ë°°íŒ… í›„ ì‹œì‘í•˜ì„¸ìš”.";
        }
        
        resetGameDisplay();

        window.toggleHelp = () => {
            const el = document.getElementById('help-modal');
            el.style.display = (el.style.display === 'flex') ? 'none' : 'flex';
        };

        window.addBet = (amt) => {
            if(isStreak || isProcessing) return;
            const input = document.getElementById('bet-input');
            let current = parseInt(input.value) || 0;
            let target = (amt === 'ALL') ? myBalance : current + amt;
            if(target > myBalance) target = myBalance;
            input.value = target;
        };

        window.resetBet = () => {
            if(isStreak || isProcessing) return;
            document.getElementById('bet-input').value = '0';
        };

        window.playRound = async (choice) => {
            if(isProcessing) return;
            
            // í˜„ì¬ ì„ íƒí•œ ë°°ë‹¹ë¥  ì €ì¥ (í´ë¦­ ì‹œì ì˜ ë°°ë‹¹)
            let selectedOdds = (choice === 'HIGH') ? curOddsHigh : curOddsLow;

            // 1. ì²« ì‹œì‘ (ë°°íŒ…ê¸ˆ ì°¨ê°)
            if (!isStreak) {
                const betInput = document.getElementById('bet-input');
                const betMoney = parseInt(betInput.value) || 0;

                if(betMoney <= 0) return alert("ë°°íŒ…ê¸ˆì„ ì…ë ¥í•˜ì„¸ìš”.");
                if(betMoney > myBalance) return alert("ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");

                myBalance -= betMoney;
                currentPot = betMoney;
                isStreak = true;
                
                updateUI();
                await updateDoc(userRef, { coins: myBalance });
                
                document.getElementById('bet-panel').style.display = 'none';
                document.getElementById('btn-reset').disabled = true;
                document.getElementById('pot-display').style.display = 'block';
                document.getElementById('pot-display').innerText = `Pot: ${currentPot.toLocaleString()}`;
            }

            isProcessing = true;
            document.getElementById('msg-box').innerText = "ê²°ê³¼ í™•ì¸ ì¤‘...";

            const nextCard = drawCard();
            
            setTimeout(async () => {
                renderCard('next-card', nextCard);

                let result = '';
                if (nextCard.val === currentCard.val) {
                    result = 'TIE';
                } else if (choice === 'HIGH' && nextCard.val > currentCard.val) {
                    result = 'WIN';
                } else if (choice === 'LOW' && nextCard.val < currentCard.val) {
                    result = 'WIN';
                } else {
                    result = 'LOSE';
                }

                if (result === 'WIN') {
                    // ìŠ¹ë¦¬: í˜„ì¬ íŒŸ * ê°€ë³€ ë°°ë‹¹ë¥ 
                    // ì£¼ì˜: ì²« íŒì€ ì›ê¸ˆ * ë°°ë‹¹ë¥ , ë‘ë²ˆì§¸ë¶€í„´ íŒŸ * ë°°ë‹¹ë¥ 
                    currentPot = Math.floor(currentPot * selectedOdds);

                    document.getElementById('msg-box').innerHTML = `<span style="color:#2ecc71">ì„±ê³µ! (x${selectedOdds.toFixed(2)})</span>`;
                    document.getElementById('pot-display').innerText = `Pot: ${currentPot.toLocaleString()}`;
                    
                    const collectBtn = document.getElementById('btn-collect');
                    collectBtn.style.display = 'block';
                    collectBtn.innerText = `ğŸ’° ${currentPot.toLocaleString()} íšë“í•˜ê³  íŠ€ê¸° (Stop)`;

                } else if (result === 'TIE') {
                    document.getElementById('msg-box').innerHTML = `<span style="color:#f1c40f">ë¬´ìŠ¹ë¶€! íŒëˆ ìœ ì§€! (ì¬ë„ì „)</span>`;
                    // íŒŸ ìœ ì§€
                } else {
                    document.getElementById('msg-box').innerHTML = `<span style="color:#e74c3c">ì‹¤íŒ¨... ì „ì•¡ ëª°ìˆ˜!</span>`;
                    currentPot = 0;
                    document.getElementById('pot-display').innerText = `Pot: 0`;
                    
                    setTimeout(() => {
                        alert("íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤. ì¹´ë“œê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.");
                        resetGameDisplay();
                    }, 1500);
                    isProcessing = false;
                    return; 
                }

                setTimeout(() => {
                    addToHistory(currentCard);
                    
                    currentCard = nextCard;
                    renderCard('current-card', currentCard);
                    
                    const nextEl = document.getElementById('next-card');
                    nextEl.className = 'card back';
                    nextEl.innerHTML = '';
                    
                    updateButtonOdds(); // ë‹¤ìŒ ì¹´ë“œë¡œ ë°°ë‹¹ë¥  ì¬ê³„ì‚°!

                    isProcessing = false;
                    
                    if(deck.length === 0) {
                        alert("ë‚¨ì€ ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤! ê°•ì œë¡œ íšë“í•©ë‹ˆë‹¤.");
                        collectWinnings();
                    }
                }, 1000);

            }, 500);
        };

        window.collectWinnings = async () => {
            if(!isStreak || currentPot === 0) return;
            
            const winAmount = currentPot;
            myBalance += winAmount;
            
            await updateDoc(userRef, { coins: increment(winAmount) });
            updateUI();
            
            alert(`ì¶•í•˜í•©ë‹ˆë‹¤! ${winAmount.toLocaleString()} ì½”ì¸ì„ íšë“í–ˆìŠµë‹ˆë‹¤.`);
            resetGameDisplay();
        };

        function updateUI() {
            document.getElementById('wallet-bal').innerText = myBalance.toLocaleString();
        }

        function renderCard(id, card) {
            const el = document.getElementById(id);
            if(!card) return;
            el.className = `card ${card.isRed ? 'red' : 'black'}`;
            el.innerHTML = `
                <div class="card-val-top">${card.rank}</div>
                <div class="card-suit-center">${card.suit}</div>
                <div class="card-val-bot">${card.rank}</div>
            `;
        }
        
        function addToHistory(card) {
            const container = document.getElementById('history-zone');
            const mini = document.createElement('div');
            mini.className = `mini-card ${card.isRed ? 'red' : 'black'}`;
            mini.innerText = `${card.suit}${card.rank}`;
            
            const count = container.children.length;
            mini.style.left = (count * 20) + 'px'; 
            mini.style.zIndex = count;
            
            if(card.isRed) mini.style.color = '#c0392b';
            else mini.style.color = '#2c3e50';

            container.appendChild(mini);
        }
    </script>
</body>
</html>