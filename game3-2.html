<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Casino - Hol/Jjak</title>
    <link rel="apple-touch-icon" href="icon.png">
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background-color: #222; color: white; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* ìƒë‹¨ ì •ë³´ì°½ */
        .header { 
            padding: 15px; background: #2c3e50; 
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 20;
        }
        .title-group { display: flex; align-items: center; gap: 8px; }
        .btn-help {
            width: 24px; height: 24px; border-radius: 50%; background: white; color: #333;
            border: none; font-weight: bold; font-size: 14px; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
        }
        .money-box { font-size: 18px; font-weight: bold; color: #f1c40f; text-shadow: 1px 1px 0 #000; }
        
        /* ê²Œì„ ìŠ¤í…Œì´ì§€ (ì´ˆë¡ìƒ‰ í¬ì»¤ íŒ) */
        .stage { 
            flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; 
            /* í¬ì»¤ í…Œì´ë¸” ëŠë‚Œì˜ ê·¸ë¦° ê·¸ë¼ë°ì´ì…˜ */
            background: radial-gradient(circle at center, #27ae60 0%, #145a32 100%); 
            position: relative; 
            box-shadow: inset 0 0 50px rgba(0,0,0,0.5); 
        }
        
        .cup-container { position: relative; width: 200px; height: 200px; display: flex; justify-content: center; align-items: center; }
        .cup { font-size: 120px; z-index: 10; transition: transform 0.3s; cursor: pointer; filter: drop-shadow(0 15px 15px rgba(0,0,0,0.6)); }
        .dice-group { position: absolute; top: 80px; display: flex; gap: 20px; opacity: 0; transition: 0.3s; }
        .dice { width: 50px; height: 50px; background: white; border-radius: 8px; color: black; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 24px; box-shadow: 2px 2px 5px rgba(0,0,0,0.5); }
        
        /* ì‰ì´í‚¹ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .shaking { animation: shake 0.5s; animation-iteration-count: infinite; }
        .cup-lift { transform: translateY(-80px) rotate(-20deg); }

        .result-text { 
            margin-top: 30px; font-size: 20px; font-weight: bold; min-height: 50px; 
            color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.8); 
            text-align: center; white-space: pre-line; line-height: 1.4;
        }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .control-panel { background: #fff; color: #333; padding: 20px; border-top-left-radius: 20px; border-top-right-radius: 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.5); }
        
        .bet-input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .input-money { flex: 1; padding: 10px; font-size: 18px; border: 2px solid #ccc; border-radius: 8px; text-align: right; font-weight: bold; }
        .btn-set { background: #95a5a6; color: white; border: none; border-radius: 8px; padding: 0 15px; font-weight: bold; cursor: pointer; }

        .choice-group { display: flex; gap: 15px; height: 60px; }
        .btn-choice { flex: 1; border: none; border-radius: 10px; font-size: 20px; font-weight: bold; color: white; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 0 rgba(0,0,0,0.2); position: relative; overflow: hidden; }
        .btn-choice:active { transform: translateY(4px); box-shadow: none; }
        
        .btn-odd { background: #3498db; } /* í™€: íŒŒë‘ */
        .btn-even { background: #e74c3c; } /* ì§: ë¹¨ê°• */
        .btn-choice.selected { border: 4px solid #f1c40f; transform: scale(1.02); }

        .action-bar { margin-top: 20px; display: flex; gap: 10px; }
        .btn-main { flex: 1; padding: 15px; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; color: white; cursor: pointer; }
        
        .btn-back { background: #7f8c8d; width: 80px; flex: none; box-shadow: 0 4px 0 #5f6c6d; }
        .btn-back:active { transform: translateY(4px); box-shadow: none; }

        .btn-reset { background: #e67e22; color: white; width: 80px; flex: none; box-shadow: 0 4px 0 #d35400; }
        .btn-reset:active { transform: translateY(4px); box-shadow: none; }

        .btn-start { background: #2ecc71; box-shadow: 0 4px 0 #27ae60; }
        .btn-start:active { transform: translateY(4px); box-shadow: none; }
        .btn-start:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; }

        /* ë„ì›€ë§ ëª¨ë‹¬ */
       .modal { 
            position: fixed; 
            top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); /* ë°°ê²½ ë” ì§„í•˜ê²Œ */
            z-index: 9999; /* ìµœìƒìœ„ ë ˆì´ì–´ */
            display: none; 
            justify-content: center; align-items: center; 
            backdrop-filter: blur(2px); /* ë¸”ëŸ¬ íš¨ê³¼ */
        }
        .modal-content { 
            background: #fff; color: #333; 
            width: 85%; max-width: 350px; 
            max-height: 85vh; /* í™”ë©´ ë†’ì´ë¥¼ ë„˜ì–´ê°€ë©´ */
            overflow-y: auto; /* ìŠ¤í¬ë¡¤ ìƒì„± */
            padding: 25px; 
            border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); text-align: left;
            border: 1px solid #ddd; position: relative;
        }
        .modal-title { font-size: 20px; font-weight: bold; margin-bottom: 15px; text-align: center; border-bottom: 2px solid #eee; padding-bottom: 10px;}
        .modal-text { font-size: 14px; line-height: 1.6; margin-bottom: 20px; color: #555; }
        .modal-close { background: #333; color: white; width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

    </style>
</head>
<body>

    <div class="header">
        <div class="title-group">
            <span>ğŸ² ì£¼ì‚¬ìœ„ í™€ì§</span>
            <button class="btn-help" onclick="toggleHelp()">?</button>
        </div>
        <div class="money-box" id="wallet-bal">0</div>
    </div>

    <div class="stage">
        <div class="cup-container">
            <div id="dice-group" class="dice-group">
                <div class="dice" id="d1">?</div>
                <div class="dice" id="d2">?</div>
            </div>
            <div id="cup" class="cup">ğŸ¥¡</div>
        </div>
        <div id="result-text" class="result-text">ë°°íŒ… í›„ í™€/ì§ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
    </div>

    <div class="control-panel">
        <div class="bet-input-group">
            <input type="number" id="bet-amount" class="input-money" placeholder="ë°°íŒ…ê¸ˆì•¡">
            <button class="btn-set" onclick="setBet(1000)">+1ì²œ</button>
            <button class="btn-set" onclick="setBet(10000)">+1ë§Œ</button>
            <button class="btn-set" style="background:#e67e22;" onclick="setBet('ALL')">ì˜¬ì¸</button>
        </div>

        <div class="choice-group">
            <button class="btn-choice btn-odd" onclick="selectChoice('ODD')">í™€ (Odd)</button>
            <button class="btn-choice btn-even" onclick="selectChoice('EVEN')">ì§ (Even)</button>
        </div>

        <div class="action-bar">
            <button class="btn-main btn-back" onclick="location.href='game3.html'">ë‚˜ê°€ê¸°</button>
            <button class="btn-main btn-reset" onclick="resetBet()">ì´ˆê¸°í™”</button>
            <button id="btn-start" class="btn-main btn-start" onclick="startGame()" disabled>ì„ íƒí•˜ì„¸ìš”</button>
        </div>
    </div>

    <div id="help-modal" class="modal" onclick="toggleHelp()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-title">ê²Œì„ ë°©ë²•</div>
            <div class="modal-text">
                <b>1. ê¸°ë³¸ ê·œì¹™</b><br>
                ì£¼ì‚¬ìœ„ 2ê°œë¥¼ êµ´ë ¤ ë‚˜ì˜¨ í•©ì´ <b>í™€(Odd)</b>ì¸ì§€ <b>ì§(Even)</b>ì¸ì§€ ì˜ˆì¸¡í•˜ëŠ” ê²Œì„ì…ë‹ˆë‹¤.<br><br>
                <b>2. ë°°ë‹¹ë¥ </b><br>
                ìŠ¹ë¦¬ ì‹œ ë°°íŒ… ê¸ˆì•¡ì˜ <b>1.95ë°°</b>ë¥¼ ì§€ê¸‰í•©ë‹ˆë‹¤.<br><br>
                <b>3. ì§„í–‰ ë°©ë²•</b><br>
                ê¸ˆì•¡ì„ ì„¤ì •í•˜ê³  í™€/ì§ ë²„íŠ¼ì„ ëˆ„ë¥¸ ë’¤ [ê²°ê³¼ í™•ì¸] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
            </div>
            <button class="modal-close" onclick="toggleHelp()">ë‹«ê¸°</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, increment } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDTMfB6Fl6QiiJdcTjpcU9nha2GP4Ne_6o",
          authDomain: "lovechatproject-2db11.firebaseapp.com",
          projectId: "lovechatproject-2db11",
          storageBucket: "lovechatproject-2db11.firebasestorage.app",
          messagingSenderId: "1069136590072",
          appId: "1:1069136590072:web:7712e718db03c70bff370d",
          measurementId: "G-ERG2LL283F"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let myId = localStorage.getItem('chat_uid');
        const userRef = doc(db, "users", myId);

        let myBalance = 0;
        let selectedChoice = null; 
        let isPlaying = false;

        getDoc(userRef).then(snap => {
            if(snap.exists()) {
                myBalance = snap.data().coins;
                document.getElementById('wallet-bal').innerText = myBalance.toLocaleString();
            }
        });

        // [ë„ì›€ë§ í† ê¸€]
        window.toggleHelp = () => {
            const el = document.getElementById('help-modal');
            el.style.display = (el.style.display === 'flex') ? 'none' : 'flex';
        };

        window.setBet = (amount) => {
            if(isPlaying) return;
            const input = document.getElementById('bet-amount');
            let current = parseInt(input.value) || 0;
            let target = 0;

            if(amount === 'ALL') {
                target = myBalance;
            } else {
                target = current + amount;
            }

            if (target > myBalance) target = myBalance;
            input.value = target;
        };

        window.resetBet = () => {
            if(isPlaying) return;
            document.getElementById('bet-amount').value = '';
        };

        window.selectChoice = (choice) => {
            if(isPlaying) return;
            selectedChoice = choice;
            
            document.querySelectorAll('.btn-choice').forEach(b => b.classList.remove('selected'));
            if(choice === 'ODD') document.querySelector('.btn-odd').classList.add('selected');
            else document.querySelector('.btn-even').classList.add('selected');

            checkStartable();
        };

        function checkStartable() {
            const btn = document.getElementById('btn-start');
            if(selectedChoice) {
                btn.disabled = false;
                btn.innerText = "ê²°ê³¼ í™•ì¸ (Start)";
            }
        }

        window.startGame = async () => {
            const betInput = document.getElementById('bet-amount');
            let betMoney = parseInt(betInput.value) || 0;

            if(betMoney <= 0) return alert("ë°°íŒ… ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            if(betMoney > myBalance) return alert("ë³´ìœ  ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
            
            myBalance -= betMoney;
            document.getElementById('wallet-bal').innerText = myBalance.toLocaleString();
            await updateDoc(userRef, { coins: myBalance });

            isPlaying = true;
            document.getElementById('btn-start').disabled = true;
            document.getElementById('result-text').innerText = "ê²°ê³¼ í™•ì¸ ì¤‘...";
            
            const cup = document.getElementById('cup');
            const diceGroup = document.getElementById('dice-group');
            cup.classList.remove('cup-lift');
            diceGroup.style.opacity = '0';

            setTimeout(() => { cup.classList.add('shaking'); }, 100);

            setTimeout(async () => {
                cup.classList.remove('shaking');
                
                const d1 = Math.floor(Math.random() * 6) + 1;
                const d2 = Math.floor(Math.random() * 6) + 1;
                const sum = d1 + d2;
                const resultType = (sum % 2 !== 0) ? 'ODD' : 'EVEN';
                const resultStr = resultType === 'ODD' ? 'í™€ (ODD)' : 'ì§ (EVEN)';

                document.getElementById('d1').innerText = d1;
                document.getElementById('d2').innerText = d2;
                
                cup.classList.add('cup-lift');
                diceGroup.style.opacity = '1';

                const resText = document.getElementById('result-text');

                if(selectedChoice === resultType) {
                    const winMoney = Math.floor(betMoney * 1.95);
                    resText.innerText = `ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ${resultStr}ì…ë‹ˆë‹¤.\n(+${winMoney.toLocaleString()} íšë“)`;
                    resText.style.color = "#f1c40f"; 
                    
                    myBalance += winMoney;
                    await updateDoc(userRef, { coins: increment(winMoney) });
                } else {
                    resText.innerText = `ì•„ì‰½ìŠµë‹ˆë‹¤. ê²°ê³¼ëŠ” ${resultStr}ì…ë‹ˆë‹¤.`;
                    resText.style.color = "#e74c3c";
                }
                
                document.getElementById('wallet-bal').innerText = myBalance.toLocaleString();
                isPlaying = false;
                document.getElementById('btn-start').disabled = false;
            }, 2000);
        };
    </script>
</body>
</html>