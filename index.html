<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LoveChat">

    <link id="favicon" rel="icon" href="https://cdn-icons-png.flaticon.com/512/2076/2076218.png">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2076/2076218.png">
    <link rel="manifest" href="manifest.json">

    <title>ì°ê°±ì´í†¡</title>
    <style>
        /* [ê¸°ë³¸ ì„¤ì •] */
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background-color: #f0f0f0; margin: 0; display: flex; justify-content: center; height: 100dvh; overflow: hidden; touch-action: manipulation; }
        
        #app { 
            width: 100%; max-width: 450px; background: white; 
            display: flex; flex-direction: column; 
            box-shadow: 0 0 20px rgba(0,0,0,0.1); 
            height: 100%; position: relative; 
        }
        
        .screen { display: none; flex-direction: column; height: 100%; box-sizing: border-box; background: white; }
        .active { display: flex; }

        .auth-container { padding: 40px; display: flex; flex-direction: column; justify-content: center; height: 100%; text-align: center; }
        input { padding: 15px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 12px; font-size: 16px; width: 100%; box-sizing: border-box; }
        .btn-primary { padding: 15px; background-color: #ff6b6b; color: white; border: none; border-radius: 12px; font-size: 16px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.2s; }
        
        #chat-header { 
            padding-top: calc(15px + env(safe-area-inset-top)); padding-bottom: 15px; padding-left: 20px; padding-right: 20px;
            background: #ff6b6b; color: white; display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10; flex-shrink: 0; 
        }
        .header-left { display: flex; flex-direction: column; }
        #chat-title { font-weight: bold; font-size: 16px; }
        #status-area { font-size: 12px; margin-top: 3px; display: flex; align-items: center; gap: 5px; opacity: 0.9; }
        .online-dot { width: 8px; height: 8px; background-color: #00ff00; border-radius: 50%; display: inline-block; box-shadow: 0 0 5px #00ff00; }
        .offline-dot { width: 8px; height: 8px; background-color: #ccc; border-radius: 50%; display: inline-block; }
        .header-icons { display: flex; gap: 10px; }
        .icon-btn { font-size: 20px; cursor: pointer; background: none; border: none; color: white; padding: 0; }
        
        #search-container { display: none; padding: 10px; background: #fff0f0; border-bottom: 1px solid #ffcccc; flex-shrink: 0; }
        #search-input { width: 100%; padding: 10px; border: 1px solid #ff6b6b; border-radius: 8px; }
        
        #messages { flex: 1; overflow-y: auto; padding: 20px; background: #fafafa; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        .date-divider { text-align: center; margin: 15px 0; }
        .date-divider span { background: rgba(0,0,0,0.1); color: white; padding: 4px 12px; border-radius: 10px; font-size: 11px; }
        #top-loading { text-align: center; padding: 10px; font-size: 12px; color: #888; display: none; }

        /* ë‹µì¥ ë¯¸ë¦¬ë³´ê¸° ë°” */
        #reply-preview-bar { 
            display: none; background: #fff; border-top: 1px solid #eee; padding: 10px 15px; 
            border-left: 4px solid #ff6b6b; justify-content: space-between; align-items: center; flex-shrink: 0; 
        }
        .reply-preview-content { display: flex; flex-direction: column; width: 90%; }
        .reply-to-name { font-size: 12px; font-weight: bold; color: #ff6b6b; margin-bottom: 2px; }
        .reply-to-text { font-size: 12px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .close-reply-btn { font-size: 20px; color: #999; cursor: pointer; background: none; border: none; padding: 5px; }

        #input-area { 
            padding: 10px; padding-bottom: calc(20px + env(safe-area-inset-bottom));
            background: white; border-top: 1px solid #eee; display: flex; align-items: center; gap: 8px; 
            position: relative; flex-shrink: 0; 
        }
       #msg-input { 
    flex: 1; 
    margin: 0; 
    padding: 12px; 
    border-radius: 20px; 
    border: 1px solid #ddd; 
    background: #f8f8f8; 
    
    /* â–¼â–¼â–¼ [ì—¬ê¸°ì„œë¶€í„° ë³€ê²½ëœ ë¶€ë¶„] â–¼â–¼â–¼ */
    resize: none;          /* ì‚¬ìš©ì ì„ì˜ ì¡°ì ˆ ë°©ì§€ */
    font-family: inherit;  /* í°íŠ¸ ìƒì† */
    line-height: 1.4;      /* ì¤„ ê°„ê²© */
    height: 45px;          /* ê¸°ë³¸ ë†’ì´ ê³ ì • */
    max-height: 90px;      /* ìµœëŒ€ ë†’ì´ (ì•½ 3~4ì¤„) */
    overflow-y: auto;      /* 3ì¤„ ë„˜ì–´ê°€ë©´ ìŠ¤í¬ë¡¤ ìƒê¹€ */
    box-sizing: border-box;
}
        #send-btn { width: 50px; height: 40px; border: none; background: #333; color: white; border-radius: 12px; cursor: pointer; }
        .tool-btn { cursor: pointer; font-size: 24px; padding: 0 5px; color: #888; background: none; border: none; }
        #photo-input { position: absolute; top: -9999px; left: -9999px; opacity: 0; pointer-events: none; }

        #emoji-picker { display: none; position: absolute; bottom: 90px; left: 10px; background: white; border: 1px solid #ddd; border-radius: 10px; padding: 10px; grid-template-columns: repeat(6, 1fr); gap: 5px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); z-index: 20; width: 90%; max-width: 300px; }
        .emoji-item { font-size: 24px; cursor: pointer; text-align: center; padding: 5px; border-radius: 5px; }

        /* ë‹µì¥ ìŠ¤íƒ€ì¼ */
        .reply-btn { 
            font-size: 12px; margin-left: 5px; cursor: pointer; opacity: 0.5; color: #888; 
            transition: 0.2s; vertical-align: middle; 
        }
        .my-msg .reply-btn { color: rgba(255,255,255,0.7); }
        .quote-block {
            background: rgba(0,0,0,0.05); border-left: 3px solid #999; padding: 5px 8px;
            margin-bottom: 5px; border-radius: 4px; cursor: pointer; font-size: 12px;
            display: flex; flex-direction: column; text-align: left;
        }
        .my-msg .quote-block { background: rgba(0,0,0,0.1); border-left-color: rgba(255,255,255,0.5); color: #f0f0f0; }
        .quote-sender { font-weight: bold; margin-bottom: 2px; opacity: 0.8; font-size: 11px; }
        .quote-text { opacity: 0.9; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* ë©”ì‹œì§€ í•˜ì´ë¼ì´íŠ¸ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes highlightFade { 0% { background-color: rgba(255, 235, 59, 0.5); transform: scale(1.02); } 100% { background-color: !important; } }
        .highlight-anim { animation: highlightFade 1.5s ease-out; }

        .message { max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 15px; line-height: 1.5; position: relative; word-wrap: break-word; }
        .my-msg { align-self: flex-end; background-color: #ff6b6b; color: white; border-bottom-right-radius: 4px; }
        .other-msg { align-self: flex-start; background-color: white; color: #333; border: 1px solid #eee; border-bottom-left-radius: 4px; }
        .msg-info { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 4px; gap: 5px; min-width: 45px; }
        .sender { font-size: 11px; font-weight: bold; opacity: 0.7; }
        .time { font-size: 10px; opacity: 0.6; }
        .unread-mark { font-size: 12px; margin-right: auto; display: none; }
        .my-msg .msg-info .unread-mark { display: inline; } 
        .chat-img { max-width: 100%; border-radius: 10px; margin-bottom: 5px; cursor: pointer; }
        .message a { color: #007bff; text-decoration: underline; }
        .my-msg a { color: white; }

        #drawing-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; }
        .drawing-container { background: white; padding: 20px; border-radius: 15px; width: 90%; max-width: 400px; display: flex; flex-direction: column; align-items: center; }
        #canvas-area { border: 2px dashed #ddd; border-radius: 10px; cursor: crosshair; touch-action: none; background-color: white; }
        .drawing-controls { margin-top: 15px; display: flex; gap: 10px; width: 100%; }
        .draw-btn { flex: 1; padding: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        #clear-btn { background: #eee; color: #333; }
        #send-draw-btn { background: #ff6b6b; color: white; }
        .close-draw { align-self: flex-end; font-size: 24px; color: #999; cursor: pointer; margin-bottom: 10px; }

        #settings-screen { background: #f9f9f9; overflow-y: auto; display: none; flex-direction: column; height: 100%; }
        #settings-screen.active { display: flex; }
        .settings-header { 
            padding-top: calc(20px + env(safe-area-inset-top)); padding-bottom: 20px; padding-left: 20px; padding-right: 20px;
            background: white; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; flex-shrink: 0; 
        }
        .back-btn { font-size: 24px; cursor: pointer; border: none; background: none; }
        .gallery-section { background: white; padding: 15px; margin-top: 10px; }
        .gallery-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .view-all-btn { font-size: 13px; color: #ff6b6b; cursor: pointer; text-decoration: none; font-weight: bold; }
        .gallery-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
        .gallery-item { width: 100%; aspect-ratio: 1/1; object-fit: cover; cursor: pointer; border-radius: 8px; border: 1px solid #eee; }
        .settings-menu { padding: 20px; background: white; margin-top: 10px; flex: 1; padding-bottom: calc(40px + env(safe-area-inset-bottom)); }
        .menu-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #eee; }
        .color-options { display: flex; gap: 10px; }
        .color-circle { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 0 3px rgba(0,0,0,0.2); }
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #ff6b6b; }
        input:checked + .slider:before { transform: translateX(18px); }
        
        .version-info { text-align: center; color: #aaa; font-size: 11px; margin-top: 20px; padding-bottom: 20px; }

        #full-gallery-screen { background: white; overflow-y: auto; }
        #full-gallery-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; padding: 2px; padding-bottom: calc(20px + env(safe-area-inset-bottom)); }
        #full-gallery-grid .gallery-item { border-radius: 0; border: none; }
        #gallery-loading { text-align: center; padding: 20px; color: #999; font-size: 12px; grid-column: span 3; display: none; }

        #loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; justify-content: center; align-items: center; flex-direction: column; color: white; }
        .spinner { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid white; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .danger-btn { font-size: 12px; color: #ff6b6b; border: 1px solid #ff6b6b; padding: 5px 10px; border-radius: 5px; background: white; cursor: pointer; }
/* [3] ìŠ¤í‹°ì»¤ ìŠ¤íƒ€ì¼ ì¶”ê°€ */

/* ì±„íŒ…ì°½ì— í‘œì‹œë  ìŠ¤í‹°ì»¤ (128px í¬ê¸°ë¡œ ì¶•ì†Œ í‘œì‹œ) */
.sticker-msg {
    width: 128px;
    height: 128px;
    background-repeat: no-repeat;
    border-radius: 10px;
    margin: 5px 0;
}

/* ìŠ¤í‹°ì»¤ ì„ íƒì°½ ìŠ¤íƒ€ì¼ */

/* ì„ íƒì°½ ì•ˆì˜ ì•„ì´ì½˜ */
.sticker-item {
    width: 64px;
    height: 64px;
    background-repeat: no-repeat;
    cursor: pointer;
    background-color: transparent;
    border-radius: 8px;
    border: 1px solid transparent;
}
.sticker-item:hover {
    background-color: #f5f5f5; 
}
/* [ì¶”ê°€] ìŠ¤í‹°ì»¤ íƒ­ ìŠ¤íƒ€ì¼ */
#sticker-picker {
    /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ë®ì–´ì“°ê¸° */
    display: none;
    position: absolute;
    bottom: 90px;
    left: 10px;
    width: 90%;
    max-width: 350px;
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    z-index: 20;
    overflow: hidden; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ ìœ ì§€ */
    padding: 0; /* íŒ¨ë”© ì œê±° (íƒ­ë°” ë•Œë¬¸ì—) */
    border: 1px solid #eee;
    flex-direction: column; /* ì„¸ë¡œ ë°°ì¹˜ */
}

#sticker-content {
    padding: 15px;
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    max-height: 250px;
    overflow-y: auto; /* ìŠ¤í‹°ì»¤ ë§ìœ¼ë©´ ìŠ¤í¬ë¡¤ */
    background-color: #fff; /* ë°°ê²½ìƒ‰ */
}

#sticker-tabs {
    display: flex;
    background: #f8f8f8;
    border-top: 1px solid #eee;
    height: 45px;
}

.tab-btn {
    flex: 1;
    border: none;
    background: none;
    cursor: pointer;
    font-size: 18px;
    opacity: 0.5;
    transition: 0.2s;
    border-bottom: 3px solid transparent;
}

.tab-btn:hover { background: #eee; }
.tab-btn.active-tab {
    opacity: 1;
    border-bottom: 3px solid #ff6b6b; /* í™œì„±í™”ëœ íƒ­ ìƒ‰ìƒ */
    color: #ff6b6b;
}
/* [ì¶”ê°€] ì—…ë°ì´íŠ¸ íŒì—… ìŠ¤íƒ€ì¼ */
#update-modal {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6); /* ë°˜íˆ¬ëª… ê²€ì€ ë°°ê²½ */
    z-index: 9999; /* ì œì¼ ìœ„ì— ëœ¨ë„ë¡ */
    display: flex;
    justify-content: center;
    align-items: center;
}
.update-content {
    background: white;
    padding: 25px;
    border-radius: 15px;
    width: 85%;
    max-width: 320px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    animation: popIn 0.3s ease-out;
}
@keyframes popIn {
    0% { transform: scale(0.8); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
}

    </style>
</head>
<body>

<div id="app">
    <div id="loading"><div class="spinner"></div><span>ì²˜ë¦¬ ì¤‘...</span></div>

    <div id="drawing-modal">
        <div class="drawing-container">
            <span class="close-draw" onclick="toggleDrawingPad()">Ã—</span>
            <canvas id="canvas-area" width="300" height="300"></canvas>
            <div class="drawing-controls">
                <button id="clear-btn" class="draw-btn" onclick="clearCanvas()">ì§€ìš°ê¸°</button>
                <button id="send-draw-btn" class="draw-btn" onclick="sendDrawing()">ë³´ë‚´ê¸°</button>
            </div>
        </div>
    </div>
<div id="update-modal" style="display: none;">
    <div class="update-content">
        <h3 style="margin-top:0; color:#ff6b6b;">ğŸš€ ì—…ë°ì´íŠ¸ ì•Œë¦¼ (Ver 1.9)</h3>
        <ul style="text-align:left; padding-left:20px; color:#555; font-size:14px; line-height:1.6;">
            <li>ğŸ“ ì•”í˜¸ê°€ ì—†ìœ¼ë©´ ì ‘ì†í•  ìˆ˜ ì—†ì–´ìš”!</li>
            <li></li>
        </ul>
        <button class="btn-primary" onclick="closeUpdatePopup()">í™•ì¸í–ˆì–´ìš”</button>
    </div>
</div>
    <div id="login-screen" class="screen active">
        <div class="auth-container">
            <h2 style="color:#ff6b6b;">ğŸ”’ Secret Access</h2>
            <p style="color:#666; margin-bottom:30px;">ìš°ë¦¬ë§Œì˜ ë¹„ë°€ ê³µê°„</p>
            <input type="password" id="password-input" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
            <button class="btn-primary" onclick="checkPassword()">ì…ì¥í•˜ê¸°</button>
            <p style="font-size:12px; color:#aaa; margin-top:20px;">íŒíŠ¸: 0726</p>
        </div>
    </div>

    <div id="name-screen" class="screen">
        <div class="auth-container">
            <h2>ë°˜ê°€ì›Œìš”! ğŸ‘‹</h2>
            <p>ì±„íŒ…ë°©ì—ì„œ ì“¸ ì´ë¦„ì„ ì •í•´ì£¼ì„¸ìš”.</p>
            <input type="text" id="name-input" placeholder="ì˜ˆ: ì¬ë˜¥ì¥êµ°, ì°">
            <button class="btn-primary" onclick="setName()">ì‹œì‘í•˜ê¸°</button>
        </div>
    </div>

    <div id="chat-screen" class="screen" style="padding:0;">
<div id="chat-header">
            <div class="header-left">
                <div id="chat-title">â¤ï¸ ìš°ë¦¬ë§Œì˜ ì±„íŒ…ë°©</div>
                <div id="status-area">ì ‘ì† í™•ì¸ ì¤‘...</div>
            </div>
            <div class="header-icons">
                <button class="icon-btn" onclick="location.href='calendar.html'" style="margin-right:5px;">ğŸ“…</button>
                <button class="icon-btn" onclick="location.href='gamelist.html'" style="margin-right:5px;">ğŸ®</button>
                <button class="icon-btn" onclick="toggleSearch()">ğŸ”</button>
                <button class="icon-btn" onclick="openSettings()">âš™ï¸</button>
            </div>
        </div>
        
<div id="search-container">
            <input type="hidden" id="search-input" placeholder="ëŒ€í™” ë‚´ìš© ê²€ìƒ‰..." onkeyup="filterMessages()" disabled>
        </div>
        
        <div id="messages">
            <div id="top-loading">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘... â³</div>
        </div>
        
<div id="emoji-picker"></div>
<div id="sticker-picker">
    <div id="sticker-content"></div>
    
    <div id="sticker-tabs">
        </div>
</div>
        <div id="reply-preview-bar">

            <div class="reply-preview-content">
                <span class="reply-to-name" id="reply-target-name"></span>
                <span class="reply-to-text" id="reply-target-text"></span>
            </div>
            <button class="close-reply-btn" onclick="cancelReply()">Ã—</button>
        </div>

<div id="input-area">
    <button class="tool-btn" onclick="toggleEmoji()">ğŸ˜Š</button>
    <button class="tool-btn" onclick="toggleSticker()">ğŸ»</button> <button class="tool-btn" onclick="toggleDrawingPad()">ğŸ–Œï¸</button>
    <button class="tool-btn" onclick="triggerFileUpload()">ğŸ“·</button>
    
  <textarea id="msg-input" placeholder="ë©”ì‹œì§€..." rows="1"></textarea>
    <button id="send-btn" onclick="sendMessage()">â¤</button>
</div>
        <input type="file" id="photo-input" accept="image/*" onchange="uploadImage(this.files[0])" disabled>
    </div>

    <div id="settings-screen" class="screen">
        <div class="settings-header"><button class="back-btn" onclick="closeSettings()">â†</button><h2 style="margin:0;">ì„¤ì • & ì¶”ì–µí•¨</h2></div>
        
        <div class="gallery-section">
            <div class="gallery-header">
                <h3 style="margin:0; font-size:16px;">ğŸ“‚ ìµœê·¼ ì‚¬ì§„ (3ì¥)</h3>
                <span class="view-all-btn" onclick="openFullGallery()">ì „ì²´ ëª¨ì•„ë³´ê¸° ></span>
            </div>
            <div id="gallery-preview" class="gallery-grid"></div>
        </div>
        
        <div class="settings-menu">
            <div class="menu-item">
                <span class="menu-label">ğŸ”” ì•Œë¦¼ ë°›ê¸°</span>
                <label class="switch"><input type="checkbox" id="noti-enable" onchange="saveSettings()"><span class="slider"></span></label>
            </div>
            <div class="menu-item">
                <span class="menu-label">ğŸ‘ï¸ ì•Œë¦¼ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°</span>
                <label class="switch"><input type="checkbox" id="noti-preview" onchange="saveSettings()"><span class="slider"></span></label>
            </div>
            <div class="menu-item"><span class="menu-label">ğŸ¨ ë°°ê²½ìƒ‰ ë³€ê²½</span>
                <div class="color-options">
                    <div class="color-circle" style="background:#fafafa;" onclick="changeBg('#fafafa')"></div>
                    <div class="color-circle" style="background:#fff0f0;" onclick="changeBg('#fff0f0')"></div>
                    <div class="color-circle" style="background:#e3f2fd;" onclick="changeBg('#e3f2fd')"></div>
                    <div class="color-circle" style="background:#f3e5f5;" onclick="changeBg('#f3e5f5')"></div>
                </div>
            </div>
            
            <div class="menu-item">
                <span class="menu-label">ğŸ§¹ ìºì‹œ ì‚­ì œ</span>
                <button class="danger-btn" onclick="clearCache()">ì‹¤í–‰</button>
            </div>
            
            <div class="menu-item" style="flex-direction:column; align-items:flex-start; gap:8px;">
                <span class="menu-label" style="color:red;">ğŸ”¥ ëŒ€í™” ë‚´ì—­ ì „ì²´ ì‚­ì œ</span>
                <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                    <span style="font-size:11px; color:#888;">ë‘ ëª… ëª¨ë‘ ë™ì˜í•´ì•¼ ì‚­ì œë©ë‹ˆë‹¤.</span>
                    <button id="delete-chat-btn" class="danger-btn" style="background:#fff5f5; border-color:red;" onclick="requestDeleteHistory()">ì‚­ì œ ìš”ì²­</button>
                </div>
            </div>

            <div class="menu-item"><span class="menu-label" style="color:red;" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</span></div>
            <div class="version-info">Ver 1.9 - 2025/12/31 Update</div>
        </div>
    </div>

    <div id="full-gallery-screen" class="screen">
        <div class="settings-header">
            <button class="back-btn" onclick="closeFullGallery()">â†</button>
            <h2 style="margin:0;">ëª¨ë“  ì¶”ì–µë“¤</h2>
        </div>
        <div id="full-gallery-grid"></div>
        <div id="gallery-loading">ë” ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, setDoc, query, orderBy, onSnapshot, serverTimestamp, limitToLast, getDocs, startAfter, limit, where, deleteDoc, writeBatch, updateDoc, arrayUnion, getDoc } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
import { getAuth, signInAnonymously, onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // ğŸ”´ [í•„ìˆ˜] ë³¸ì¸ì˜ firebaseConfigë¡œ ìˆ˜ì •í•´ì£¼ì„¸ìš”!
    const firebaseConfig = {
      apiKey: "AIzaSyDTMfB6Fl6QiiJdcTjpcU9nha2GP4Ne_6o",
      authDomain: "lovechatproject-2db11.firebaseapp.com",
      projectId: "lovechatproject-2db11",
      storageBucket: "lovechatproject-2db11.firebasestorage.app",
      messagingSenderId: "1069136590072",
      appId: "1:1069136590072:web:7712e718db03c70bff370d",
      measurementId: "G-ERG2LL283F"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

// 2. ì¸ì¦ ê¸°ëŠ¥ ì´ˆê¸°í™” ë° ë¡œê·¸ì¸ ì‹¤í–‰ (ì—¬ê¸° ì¶”ê°€!)
const auth = getAuth(app);


signInAnonymously(auth)
  .then(() => {
    console.log("Firebase ë¡œê·¸ì¸ ì„±ê³µ! ì´ì œ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
  })
  .catch((error) => {
    console.error("ë¡œê·¸ì¸ ì‹¤íŒ¨:", error);
  });
// [4] ìŠ¤í‹°ì»¤ ì„¤ì • (1024x512 ì´ë¯¸ì§€ ê¸°ì¤€)

// ==========================================
// ğŸ†• [ì—…ê·¸ë ˆì´ë“œ] ë©€í‹° íƒ­ ìŠ¤í‹°ì»¤ ì‹œìŠ¤í…œ
// ==========================================

// 1. ìŠ¤í‹°ì»¤ íŒ© ëª©ë¡ (ì—¬ê¸°ì— ê³„ì† ì¶”ê°€í•˜ë©´ ë©ë‹ˆë‹¤!)
const STICKER_PACKS = [
    {
        name: "í† ë¼ì™€ ê³°ëŒì´", // íƒ­ ì´ë¦„(ë˜ëŠ” ì•„ì´ì½˜)
        icon: "ğŸ°ğŸ»",         // íƒ­ì— ë³´ì¼ ì•„ì´ì½˜
        url: "https://github.com/Chickenhuman/oursecretchat/blob/main/emoticon1.png?raw=true", // ì´ë¯¸ì§€ ì£¼ì†Œ
        totalWidth: 1024,
        totalHeight: 559, // ì´ë¯¸ì§€ í¬ê¸°ì— ë§ì¶° ìˆ˜ì •
        cols: 4,
        count: 8          // ì´ëª¨í‹°ì½˜ ê°œìˆ˜
    },
    {
        name: "ëŸ¬ë¸”ë¦¬ ê³°", // ë‘ ë²ˆì§¸ íƒ­ ì˜ˆì‹œ
        icon: "ğŸ»",
        url: "https://raw.githubusercontent.com/ChickenHuman/oursecretchat/main/stickers_bear.png",
        totalWidth: 1024,
        totalHeight: 512,
        cols: 4,
        count: 8
    }
];

let currentPackIndex = 0; // í˜„ì¬ ë³´ê³  ìˆëŠ” íƒ­ ë²ˆí˜¸

// 2. ì´ˆê¸°í™”: íƒ­ ë²„íŠ¼ ìƒì„± ë° ì²« í™”ë©´ ë¡œë”©
function initStickerSystem() {
    const tabContainer = document.getElementById('sticker-tabs');
    const contentContainer = document.getElementById('sticker-content');
    
    // íƒ­ ë²„íŠ¼ ë§Œë“¤ê¸°
    tabContainer.innerHTML = "";
    STICKER_PACKS.forEach((pack, index) => {
        const btn = document.createElement('button');
        btn.className = 'tab-btn';
        btn.innerText = pack.icon; // ì•„ì´ì½˜ í‘œì‹œ
        btn.onclick = () => switchTab(index);
        tabContainer.appendChild(btn);
    });

    switchTab(0); // ì²« ë²ˆì§¸ íƒ­ ì—´ê¸°
}

// 3. íƒ­ ë³€ê²½ í•¨ìˆ˜
function switchTab(index) {
    currentPackIndex = index;
    const pack = STICKER_PACKS[index];
    const content = document.getElementById('sticker-content');
    
    // íƒ­ ìŠ¤íƒ€ì¼ í™œì„±í™”
    document.querySelectorAll('.tab-btn').forEach((b, i) => {
        if(i === index) b.classList.add('active-tab');
        else b.classList.remove('active-tab');
    });

    // ìŠ¤í‹°ì»¤ ê·¸ë¦¬ë“œ ìƒì„±
    content.innerHTML = "";
    for(let i=0; i<pack.count; i++) {
        const div = document.createElement('div');
        div.className = 'sticker-item';
        
        // ì¢Œí‘œ ê³„ì‚°
        const col = i % pack.cols;
        const row = Math.floor(i / pack.cols);
        const unitSize = pack.totalWidth / pack.cols; // 1ì¹¸ í¬ê¸° ìë™ ê³„ì‚°
        
        // ì„ íƒì°½ìš© ì¶•ì†Œ ë¹„ìœ¨ (64px ê¸°ì¤€)
        const scale = 64 / unitSize; 

        div.style.backgroundImage = `url('${pack.url}')`;
        div.style.backgroundSize = `${pack.totalWidth * scale}px ${pack.totalHeight * scale}px`;
        div.style.backgroundPosition = `-${col * 64}px -${row * 64}px`;
        div.style.backgroundColor = 'transparent'; // âœ¨ íˆ¬ëª… ë°°ê²½ í•µì‹¬
        
        div.onclick = () => sendSticker(i, currentPackIndex); // íŒ© ë²ˆí˜¸ë„ ê°™ì´ ì „ì†¡
        content.appendChild(div);
    }
}

// 4. ìŠ¤í‹°ì»¤ ì „ì†¡ í•¨ìˆ˜ (ìˆ˜ì •ë¨)
window.sendSticker = async function(stickerIdx, packIdx) {
    try {
        const payload = { 
            text: "(ì´ëª¨í‹°ì½˜)", 
            stickerIndex: stickerIdx, 
            packIndex: packIdx, // ğŸ”´ ì–´ë–¤ íŒ©ì¸ì§€ ì •ë³´ ì¶”ê°€
            sender: myName, 
            timestamp: serverTimestamp(), 
            type: 'sticker' 
        };
        if(currentReplyTarget) { payload.replyTo = currentReplyTarget; }
        
        await addDoc(collection(db, "chats"), payload);
        
        document.getElementById('sticker-picker').style.display = 'none';
        cancelReply();
        markAsRead();
        scrollToBottom();
    } catch (e) { console.error(e); alert("ì „ì†¡ ì‹¤íŒ¨"); }
};

// 5. ì°½ ì—´ê¸°/ë‹«ê¸° (ìˆ˜ì •ë¨)
window.toggleSticker = () => {
    const picker = document.getElementById('sticker-picker');
    const emo = document.getElementById('emoji-picker');
    emo.style.display = 'none';
    
    if (picker.style.display === 'flex') {
        picker.style.display = 'none';
    } else {
        picker.style.display = 'flex';
        initStickerSystem(); // ì—´ ë•Œë§ˆë‹¤ ì´ˆê¸°í™” (í˜¹ì€ ìµœì´ˆ 1íšŒë§Œ í•´ë„ ë¨)
    }
};    // ==========================================
    // â­ï¸ [ì¤‘ìš”] ëª¨ë“  ë³€ìˆ˜ ì„ ì–¸ì„ ìµœìƒë‹¨ìœ¼ë¡œ ì´ë™
    // ==========================================
    
    // 1. ì‚¬ìš©ì ì •ë³´
    let myName = localStorage.getItem('chat_nickname');
    let myId = localStorage.getItem('chat_uid');
    if (!myId) { myId = 'user_' + Date.now() + Math.floor(Math.random() * 1000); localStorage.setItem('chat_uid', myId); }
    let savedBg = localStorage.getItem('chat_bg') || '#fafafa';

    // 2. ì´ëª¨í‹°ì½˜ ë° ê¸°ëŠ¥ ê´€ë ¨
    const emojiList = ["â¤ï¸","ğŸ§¡","ğŸ’›","ğŸ’š","ğŸ’™","ğŸ’œ","ğŸ¤","ğŸ–¤","ğŸ¤","ğŸ¥°","ğŸ˜","ğŸ˜˜","ğŸ˜Š","ğŸ¤£","ğŸ˜‚","ğŸ¥²","ğŸ¥º","ğŸ‘","ğŸ‘","ğŸ‘","ğŸ™","ğŸ‰","ğŸ‚","ğŸ","ğŸ’‹","ğŸ’"];
    const deleteReqRef = doc(db, "settings", "delete_request");
    
    // 3. ì ‘ì† ìƒíƒœ ë° íƒ­ ì•Œë¦¼ ê´€ë ¨ ë³€ìˆ˜
    let presenceUnsub = null;
    let otherUserReadTime = 0;
    let lastPartnerMsgTime = 0; 
    let flashInterval = null; 
    const originalTitle = document.title; 
    const originalFavicon = document.getElementById('favicon').href;
    const alertFavicon = "https://cdn-icons-png.flaticon.com/512/1828/1828884.png"; 

    // 4. ë¡œë”© ìƒíƒœ ê´€ë ¨
    let isInitialLoad = true;
    let allImages = [];
    let oldestMessageSnap = null; 
    let isFetchingOlder = false; 
    let galleryLastSnap = null;
    let isGalleryLoading = false;
    let isGalleryEnd = false;
    
    // [ë‚ ì§œ êµ¬ë¶„ì„ ìš© ë³€ìˆ˜]
    let lastPrintedDate = null;
    function getDateString(timestamp) {
        if (!timestamp) return null;
        const date = timestamp.toDate();
        return new Intl.DateTimeFormat('ko-KR', { 
            year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' 
        }).format(date);
    }

    // 5. [NEW] ë‹µì¥ ê¸°ëŠ¥ ê´€ë ¨ ë³€ìˆ˜
    let currentReplyTarget = null; // { id: "msgId", text: "ë‚´ìš©", sender: "ë³´ë‚¸ì´" }

    // ==========================================
    // âš™ï¸ ê¸°ëŠ¥ í•¨ìˆ˜ ì •ì˜
    // ==========================================

    applyBg(savedBg);

    // ë‹µì¥ ì„¤ì • í•¨ìˆ˜
    window.setReply = (id, text, sender) => {
        currentReplyTarget = { id, text, sender };
        document.getElementById('reply-preview-bar').style.display = 'flex';
        document.getElementById('reply-target-name').innerText = `To. ${sender}`;
        document.getElementById('reply-target-text').innerText = text;
        document.getElementById('msg-input').focus();
    };

    // ë‹µì¥ ì·¨ì†Œ í•¨ìˆ˜
    window.cancelReply = () => {
        currentReplyTarget = null;
        document.getElementById('reply-preview-bar').style.display = 'none';
    };

    // ì›ë³¸ ë©”ì‹œì§€ë¡œ ì´ë™ í•¨ìˆ˜
    window.scrollToMessage = (msgId) => {
        const target = document.getElementById('msg-' + msgId);
        if(target) {
            target.scrollIntoView({ behavior: 'smooth', block: 'center' });
            target.classList.add('highlight-anim');
            setTimeout(() => target.classList.remove('highlight-anim'), 1500);
        } else {
            alert("ì›ë³¸ ë©”ì‹œì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ë„ˆë¬´ ì˜¤ë˜ëœ ë©”ì‹œì§€ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤)");
        }
    };

    const emojiPicker = document.getElementById('emoji-picker');
    emojiList.forEach(emo => {
        const span = document.createElement('span'); span.className = 'emoji-item'; span.innerText = emo;
        span.onclick = () => { document.getElementById('msg-input').value += emo; emojiPicker.style.display = 'none'; };
        emojiPicker.appendChild(span);
    });
    
    window.toggleEmoji = () => { 
        const picker = document.getElementById('emoji-picker'); 
        picker.style.display = (picker.style.display === 'grid') ? 'none' : 'grid'; 
    };

    function startTabNotification() {
        if(flashInterval) return; 
        let toggle = false;
        flashInterval = setInterval(() => {
            document.title = toggle ? "ğŸ”´ ë©”ì„¸ì§€ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤!" : originalTitle;
            toggle = !toggle;
        }, 1000); 
    }

    function stopTabNotification() {
        if(flashInterval) { clearInterval(flashInterval); flashInterval = null; }
        document.title = originalTitle; 
    }

    function showScreen(id) { 
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); 
        document.getElementById(id).classList.add('active'); 
        if(id === 'chat-screen') {
            setTimeout(scrollToBottom, 100);
            stopTabNotification(); 
        }
    }

    function monitorDeletionVotes() {
        onSnapshot(deleteReqRef, async (snap) => {
            if(snap.exists()) {
                const data = snap.data();
                const requests = data.requestedBy || [];
                const btn = document.getElementById('delete-chat-btn');
                if(!btn) return;

                if (requests.includes(myId)) {
                    btn.innerText = `ìƒëŒ€ë°© ë™ì˜ ëŒ€ê¸°ì¤‘ (${requests.length}/2)`;
                    btn.disabled = true;
                    btn.style.opacity = "0.5";
                } else if (requests.length > 0) {
                    btn.innerText = `ìƒëŒ€ë°©ì´ ì‚­ì œ ìš”ì²­í•¨ (1/2) - ëˆŒëŸ¬ì„œ ë™ì˜`;
                    btn.disabled = false;
                    btn.style.opacity = "1";
                } else {
                    btn.innerText = "ì‚­ì œ ìš”ì²­";
                    btn.disabled = false;
                    btn.style.opacity = "1";
                }

                if (requests.length >= 2) {
                    document.getElementById('loading').style.display = 'flex';
                    if (requests[0] === myId) { await performFullDeletion(); }
                }
            }
        });
    }

    window.requestNotiPermission = () => {
        if ("Notification" in window && Notification.permission !== "granted") {
            Notification.requestPermission();
        }
    };

    function startPresenceSystem() {
        if(!myName) return;
        markAsRead();
        setInterval(async () => { 
            if(document.hidden) return; 
            try { await setDoc(doc(db, "presence", myId), { name: myName, lastSeen: serverTimestamp() }, { merge: true }); } catch(e) {} 
        }, 30000); 
        if(!document.hidden) { togglePresenceListener(true); }
    }

    function togglePresenceListener(shouldListen) {
        if (shouldListen) {
            if (!presenceUnsub) {
                const q = query(collection(db, "presence"));
                presenceUnsub = onSnapshot(q, (snapshot) => {
                    let onlineUsers = [];
                    let maxReadTime = 0; 
                    snapshot.forEach((docSnap) => {
                        const data = docSnap.data();
                        if(docSnap.id !== myId && data.name !== myName) {
                            if (data.lastRead) {
                                const time = data.lastRead.toMillis();
                                if (time > maxReadTime) maxReadTime = time;
                            }
                            if(data.lastSeen && (new Date() - data.lastSeen.toDate()) / 1000 < 60) {
                                onlineUsers.push(data.name);
                            }
                        }
                    });
                    otherUserReadTime = maxReadTime;
                    const statusArea = document.getElementById('status-area');
                    if(statusArea) {
                        statusArea.innerHTML = onlineUsers.length > 0 ? `<span class="online-dot"></span> ${onlineUsers.join(', ')} ì ‘ì† ì¤‘` : `<span class="offline-dot"></span> ìƒëŒ€ë°© ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...`;
                    }
                    updateReadStatus();
                });
            }
        } else {
            if (presenceUnsub) { presenceUnsub(); presenceUnsub = null; }
        }
    }

    function markAsRead() { if(!myName) return; setDoc(doc(db, "presence", myId), { name: myName, lastSeen: serverTimestamp(), lastRead: serverTimestamp() }, { merge: true }); }
    
  // [ìˆ˜ì • í›„] ì´ë ‡ê²Œ ë°”ê¾¸ì„¸ìš”! ğŸ‘‡
document.addEventListener("visibilitychange", () => { 
    if (document.visibilityState === 'visible') {
        markAsRead(); 
        stopTabNotification(); 
        togglePresenceListener(true);
        
        // [ì¶”ê°€ë¨] í™”ë©´ì— ëŒì•„ì˜¤ë©´ ê°•ì œë¡œ ìŠ¤í¬ë¡¤ì„ ì‹¹ ë‚´ë ¤ì„œ ìµœì‹  ê¸€ì„ ë³´ì—¬ì¤Œ
        setTimeout(scrollToBottom, 100); 
    } else {
        togglePresenceListener(false); 
    }
});
    window.onclick = markAsRead;

    function updateReadStatus() {
        const effectiveReadTime = Math.max(otherUserReadTime, lastPartnerMsgTime);
        document.querySelectorAll('.my-msg').forEach(msgDiv => {
            const timestamp = msgDiv.getAttribute('data-timestamp');
            const unreadMark = msgDiv.querySelector('.unread-mark');
            if (timestamp && unreadMark) {
                if (Number(timestamp) <= effectiveReadTime) { unreadMark.style.display = 'none'; } 
                else { unreadMark.style.display = 'inline'; }
            }
        });
    }

    function linkify(text) {
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        return text.replace(urlRegex, function(url) {
            return `<a href="${url}" target="_blank">${url}</a>`;
        });
    }

    window.checkPassword = function() { 
        if (document.getElementById('password-input').value === '0726') { 
            localStorage.setItem('chat_auth_pw', '0726'); 
            if (myName) { showScreen('chat-screen'); loadMessages(); startPresenceSystem(); monitorDeletionVotes(); window.requestNotiPermission(); } 
            else { showScreen('name-screen'); } 
        } else { alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤!'); } 
    };
    
    window.setName = function() { 
        const name = document.getElementById('name-input').value; 
        if (!name) return alert("ì´ë¦„ ì…ë ¥"); 
        myName = name; 
        localStorage.setItem('chat_nickname', name); 
        showScreen('chat-screen'); loadMessages(); startPresenceSystem(); monitorDeletionVotes(); window.requestNotiPermission(); 
    };

    window.sendMessage = async function() { 
        const input = document.getElementById('msg-input'); 
        const text = input.value; 
        if (text.trim() === "") return; 
        try { 
            const payload = { text: text, sender: myName, timestamp: serverTimestamp(), type: 'text' };
            // ë‹µì¥ ì¤‘ì´ë©´ ë‹µì¥ ë°ì´í„° í¬í•¨
            if(currentReplyTarget) {
                payload.replyTo = currentReplyTarget;
            }
            await addDoc(collection(db, "chats"), payload); 
input.value = ""; 
        input.style.height = '45px'; // ì „ì†¡ í›„ ë†’ì´ ì´ˆê¸°í™” (ì´ ìœ„ì¹˜ê°€ ê°€ì¥ ì•ˆì „í•©ë‹ˆë‹¤)
        cancelReply();
        markAsRead(); 
        scrollToBottom(); 
    } catch (e) { alert("ì „ì†¡ ì‹¤íŒ¨"); } 
};
    window.uploadImage = async function(fileOrBlob, isDrawing = false) { 
        if (!fileOrBlob) return; 
        document.getElementById('loading').style.display = 'flex'; 
        try { 
            const fileName = Date.now() + (isDrawing ? '_draw.png' : '_' + fileOrBlob.name); 
            const storageRef = ref(storage, 'images/' + fileName); 
            await uploadBytes(storageRef, fileOrBlob); 
            const url = await getDownloadURL(storageRef); 
            
            const payload = { text: isDrawing ? "ê·¸ë¦¼ì„ ë³´ëƒˆìŠµë‹ˆë‹¤." : "ì‚¬ì§„ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.", imageUrl: url, sender: myName, timestamp: serverTimestamp(), type: 'image' };
            if(currentReplyTarget) { payload.replyTo = currentReplyTarget; }

            await addDoc(collection(db, "chats"), payload); 
            cancelReply();
            markAsRead(); scrollToBottom(); 
        } catch (e) { alert("ì „ì†¡ ì‹¤íŒ¨"); } finally { document.getElementById('loading').style.display = 'none'; document.getElementById('photo-input').value = ''; } 
    };

    // [ìˆ˜ì • ì™„ë£Œ] ìƒˆë¡œìš´ loadMessages í•¨ìˆ˜
 function loadMessages() {
    // ì‹¤ì‹œê°„ ê°ì‹œ ì‹œì‘ (ìµœê·¼ 30ê°œ)
    const q = query(collection(db, "chats"), orderBy("timestamp", "asc"), limitToLast(30));
    
    onSnapshot(q, (snapshot) => {
        const msgBox = document.getElementById('messages');
        
        // 1. ì´ˆê¸° ë¡œë”© ì‹œ ë ˆì´ì•„ì›ƒ ì´ˆê¸°í™”
        if (isInitialLoad) { 
            msgBox.innerHTML = '<div id="top-loading" style="display:none;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘... â³</div>'; 
            allImages = []; 
            lastPartnerMsgTime = 0; 
            lastPrintedDate = null; 
            if (snapshot.docs.length > 0) oldestMessageSnap = snapshot.docs[0];
        }

        // 2. ë³€ê²½ëœ ë¶€ë¶„ë§Œ ì²˜ë¦¬
        snapshot.docChanges().forEach((change) => {
            if (change.type === "added") {
                const data = change.doc.data();
                const docId = change.doc.id;

                // [ì¤‘ë³µ ë°©ì§€] ì´ë¯¸ í™”ë©´ì— ì¡´ì¬í•˜ëŠ” ë©”ì‹œì§€ë¼ë©´ ìŠ¤í‚µ (ì‹¤ì‹œê°„ ê°±ì‹  ì˜¤ë¥˜ ë°©ì§€)
                if (document.getElementById(`msg-${docId}`)) return;

                // 3. ë‚ ì§œ êµ¬ë¶„ì„  ì²˜ë¦¬
                const msgDateStr = getDateString(data.timestamp);
                if (msgDateStr && lastPrintedDate !== msgDateStr) {
                    const dateDividerHTML = `
                        <div class="date-divider">
                            <span>${msgDateStr}</span>
                        </div>`;
                    msgBox.insertAdjacentHTML('beforeend', dateDividerHTML);
                    lastPrintedDate = msgDateStr;
                }

                // 4. ì•Œë¦¼ ë¡œì§ (EXE ë° ìœˆë„ìš° ì•Œë¦¼)
                if (!isInitialLoad && data.sender !== myName) {
                    // EXE ì‘ì—…í‘œì‹œì¤„ ê¹œë¹¡ì„
                    if (window.electronAPI) {
                        window.electronAPI.triggerFlash();
                    }

                    // ì°½ì´ ê°€ë ¤ì ¸ ìˆì„ ë•Œë§Œ ì•Œë¦¼
                    if (document.hidden) {
                        startTabNotification();
                        if (localStorage.getItem('noti_enabled') !== 'false' && Notification.permission === "granted") {
                            let bodyText = (localStorage.getItem('noti_preview') !== 'false') 
                                ? (data.type === 'image' ? 'ì‚¬ì§„ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.' : data.text) 
                                : "ë¹„ë°€ ë©”ì‹œì§€ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤. ğŸ”’";
                            new Notification(`ğŸ’Œ ${data.sender}`, { body: bodyText, icon: 'https://cdn-icons-png.flaticon.com/512/2076/2076218.png' });
                        }
                    }
                }

                // 5. ë©”ì‹œì§€ í™”ë©´ì— ì¶”ê°€
                const msgHTML = createMessageHTML(data, docId);
                msgBox.insertAdjacentHTML('beforeend', msgHTML); 
                
                // ë°ì´í„° ë³´ê´€ ë° ì½ìŒ ì²˜ë¦¬ìš© ì‹œê°„ ì—…ë°ì´íŠ¸
                if(data.type === 'image') allImages.push(data.imageUrl);
                if(data.sender !== myName && data.timestamp) {
                    const time = data.timestamp.toMillis();
                    if(time > lastPartnerMsgTime) lastPartnerMsgTime = time;
                }
            }
        });

        // 6. ì´ˆê¸° ë¡œë”© ì™„ë£Œ ì²˜ë¦¬ ë° ìŠ¤í¬ë¡¤
        if (isInitialLoad) { 
            isInitialLoad = false; 
        }
        
        // ìƒˆ ë©”ì‹œì§€ê°€ ì˜¤ë©´ í•­ìƒ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
        scrollToBottom();
        updateReadStatus();
        updateGalleryPreview(); 
    });

    // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (í•œ ë²ˆë§Œ ë“±ë¡ë˜ë„ë¡ ì™¸ë¶€ í™•ì¸ í•„ìš” ì—†ìœ¼ë©´ ìœ ì§€)
const msgBox = document.getElementById('messages'); 
    msgBox.onscroll = () => {
        if (msgBox.scrollTop === 0 && !isFetchingOlder && oldestMessageSnap) { 
            loadMoreMessages(); 
        }
    };
} // loadMessages í•¨ìˆ˜ ë

    // [ìˆ˜ì • ì™„ë£Œ] loadMoreMessages í•¨ìˆ˜
    async function loadMoreMessages() {
        if (isFetchingOlder) return;
        isFetchingOlder = true;
        const topLoading = document.getElementById('top-loading');
        topLoading.style.display = 'block';
        
        const q = query(collection(db, "chats"), orderBy("timestamp", "desc"), startAfter(oldestMessageSnap), limit(30));
        const snapshot = await getDocs(q);
        
        if (!snapshot.empty) {
            const msgBox = document.getElementById('messages');
            const oldHeight = msgBox.scrollHeight;
            
            // ë¶ˆëŸ¬ì˜¨ ë°ì´í„°ë¥¼ ì‹œê°„ìˆœ(ê³¼ê±°->ë¯¸ë˜)ìœ¼ë¡œ ì •ë ¬
            const docs = snapshot.docs.reverse(); 
            oldestMessageSnap = docs[0]; 
            
            let html = "";
            let tempLastDate = null; // ì´ë²ˆ ë°°ì¹˜ ì•ˆì—ì„œ ë‚ ì§œ ì²´í¬ìš©

            // í˜„ì¬ í™”ë©´ì˜ ë§¨ ìœ„ì— ìˆëŠ” ë‚ ì§œ êµ¬ë¶„ì„ ì´ ìˆë‹¤ë©´ ë‚ ì§œë¥¼ ê°€ì ¸ì˜´ (ì¤‘ë³µ ë°©ì§€ìš©)
            const existingTopDivider = msgBox.querySelector('.date-divider');
            const existingTopDate = existingTopDivider ? existingTopDivider.innerText.trim() : null;

            docs.forEach(doc => { 
                const data = doc.data();
                const msgDateStr = getDateString(data.timestamp);

                // ì´ë²ˆ ë°°ì¹˜ ë‚´ì—ì„œ ë‚ ì§œê°€ ë°”ë€Œì—ˆìœ¼ë©´ êµ¬ë¶„ì„  ì¶”ê°€
                if (msgDateStr && tempLastDate !== msgDateStr) {
                    html += `<div class="date-divider"><span>${msgDateStr}</span></div>`;
                    tempLastDate = msgDateStr;
                }

                html += createMessageHTML(data, doc.id); 
                
                if(data.type === 'image') allImages.unshift(data.imageUrl); 
                if(data.sender !== myName && data.timestamp) {
                    const time = data.timestamp.toMillis();
                    if(time > lastPartnerMsgTime) lastPartnerMsgTime = time;
                }
            });

            // [ì¤‘ìš”] ìƒˆë¡œ ë¡œë”©í•œ ë§ˆì§€ë§‰ ë‚ ì§œì™€ ê¸°ì¡´ í™”ë©´ì˜ ì²« ë‚ ì§œê°€ ê°™ìœ¼ë©´
            // ê¸°ì¡´ í™”ë©´ ë§¨ ìœ„ì— ìˆë˜ êµ¬ë¶„ì„ ì€ ì¤‘ë³µì´ë¯€ë¡œ ì‚­ì œ
            if (tempLastDate === existingTopDate && existingTopDivider) {
                existingTopDivider.remove();
            }

            topLoading.insertAdjacentHTML('afterend', html);
            
            const newHeight = msgBox.scrollHeight;
            msgBox.scrollTop = newHeight - oldHeight;
            updateReadStatus(); 
        } else { 
            topLoading.innerText = "ëŒ€í™”ì˜ ì‹œì‘ì…ë‹ˆë‹¤."; 
        }
        
        topLoading.style.display = 'none';
        isFetchingOlder = false;
    }

    // ğŸ› ï¸ [ìˆ˜ì •ë¨] ë‹µì¥ ê¸°ëŠ¥ ë° HTML ìƒì„±
    // [5] ë©”ì‹œì§€ HTML ìƒì„± í•¨ìˆ˜ (ìˆ˜ì •ë¨)
function createMessageHTML(data, docId) {
    const isMe = data.sender === myName;
    const msgTime = data.timestamp ? data.timestamp.toMillis() : Date.now();
    const date = data.timestamp ? data.timestamp.toDate() : new Date();
    const timeStr = `${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
    
    let contentHtml = "";

    // A. í…ìŠ¤íŠ¸ì¼ ë•Œ
    if (!data.type || data.type === 'text') {
        contentHtml = linkify(data.text);
    } 
    // B. ì‚¬ì§„ì¼ ë•Œ
    else if (data.type === 'image') {
        contentHtml = `<img src="${data.imageUrl}" class="chat-img" onclick="window.open(this.src)">`;
    }
    // C. ìŠ¤í‹°ì»¤ì¼ ë•Œ (ì—¬ê¸°ê°€ í•µì‹¬!)
  else if (data.type === 'sticker') {
        const idx = data.stickerIndex || 0;
        const pIdx = data.packIndex || 0; // íŒ© ì •ë³´ê°€ ì—†ìœ¼ë©´ 0ë²ˆ(ê¸°ë³¸)ìœ¼ë¡œ ì²˜ë¦¬
        
        // í•´ë‹¹ íŒ©ì˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const pack = STICKER_PACKS[pIdx] || STICKER_PACKS[0]; 
        
        const col = idx % pack.cols;
        const row = Math.floor(idx / pack.cols);
        const unitSize = pack.totalWidth / pack.cols;
        
        // ì±„íŒ…ë°© í‘œì‹œ í¬ê¸° (128px)
        const displaySize = 128; 
        const scale = displaySize / unitSize;
        
        const bgW = pack.totalWidth * scale;
        const bgH = pack.totalHeight * scale;
        const bgX = -(col * displaySize);
        const bgY = -(row * displaySize);

        contentHtml = `
            <div class="sticker-msg" style="
                background-image: url('${pack.url}');
                background-size: ${bgW}px ${bgH}px;
                background-position: ${bgX}px ${bgY}px;
                width: 128px; height: 128px;
                background-color: transparent; /* âœ¨ ì—¬ê¸°ì„œë„ íˆ¬ëª… ë°°ê²½! */
            "></div>`;
    }

    // ë‹µì¥ í‘œì‹œ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
    const replyBlock = data.replyTo ? `
        <div class="quote-block" onclick="scrollToMessage('${data.replyTo.id}')">
            <span class="quote-sender">To. ${data.replyTo.sender}</span>
            <span class="quote-text">${data.replyTo.text}</span>
        </div>` : '';

    const unreadHtml = isMe ? `<span class="unread-mark">1</span>` : '';
    const rawText = (data.type === 'sticker' ? '(ì´ëª¨í‹°ì½˜)' : data.text).replace(/"/g, '&quot;');

    return `
        <div id="msg-${docId}" class="message ${isMe?'my-msg':'other-msg'}" data-text="${rawText}" data-timestamp="${msgTime}">
            ${replyBlock}
            ${contentHtml}
            <div class="msg-info">
                ${unreadHtml}
                ${!isMe?`<span class="sender">${data.sender}</span>`:''}
                <span class="time">${timeStr}</span>
                <span class="reply-btn" onclick="setReply('${docId}', '${rawText}', '${data.sender}')">â†©ï¸</span>
            </div>
        </div>`;
}

    function scrollToBottom() { const msgBox = document.getElementById('messages'); msgBox.scrollTop = msgBox.scrollHeight; }

    function updateGalleryPreview() {
        const previewGrid = document.getElementById('gallery-preview');
        const recentImages = allImages.slice(-3).reverse();
        previewGrid.innerHTML = recentImages.map(src => `<img src="${src}" class="gallery-item" onclick="window.open(this.src)">`).join('');
        if(recentImages.length === 0) previewGrid.innerHTML = '<span style="grid-column:span 3; text-align:center; color:#ccc; font-size:12px;">ì‚¬ì§„ ì—†ìŒ</span>';
    }

    window.openFullGallery = () => {
        showScreen('full-gallery-screen');
        if(document.getElementById('full-gallery-grid').children.length === 0) {
            loadGalleryImages();
        }
    };
    window.closeFullGallery = () => showScreen('settings-screen');

    async function loadGalleryImages() {
        if(isGalleryLoading || isGalleryEnd) return;
        isGalleryLoading = true;
        document.getElementById('gallery-loading').style.display = 'block';

        let q;
        if (galleryLastSnap) {
            q = query(collection(db, "chats"), where("type", "==", "image"), orderBy("timestamp", "desc"), startAfter(galleryLastSnap), limit(15));
        } else {
            q = query(collection(db, "chats"), where("type", "==", "image"), orderBy("timestamp", "desc"), limit(15));
        }

        const snapshot = await getDocs(q);
        const grid = document.getElementById('full-gallery-grid');

        if(snapshot.empty) {
            isGalleryEnd = true;
            document.getElementById('gallery-loading').innerText = "ëª¨ë“  ì‚¬ì§„ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.";
        } else {
            galleryLastSnap = snapshot.docs[snapshot.docs.length - 1];
            snapshot.forEach(doc => {
                const url = doc.data().imageUrl;
                grid.insertAdjacentHTML('beforeend', `<img src="${url}" class="gallery-item" onclick="window.open(this.src)">`);
            });
            document.getElementById('gallery-loading').style.display = 'none';
        }
        isGalleryLoading = false;
    }

    document.getElementById('full-gallery-screen').addEventListener('scroll', (e) => {
        const { scrollTop, scrollHeight, clientHeight } = e.target;
        if (scrollTop + clientHeight >= scrollHeight - 50) {
            loadGalleryImages();
        }
    });

    window.clearCache = () => {
        if(confirm("ìºì‹œë¥¼ ì‚­ì œí•˜ë©´ ìë™ ë¡œê·¸ì¸ ì •ë³´ê°€ ì§€ì›Œì§‘ë‹ˆë‹¤. ì§„í–‰í• ê¹Œìš”?")) {
            localStorage.clear();
            location.reload();
        }
    };

    window.requestDeleteHistory = async () => {
        if(!confirm("âš ï¸ ëª¨ë“  ëŒ€í™”ì™€ ì‚¬ì§„ì´ ì‚­ì œë©ë‹ˆë‹¤. ë³µêµ¬ ë¶ˆê°€!\n\në™ì˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ìƒëŒ€ë°©ë„ ë™ì˜í•´ì•¼ ìµœì¢… ì‚­ì œë©ë‹ˆë‹¤)")) return;

        try {
            await setDoc(deleteReqRef, { requestedBy: arrayUnion(myId) }, { merge: true });
            alert("ì‚­ì œ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤. ìƒëŒ€ë°©ë„ ë™ì˜í•˜ë©´ ì¦‰ì‹œ ì‚­ì œë©ë‹ˆë‹¤.");
        } catch(e) { console.error(e); alert("ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"); }
    };

    async function performFullDeletion() {
        try {
            const q = query(collection(db, "chats"));
            const snapshot = await getDocs(q);
            const batchSize = 500;
            let batch = writeBatch(db);
            let count = 0;

            for (const doc of snapshot.docs) {
                batch.delete(doc.ref);
                count++;
                if (count >= batchSize) { await batch.commit(); batch = writeBatch(db); count = 0; }
            }
            if (count > 0) await batch.commit();

            await setDoc(deleteReqRef, { requestedBy: [] });
            alert("ëª¨ë“  ë°ì´í„°ê°€ ì•ˆì „í•˜ê²Œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            location.reload();
        } catch(e) { console.error(e); alert("ì‚­ì œ ì‹¤íŒ¨"); location.reload(); }
    }

window.toggleSearch = () => { 
        const sb = document.getElementById('search-container'); 
        const input = document.getElementById('search-input');
        
        if (sb.style.display === 'block') { 
            // [ë‹«ê¸°] ë‹¤ì‹œ hiddenìœ¼ë¡œ ë³€ê²½í•˜ì—¬ í‚¤ë³´ë“œ íƒìƒ‰ì—ì„œ ì œì™¸
            input.setAttribute('type', 'hidden'); 
            sb.style.display = 'none'; 
            input.value = ''; 
            input.disabled = true; 
            filterMessages(); 
        } else { 
            // [ì—´ê¸°] textë¡œ ë³€ê²½í•˜ì—¬ ì…ë ¥ ê°€ëŠ¥í•˜ê²Œ ë§Œë“¦
            input.setAttribute('type', 'text'); 
            sb.style.display = 'block'; 
            input.disabled = false; 
            input.focus(); 
        }
    };
    
    window.filterMessages = () => { const q = document.getElementById('search-input').value.toLowerCase(); document.querySelectorAll('.message').forEach(msg => msg.style.display = (msg.getAttribute('data-text')||"").toLowerCase().includes(q)?'block':'none'); };
    window.openSettings = () => showScreen('settings-screen'); window.closeSettings = () => showScreen('chat-screen');
    window.changeBg = (c) => { localStorage.setItem('chat_bg', c); applyBg(c); }; function applyBg(c) { document.getElementById('messages').style.backgroundColor = c; }
    
    window.logout = () => { localStorage.removeItem('chat_nickname'); localStorage.removeItem('chat_auth_pw'); location.reload(); }

    if(localStorage.getItem('noti_enabled') === null) localStorage.setItem('noti_enabled', 'true');
    if(localStorage.getItem('noti_preview') === null) localStorage.setItem('noti_preview', 'true');
    document.getElementById('noti-enable').checked = localStorage.getItem('noti_enabled') !== 'false';
    document.getElementById('noti-preview').checked = localStorage.getItem('noti_preview') !== 'false';
    
    window.saveSettings = () => {
        localStorage.setItem('noti_enabled', document.getElementById('noti-enable').checked);
        localStorage.setItem('noti_preview', document.getElementById('noti-preview').checked);
    };

    window.triggerFileUpload = () => {
        const fileInput = document.getElementById('photo-input');
        fileInput.disabled = false; fileInput.click(); setTimeout(() => { fileInput.disabled = true; }, 1000); 
    };

    const canvas = document.getElementById('canvas-area');
    const ctx = canvas.getContext('2d');
    let isDrawing = false; let lastX = 0; let lastY = 0;
    
    function initCanvas() { ctx.fillStyle = "white"; ctx.fillRect(0, 0, canvas.width, canvas.height); ctx.lineWidth = 3; ctx.lineJoin = 'round'; ctx.lineCap = 'round'; ctx.strokeStyle = '#333'; }
    initCanvas();

    function draw(e) { if (!isDrawing) return; e.preventDefault(); let clientX = e.clientX || e.touches[0].clientX; let clientY = e.clientY || e.touches[0].clientY; const rect = canvas.getBoundingClientRect(); const x = clientX - rect.left; const y = clientY - rect.top; ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(x, y); ctx.stroke(); lastX = x; lastY = y; }
    canvas.addEventListener('mousedown', (e) => { isDrawing = true; lastX = e.offsetX; lastY = e.offsetY; }); canvas.addEventListener('mousemove', draw); canvas.addEventListener('mouseup', () => isDrawing = false); canvas.addEventListener('mouseout', () => isDrawing = false);
    canvas.addEventListener('touchstart', (e) => { isDrawing = true; const rect = canvas.getBoundingClientRect(); lastX = e.touches[0].clientX - rect.left; lastY = e.touches[0].clientY - rect.top; }); canvas.addEventListener('touchmove', draw); canvas.addEventListener('touchend', () => isDrawing = false);
    
    window.toggleDrawingPad = () => { const m = document.getElementById('drawing-modal'); if(m.style.display !== 'flex') { m.style.display = 'flex'; } else { m.style.display = 'none'; } };
    window.clearCanvas = () => initCanvas();
    window.sendDrawing = () => { canvas.toBlob((blob) => { if(blob) { uploadImage(blob, true); toggleDrawingPad(); initCanvas(); } }, 'image/png'); };

    // ğŸ“‹ [ê¸°ì¡´] ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸° ê¸°ëŠ¥ ìœ ì§€
    window.addEventListener('paste', (e) => {
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        for (let i = 0; i < items.length; i++) {
            if (items[i].kind === 'file' && items[i].type.includes('image/')) {
                const file = items[i].getAsFile();
                if(confirm("ğŸ“‹ í´ë¦½ë³´ë“œì— ìˆëŠ” ì´ë¯¸ì§€ë¥¼ ì „ì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { uploadImage(file); }
            }
        }
    });

// ==========================================
    // ğŸš€ [ì‹¤í–‰ ì‹œì‘]
    // ==========================================
    
    // â–¼â–¼â–¼ [ê¸°ì¡´ ì½”ë“œë¥¼ ì´ë ‡ê²Œ ê°ì‹¸ì£¼ì„¸ìš”] â–¼â–¼â–¼
    onAuthStateChanged(auth, (user) => {
        if (user) {
            // ë¡œê·¸ì¸ ëœ ìƒíƒœì¼ ë•Œë§Œ ì‹¤í–‰!
            console.log("âœ… ì¸ì¦ ì™„ë£Œ: ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.");

            const savedPasswordFinal = localStorage.getItem('chat_auth_pw');
            if (savedPasswordFinal === '0726') {
                if (myName) { 
                    showScreen('chat-screen'); 
                    loadMessages(); // ì´ì œ ì•ˆì „í•˜ê²Œ ì‹¤í–‰ë¨
                    startPresenceSystem(); 
                    monitorDeletionVotes();
                    window.requestNotiPermission(); 
                } 
                else { showScreen('name-screen'); }
            }
        } else {
            // ë¡œê·¸ì¸ì´ ì•ˆ ëœ ìƒíƒœ (ë³´í†µì€ ìë™ìœ¼ë¡œ signInAnonymouslyê°€ ì‹¤í–‰ë˜ë¯€ë¡œ ê¸°ë‹¤ë¦¬ë©´ ë¨)
            console.log("â³ ë¡œê·¸ì¸ ëŒ€ê¸° ì¤‘...");
        }
    });

// [ì¶”ê°€] ì…ë ¥ì°½ ìë™ ë†’ì´ ì¡°ì ˆ ë° ì—”í„°í‚¤ ì „ì†¡ ì„¤ì •
const msgInputBox = document.getElementById('msg-input');

// 1. ìë™ ë†’ì´ ì¡°ì ˆ (input ì´ë²¤íŠ¸)
msgInputBox.addEventListener('input', function() {
    this.style.height = '45px'; // ì´ˆê¸°í™”
    let newHeight = this.scrollHeight;
    if (newHeight > 90) newHeight = 90; // ìµœëŒ€ 3ì¤„ ì œí•œ
    this.style.height = newHeight + 'px';
});

// 2. ì—”í„°í‚¤ ì „ì†¡ ì„¤ì • (keydown ì´ë²¤íŠ¸)
msgInputBox.addEventListener('keydown', function(e) {
    // í•œê¸€ ì…ë ¥ ì‹œ ë§ˆì§€ë§‰ ê¸€ì ì¤‘ë³µ ì „ì†¡ ë°©ì§€
    if (e.isComposing) return;

    if (e.key === 'Enter') {
        if (!e.shiftKey) { 
            // Shift ì—†ì´ Enterë§Œ ëˆ„ë¥¸ ê²½ìš°
            e.preventDefault(); // ì¤‘ìš”: ê¸°ë³¸ ì¤„ë°”ê¿ˆ ë™ì‘ì„ ë§‰ìŒ
            window.sendMessage(); // ì „ì†¡ í•¨ìˆ˜ í˜¸ì¶œ
            
            // ì „ì†¡ í›„ ë†’ì´ì™€ ë‚´ìš© ì´ˆê¸°í™”ëŠ” sendMessage ì•ˆì—ì„œ ì²˜ë¦¬ë˜ì§€ë§Œ, ì—¬ê¸°ì„œë„ í•œ ë²ˆ ë” ë³´ì •
            this.style.height = '45px';
        } 
        // Shift + Enterì¸ ê²½ìš°ì—ëŠ” ì—¬ê¸°ì„œ ì•„ë¬´ê²ƒë„ ì•ˆ í•¨ (ê¸°ë³¸ ì¤„ë°”ê¿ˆ í—ˆìš©)
    }
});// ==========================================
    // ğŸ“¢ [ì¶”ê°€] ì—…ë°ì´íŠ¸ íŒì—… ë¡œì§
    // ==========================================
    const CURRENT_VERSION = "1.8"; // ğŸ‘ˆ [ì¤‘ìš”] íŒ¨ì¹˜í•  ë•Œë§ˆë‹¤ ì´ ìˆ«ìë¥¼ ë°”ê¾¸ì„¸ìš”!

    window.checkUpdatePopup = function() {
        const savedVersion = localStorage.getItem('seen_version');
        
        // ì €ì¥ëœ ë²„ì „ê³¼ í˜„ì¬ ë²„ì „ì´ ë‹¤ë¥´ë©´ íŒì—… ë„ì›€
        if (savedVersion !== CURRENT_VERSION) {
            document.getElementById('update-modal').style.display = 'flex';
        }
    };

    window.closeUpdatePopup = function() {
        // ë‹«ê¸° ë²„íŠ¼ ëˆ„ë¥´ë©´ í˜„ì¬ ë²„ì „ì„ ì €ì¥í•¨ (ë‹¤ìŒì— ì•ˆ ëœ¨ê²Œ)
        localStorage.setItem('seen_version', CURRENT_VERSION);
        document.getElementById('update-modal').style.display = 'none';
    };

    // ì‹œì‘í•˜ìë§ˆì ì²´í¬ ì‹¤í–‰
    checkUpdatePopup();
</script>
</body>
</html>