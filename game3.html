<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Casino Lobby</title>
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="manifest" href="manifest.json">
    <style>
        body { 
            font-family: 'Apple SD Gothic Neo', sans-serif; 
            background-color: #2c3e50; color: white; margin: 0; 
            display: flex; flex-direction: column; align-items: center; 
            min-height: 100vh; overflow-y: auto; 
        }
        
        .container { width: 90%; max-width: 450px; padding: 20px 0; display: flex; flex-direction: column; gap: 15px; }

        /* í—¤ë” (ë‚´ ì§€ê°‘) */
        .wallet-card {
            background: linear-gradient(135deg, #f1c40f, #d35400);
            padding: 20px; border-radius: 20px; text-align: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3); position: relative;
        }
        .wallet-label { font-size: 14px; opacity: 0.8; margin-bottom: 5px; }
        .wallet-balance { font-size: 32px; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        
        /* ë²„íŠ¼ ê·¸ë£¹ */
        .wallet-btns { display: flex; justify-content: center; gap: 10px; margin-top: 15px; }
        .btn-wallet {
            border: 1px solid white; color: white;
            padding: 8px 15px; border-radius: 15px; font-size: 13px; cursor: pointer;
            transition: 0.2s; background: rgba(255,255,255,0.1); font-weight: bold;
        }
        .btn-wallet:hover { background: rgba(255,255,255,0.3); }
        .btn-gift { background: rgba(52, 152, 219, 0.4); border-color: #3498db; }

        /* ê²Œì„ ë©”ë‰´ */
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .menu-item {
            background: #34495e; padding: 20px; border-radius: 15px; 
            text-align: center; cursor: pointer; transition: 0.2s; text-decoration: none; color: white;
            box-shadow: 0 5px 0 #2c3e50; border: 1px solid #465f75;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .menu-item:active { transform: translateY(5px); box-shadow: none; }
        .menu-icon { font-size: 40px; display: block; margin-bottom: 10px; }
        .menu-title { font-weight: bold; font-size: 16px; }

        /* ë­í‚¹ */
        .rank-panel { background: white; color: #333; border-radius: 15px; padding: 15px; }
        .rank-header { font-weight: bold; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; }
        .rank-list { display: flex; flex-direction: column; gap: 8px; }
        .rank-row { display: flex; justify-content: space-between; font-size: 14px; }
        .rank-name { font-weight: bold; }
        .rank-coin { color: #d35400; }
        
        .back-btn { margin-top: 20px; color: #aaa; text-decoration: underline; cursor: pointer; text-align: center; display: block; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center; margin:0;">ğŸ° CASINO LOBBY</h2>
    
 <div class="wallet-card">
        <div class="wallet-label">
            MY WALLET <span id="my-code" style="font-size:12px; color:#eee; background:rgba(0,0,0,0.2); padding:2px 6px; border-radius:4px; margin-left:5px;">#????</span>
        </div>
        <div class="wallet-balance" id="my-coin">0 ğŸ’°</div>
        
        <div class="wallet-btns">
            <button class="btn-wallet" onclick="chargeCoin()">ğŸ’¸ ë¬´ë£Œ ì¶©ì „</button>
            <button class="btn-wallet btn-gift" onclick="sendGift()">ğŸ ì„ ë¬¼í•˜ê¸°</button>
        </div>
    </div>

    <div class="menu-grid">
        <a href="game3-1.html" class="menu-item">
            <span class="menu-icon">ğŸ</span>
            <span class="menu-title">ê²½ë§ˆ (Derby)</span>
        </a>

        <a href="game3-2.html" class="menu-item">
            <span class="menu-icon">ğŸ²</span>
            <span class="menu-title">í™€ì§ (Hol-Jjak)</span>
        </a>

        <a href="game3-3.html" class="menu-item">
            <span class="menu-icon">ğŸƒ</span>
            <span class="menu-title">í•˜ì´ë¡œìš° (Hi-Lo)</span>
        </a>

        <a href="game3-4.html" class="menu-item">
            <span class="menu-icon">ğŸ’</span>
            <span class="menu-title">ìŠ¬ë¡¯ë¨¸ì‹  (Slots)</span>
        </a>

        <div class="menu-item" style="opacity:0.5; cursor:not-allowed;">
            <span class="menu-icon">ğŸš§</span>
            <span class="menu-title">ì¤€ë¹„ ì¤‘...</span>
        </div>
    </div>

    <div class="rank-panel">
        <div class="rank-header"><span>ğŸ† ë¶€ì ë­í‚¹ (0ì› ì œì™¸)</span><span>ë³´ìœ  ìì‚°</span></div>
        <div id="rank-list" class="rank-list">ë¡œë”© ì¤‘...</div>
    </div>

    <a href="gamelist.html" class="back-btn">ì˜¤ë½ì‹¤ë¡œ ëŒì•„ê°€ê¸°</a>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, where, getDocs, orderBy, onSnapshot, increment } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ğŸ”´ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDTMfB6Fl6QiiJdcTjpcU9nha2GP4Ne_6o",
      authDomain: "lovechatproject-2db11.firebaseapp.com",
      projectId: "lovechatproject-2db11",
      storageBucket: "lovechatproject-2db11.firebasestorage.app",
      messagingSenderId: "1069136590072",
      appId: "1:1069136590072:web:7712e718db03c70bff370d",
      measurementId: "G-ERG2LL283F"
    };

   const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    let myId = localStorage.getItem('chat_uid');
    let myName = localStorage.getItem('chat_nickname') || "ìµëª…";
    if(!myId) { myId = 'user_' + Date.now(); localStorage.setItem('chat_uid', myId); }

    const userRef = doc(db, "users", myId);
    let myCurrentCoins = 0;

    // 1. ë‚´ ì •ë³´ ì´ˆê¸°í™” ë° ë¡œë“œ (ìˆ˜ì •ë¨: ê³ ìœ  ì½”ë“œ í‘œì‹œ)
    async function initUser() {
        // ë‚´ ê³ ìœ  ì½”ë“œ(ID ë’· 4ìë¦¬) í‘œì‹œ
        const shortCode = "#" + myId.slice(-4).toUpperCase();
        document.getElementById('my-code').innerText = shortCode;

        const snap = await getDoc(userRef);
        if (!snap.exists()) {
            await setDoc(userRef, {
                name: myName,
                coins: 10000,
                lastLogin: new Date()
            });
        } else {
            if(snap.data().name !== myName) updateDoc(userRef, { name: myName });
        }

        onSnapshot(userRef, (doc) => {
            if(doc.exists()) {
                myCurrentCoins = doc.data().coins || 0;
                document.getElementById('my-coin').innerText = myCurrentCoins.toLocaleString() + " ğŸ’°";
            }
        });
    }

    // 2. ì „ì²´ ë­í‚¹ ë¡œë“œ (ê¸°ì¡´ê³¼ ë™ì¼)
    function loadRanking() {
        const q = query(collection(db, "users"), orderBy("coins", "desc"));
        onSnapshot(q, (snapshot) => {
            const list = document.getElementById('rank-list');
            list.innerHTML = "";
            let rank = 1;
            
            snapshot.forEach(doc => {
                const d = doc.data();
                if (d.coins <= 0) return; // 0ì› ì´í•˜ ìˆ¨ê¹€

                const isMe = doc.id === myId ? " (ë‚˜)" : "";
                list.innerHTML += `
                    <div class="rank-row" style="${isMe ? 'color:#d35400;font-weight:bold;' : ''}">
                        <span class="rank-name">${rank}. ${d.name}${isMe}</span>
                        <span class="rank-coin">${d.coins.toLocaleString()}</span>
                    </div>
                `;
                rank++;
            });
            if(list.innerHTML === "") list.innerHTML = "<div style='text-align:center; color:#999;'>ë¶€ìê°€ ì—†ìŠµë‹ˆë‹¤...</div>";
        });
    }

    // 3. ë¬´ë£Œ ì¶©ì „ì†Œ (ê¸°ì¡´ê³¼ ë™ì¼)
    window.chargeCoin = async () => {
        const snap = await getDoc(userRef);
        if(snap.exists() && snap.data().coins < 1000) {
            await updateDoc(userRef, { coins: increment(1000) });
            alert("1,000 ì½”ì¸ì´ ì¶©ì „ë˜ì—ˆìŠµë‹ˆë‹¤! (íŒŒì‚° êµ¬ì¡°ëŒ€ ë„ì°© ğŸš‘)");
        } else {
            alert("ì½”ì¸ì´ 1,000ì› ë¯¸ë§Œì¼ ë•Œë§Œ ì¶©ì „ ê°€ëŠ¥í•©ë‹ˆë‹¤! ğŸ˜…");
        }
    };

    // 4. [ìˆ˜ì •ë¨] ì„ ë¬¼í•˜ê¸° ê¸°ëŠ¥ (ë™ëª…ì´ì¸ ì²˜ë¦¬ ì¶”ê°€)
    window.sendGift = async () => {
        const targetName = prompt("ëˆ„êµ¬ì—ê²Œ ì½”ì¸ì„ ë³´ë‚¼ê¹Œìš”?\n(ë°›ëŠ” ì‚¬ëŒì˜ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”)");
        if(!targetName) return;
        if(targetName === myName) return alert("ìì‹ ì—ê²ŒëŠ” ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

        const amountStr = prompt("ì–¼ë§ˆë¥¼ ë³´ë‚¼ê¹Œìš”?");
        const amount = parseInt(amountStr);

        if(!amount || amount <= 0) return alert("ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        if(amount > myCurrentCoins) return alert("ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");

        // ë°›ëŠ” ì‚¬ëŒ ê²€ìƒ‰
        const usersRef = collection(db, "users");
        const q = query(usersRef, where("name", "==", targetName));
        const querySnapshot = await getDocs(q);

        // ê²€ìƒ‰ ê²°ê³¼ í•„í„°ë§ (ë‚˜ ìì‹  ì œì™¸)
        let candidates = [];
        querySnapshot.forEach((doc) => {
            if(doc.id !== myId) {
                candidates.push({ id: doc.id, ...doc.data() });
            }
        });

        if(candidates.length === 0) {
            alert(`'${targetName}' ë‹˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
            return;
        }

        let targetUser = null;

        // [í•µì‹¬] ë™ëª…ì´ì¸ ì²˜ë¦¬
        if (candidates.length === 1) {
            // 1ëª…ë¿ì´ë©´ ë°”ë¡œ ì„ íƒ
            targetUser = candidates[0];
        } else {
            // ì—¬ëŸ¬ ëª…ì´ë©´ ì„ íƒì°½ ë„ìš°ê¸°
            let msg = `['${targetName}']ë‹˜ì´ ${candidates.length}ëª… ê²€ìƒ‰ë˜ì—ˆìŠµë‹ˆë‹¤.\në²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì„ íƒí•´ì£¼ì„¸ìš”:\n\n`;
            
            candidates.forEach((user, index) => {
                const shortCode = "#" + user.id.slice(-4).toUpperCase();
                msg += `[${index + 1}] ${user.name} (ID: ${shortCode})\n`;
            });

            const choiceStr = prompt(msg);
            const choice = parseInt(choiceStr);

            if (!choice || choice < 1 || choice > candidates.length) {
                return alert("ì˜ëª»ëœ ì„ íƒì…ë‹ˆë‹¤. ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
            targetUser = candidates[choice - 1];
        }

        // ìµœì¢… í™•ì¸ ë° ì „ì†¡
        const targetCode = "#" + targetUser.id.slice(-4).toUpperCase();
        if(confirm(`${targetUser.name} (${targetCode})ë‹˜ì—ê²Œ\n${amount.toLocaleString()} ì½”ì¸ì„ ë³´ë‚´ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            try {
                // ë‚´ ëˆ ì°¨ê°
                await updateDoc(userRef, { coins: increment(-amount) });
                // ìƒëŒ€ ëˆ ì¶”ê°€
                const targetRef = doc(db, "users", targetUser.id);
                await updateDoc(targetRef, { coins: increment(amount) });
                
                alert("ì´ì²´ ì™„ë£Œ! ğŸ’¸");
            } catch(e) {
                console.error(e);
                alert("ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }
    };

    initUser();
    loadRanking();
</script>
</body>
</html>