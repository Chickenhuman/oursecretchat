<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Casino Lobby</title>
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" href="icon.png">
    <link rel="manifest" href="manifest.json">
    <style>
        body { 
            font-family: 'Apple SD Gothic Neo', sans-serif; 
            background-color: #2c3e50; color: white; margin: 0; 
            display: flex; flex-direction: column; align-items: center; 
            min-height: 100vh; overflow-y: auto; 
        }
        
        .container { width: 90%; max-width: 450px; padding: 20px 0; display: flex; flex-direction: column; gap: 15px; }

        /* í—¤ë” (ë‚´ ì§€ê°‘) */
        .wallet-card {
            background: linear-gradient(135deg, #f1c40f, #d35400);
            padding: 20px; border-radius: 20px; text-align: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3); position: relative;
        }
        .wallet-label { font-size: 14px; opacity: 0.8; margin-bottom: 5px; }
        .wallet-balance { font-size: 32px; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        .btn-charge {
            background: rgba(255,255,255,0.2); border: 1px solid white; color: white;
            padding: 5px 15px; border-radius: 15px; font-size: 12px; cursor: pointer;
            margin-top: 10px; transition: 0.2s;
        }
        .btn-charge:hover { background: rgba(255,255,255,0.4); }

        /* ê²Œì„ ë©”ë‰´ */
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .menu-item {
            background: #34495e; padding: 20px; border-radius: 15px; 
            text-align: center; cursor: pointer; transition: 0.2s; text-decoration: none; color: white;
            box-shadow: 0 5px 0 #2c3e50; border: 1px solid #465f75;
        }
        .menu-item:active { transform: translateY(5px); box-shadow: none; }
        .menu-icon { font-size: 40px; display: block; margin-bottom: 10px; }
        .menu-title { font-weight: bold; font-size: 16px; }

        /* ë­í‚¹ */
        .rank-panel { background: white; color: #333; border-radius: 15px; padding: 15px; }
        .rank-header { font-weight: bold; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; }
        .rank-list { display: flex; flex-direction: column; gap: 8px; }
        .rank-row { display: flex; justify-content: space-between; font-size: 14px; }
        .rank-name { font-weight: bold; }
        .rank-coin { color: #d35400; }
        
        .back-btn { margin-top: 20px; color: #aaa; text-decoration: underline; cursor: pointer; text-align: center; display: block; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center; margin:0;">ğŸ° CASINO LOBBY</h2>
    
    <div class="wallet-card">
        <div class="wallet-label">MY WALLET</div>
        <div class="wallet-balance" id="my-coin">0 ğŸ’°</div>
        <button class="btn-charge" onclick="chargeCoin()">ğŸ’¸ ë¬´ë£Œ ì¶©ì „ì†Œ (+1,000)</button>
    </div>

    <div class="menu-grid">
        <a href="game3-1.html" class="menu-item">
            <span class="menu-icon">ğŸ</span>
            <span class="menu-title">ê²½ë§ˆ (Derby)</span>
        </a>
        <div class="menu-item" style="opacity:0.5; cursor:not-allowed;">
            <span class="menu-icon">ğŸƒ</span>
            <span class="menu-title">ì¤€ë¹„ ì¤‘...</span>
        </div>
    </div>

    <div class="rank-panel">
        <div class="rank-header"><span>ğŸ† ë¶€ì ë­í‚¹</span><span>ë³´ìœ  ìì‚°</span></div>
        <div id="rank-list" class="rank-list">ë¡œë”© ì¤‘...</div>
    </div>

    <a href="gamelist.html" class="back-btn">ì˜¤ë½ì‹¤ë¡œ ëŒì•„ê°€ê¸°</a>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, orderBy, onSnapshot, increment } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ğŸ”´ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDTMfB6Fl6QiiJdcTjpcU9nha2GP4Ne_6o",
      authDomain: "lovechatproject-2db11.firebaseapp.com",
      projectId: "lovechatproject-2db11",
      storageBucket: "lovechatproject-2db11.firebasestorage.app",
      messagingSenderId: "1069136590072",
      appId: "1:1069136590072:web:7712e718db03c70bff370d",
      measurementId: "G-ERG2LL283F"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    let myId = localStorage.getItem('chat_uid');
    let myName = localStorage.getItem('chat_nickname') || "ìµëª…";
    if(!myId) { myId = 'user_' + Date.now(); localStorage.setItem('chat_uid', myId); }

    const userRef = doc(db, "users", myId);

    // 1. ë‚´ ì •ë³´ ì´ˆê¸°í™” ë° ë¡œë“œ
    async function initUser() {
        const snap = await getDoc(userRef);
        if (!snap.exists()) {
            // ì²« ë°©ë¬¸ ì‹œ 10,000 ì½”ì¸ ì§€ê¸‰
            await setDoc(userRef, {
                name: myName,
                coins: 10000,
                lastLogin: new Date()
            });
        } else {
            // ì´ë¦„ ë™ê¸°í™”
            if(snap.data().name !== myName) updateDoc(userRef, { name: myName });
        }

        // ì‹¤ì‹œê°„ ì”ì•¡ ê°ì‹œ
        onSnapshot(userRef, (doc) => {
            if(doc.exists()) {
                const coins = doc.data().coins || 0;
                document.getElementById('my-coin').innerText = coins.toLocaleString() + " ğŸ’°";
            }
        });
    }

    // 2. ì „ì²´ ë­í‚¹ ë¡œë“œ
    function loadRanking() {
        const q = query(collection(db, "users"), orderBy("coins", "desc"));
        onSnapshot(q, (snapshot) => {
            const list = document.getElementById('rank-list');
            list.innerHTML = "";
            let rank = 1;
            snapshot.forEach(doc => {
                const d = doc.data();
                const isMe = doc.id === myId ? " (ë‚˜)" : "";
                list.innerHTML += `
                    <div class="rank-row" style="${isMe ? 'color:#d35400;font-weight:bold;' : ''}">
                        <span class="rank-name">${rank}. ${d.name}${isMe}</span>
                        <span class="rank-coin">${d.coins.toLocaleString()}</span>
                    </div>
                `;
                rank++;
            });
        });
    }

    // 3. ë¬´ë£Œ ì¶©ì „ì†Œ
    window.chargeCoin = async () => {
        const snap = await getDoc(userRef);
        if(snap.exists() && snap.data().coins < 1000) {
            await updateDoc(userRef, { coins: increment(1000) });
            alert("1,000 ì½”ì¸ì´ ì¶©ì „ë˜ì—ˆìŠµë‹ˆë‹¤! (íŒŒì‚° êµ¬ì¡°ëŒ€ ë„ì°© ğŸš‘)");
        } else {
            alert("ì½”ì¸ì´ 1,000ì› ë¯¸ë§Œì¼ ë•Œë§Œ ì¶©ì „ ê°€ëŠ¥í•©ë‹ˆë‹¤! ğŸ˜…");
        }
    };

    initUser();
    loadRanking();
</script>
</body>
</html>