<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flex Shop</title>
    <style>
        body { 
            font-family: 'Apple SD Gothic Neo', sans-serif; 
            background-color: #1a1a1a; color: white; margin: 0; 
            display: flex; flex-direction: column; align-items: center; 
            min-height: 100vh; overflow-y: auto; padding-bottom: 30px;
        }

        .container { width: 90%; max-width: 450px; padding: 20px 0; }

        .header {
            text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 15px;
        }
        .shop-title { font-size: 24px; font-weight: bold; color: #f1c40f; text-shadow: 0 0 10px rgba(241, 196, 15, 0.5); }
        .my-wallet { background: #333; padding: 10px; border-radius: 10px; margin-top: 10px; font-weight: bold; }
        .coin-val { color: #2ecc71; font-size: 18px; }

        /* ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .section-title { font-size: 18px; font-weight: bold; margin: 20px 0 10px 0; border-left: 4px solid #e74c3c; padding-left: 10px; }
        
        .item-list { display: grid; grid-template-columns: 1fr; gap: 10px; }
        
        .shop-item {
            background: #2c2c2c; padding: 15px; border-radius: 12px;
            display: flex; align-items: center; justify-content: space-between;
            border: 1px solid #444; transition: 0.2s;
        }
        .shop-item:hover { border-color: #f1c40f; transform: translateY(-2px); }

        .item-info { display: flex; align-items: center; gap: 15px; }
        .item-icon { font-size: 30px; width: 40px; text-align: center; }
        .item-text h4 { margin: 0; font-size: 16px; }
        .item-text p { margin: 4px 0 0 0; font-size: 12px; color: #aaa; }

        .btn-buy {
            background: #f1c40f; color: #111; border: none; padding: 8px 12px;
            border-radius: 8px; font-weight: bold; cursor: pointer; min-width: 80px;
        }
        .btn-buy:disabled { background: #555; color: #888; cursor: not-allowed; }
        
        /* ì¹­í˜¸ ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
        .title-badge { 
            background: #333; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px; margin-right: 5px; 
            border: 1px solid #555;
        }

        .btn-back { margin-top: 30px; width: 100%; padding: 15px; background: #555; border: none; color: white; border-radius: 10px; font-weight: bold; cursor: pointer; }

    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="shop-title">ğŸ’ FLEX SHOP</div>
        <div class="my-wallet">ë‚´ ì§€ê°‘: <span id="my-coin" class="coin-val">0</span></div>
    </div>

    <div class="section-title">âš¡ ëŠ¥ë ¥ ê°•í™” (ì˜êµ¬ ì§€ì†)</div>
    <div class="item-list">
        <div class="shop-item">
            <div class="item-info">
                <div class="item-icon">ğŸ›¡ï¸</div>
                <div class="item-text">
                    <h4>íŒŒì‚° ë©´ì±…ê¶Œ (Gold)</h4>
                    <p>ë¬´ë£Œ ì¶©ì „ ê¸ˆì•¡ì´ <b>10,000ì›</b>ìœ¼ë¡œ ì¦ê°€í•©ë‹ˆë‹¤.</p>
                </div>
            </div>
            <button id="btn-upgrade-1" class="btn-buy" onclick="buyUpgrade('chargeLevel', 1, 100000)">
                10ë§Œ
            </button>
        </div>
    </div>

    <div class="section-title">ğŸ‘‘ ì¹­í˜¸ ìƒì  (ë­í‚¹ì— í‘œì‹œë¨)</div>
    <div class="item-list" id="title-list">
        </div>

    <button class="btn-back" onclick="location.href='game3.html'">ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, increment } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDTMfB6Fl6QiiJdcTjpcU9nha2GP4Ne_6o",
      authDomain: "lovechatproject-2db11.firebaseapp.com",
      projectId: "lovechatproject-2db11",
      storageBucket: "lovechatproject-2db11.firebasestorage.app",
      messagingSenderId: "1069136590072",
      appId: "1:1069136590072:web:7712e718db03c70bff370d",
      measurementId: "G-ERG2LL283F"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let myId = localStorage.getItem('chat_uid');
    const userRef = doc(db, "users", myId);

    let myCoins = 0;
    let myData = {};

    // ì¹­í˜¸ ëª©ë¡ ë°ì´í„°
    const TITLE_ITEMS = [
        { id: 'title_rich', name: 'ğŸ’° [ê¸ˆìˆ˜ì €]', price: 50000 },
        { id: 'title_tazza', name: 'ğŸ´ [íƒ€ì§œ]', price: 100000 },
        { id: 'title_god', name: 'ğŸ‘‘ [ë„ë°•ì˜ì‹ ]', price: 500000 },
        { id: 'title_sloth', name: 'ğŸ¦¥ [ë‚˜ë¬´ëŠ˜ë³´]', price: 10000 },
        { id: 'title_lover', name: 'â¤ï¸ [ì‚¬ë‘ê¾¼]', price: 30000 }
    ];

    async function init() {
        const snap = await getDoc(userRef);
        if(snap.exists()) {
            myData = snap.data();
            myCoins = myData.coins || 0;
            updateUI();
        } else {
            alert("ë¡œê·¸ì¸ ì •ë³´ ì—†ìŒ");
            location.href = 'game3.html';
        }
    }

    function updateUI() {
        document.getElementById('my-coin').innerText = myCoins.toLocaleString();

        // 1. ì—…ê·¸ë ˆì´ë“œ ë²„íŠ¼ ìƒíƒœ í™•ì¸
        const chargeLvl = myData.chargeLevel || 0;
        const btnUp = document.getElementById('btn-upgrade-1');
        if(chargeLvl >= 1) {
            btnUp.innerText = "êµ¬ë§¤ì™„ë£Œ";
            btnUp.disabled = true;
            btnUp.style.background = "#2ecc71"; // ì´ˆë¡ìƒ‰
        }

        // 2. ì¹­í˜¸ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
        const titleListEl = document.getElementById('title-list');
        titleListEl.innerHTML = "";
        
        const myTitles = myData.ownedTitles || []; // ë‚´ê°€ ê°€ì§„ ì¹­í˜¸ ë°°ì—´ (ID ë¬¸ìì—´)
        const currentTitle = myData.equippedTitle || ""; // í˜„ì¬ ì¥ì°© ì¤‘ì¸ ì¹­í˜¸

        TITLE_ITEMS.forEach(item => {
            const isOwned = myTitles.includes(item.id);
            const isEquipped = currentTitle === item.name;
            
            let btnHtml = "";
            if (isEquipped) {
                btnHtml = `<button class="btn-buy" disabled style="background:#2ecc71; color:white;">ì¥ì°©ì¤‘</button>`;
            } else if (isOwned) {
                btnHtml = `<button class="btn-buy" onclick="equipTitle('${item.name}')" style="background:#3498db; color:white;">ì¥ì°©í•˜ê¸°</button>`;
            } else {
                btnHtml = `<button class="btn-buy" onclick="buyTitle('${item.id}', '${item.name}', ${item.price})">${item.price/10000}ë§Œ</button>`;
            }

            const div = document.createElement('div');
            div.className = 'shop-item';
            div.innerHTML = `
                <div class="item-info">
                    <div class="item-icon">ğŸ·ï¸</div>
                    <div class="item-text">
                        <h4>${item.name}</h4>
                        <p>${isOwned ? 'ë³´ìœ  ì¤‘' : 'êµ¬ë§¤í•˜ì—¬ ë‹‰ë„¤ì„ì„ ê¾¸ë¯¸ì„¸ìš”'}</p>
                    </div>
                </div>
                ${btnHtml}
            `;
            titleListEl.appendChild(div);
        });
        
        // ì¹­í˜¸ í•´ì œ ë²„íŠ¼ (í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´)
        if(myTitles.length > 0 && currentTitle) {
            const div = document.createElement('div');
            div.className = 'shop-item';
            div.innerHTML = `
                <div class="item-info"><div class="item-icon">ğŸš«</div><div class="item-text"><h4>ì¹­í˜¸ í•´ì œ</h4><p>ì›ë˜ ì´ë¦„ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤</p></div></div>
                <button class="btn-buy" onclick="equipTitle('')" style="background:#555; color:white;">í•´ì œ</button>
            `;
            titleListEl.appendChild(div);
        }
    }

    // [ê¸°ëŠ¥ 1] ì—…ê·¸ë ˆì´ë“œ êµ¬ë§¤
    window.buyUpgrade = async (field, level, price) => {
        if(myCoins < price) return alert("ëˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤!");
        if(!confirm("íŒŒì‚° ë©´ì±…ê¶Œì„ êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì´ì œ ë¬´ë£Œ ì¶©ì „ì‹œ 10,000ì›ì„ ë°›ìŠµë‹ˆë‹¤)")) return;

        try {
            await updateDoc(userRef, {
                coins: increment(-price),
                [field]: level // chargeLevel: 1 ì €ì¥
            });
            alert("êµ¬ë§¤ ì„±ê³µ! ëŠ¥ë ¥ì´ ê°•í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
            location.reload();
        } catch(e) { alert("ì˜¤ë¥˜ ë°œìƒ"); }
    };

    // [ê¸°ëŠ¥ 2] ì¹­í˜¸ êµ¬ë§¤
    window.buyTitle = async (id, name, price) => {
        if(myCoins < price) return alert("ëˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤!");
        if(!confirm(`'${name}' ì¹­í˜¸ë¥¼ êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        try {
            // Firestore ë°°ì—´ì— ì¶”ê°€ (arrayUnionì´ ì¢‹ì§€ë§Œ ê°„ë‹¨íˆ ì²˜ë¦¬)
            let newTitles = myData.ownedTitles || [];
            newTitles.push(id);

            await updateDoc(userRef, {
                coins: increment(-price),
                ownedTitles: newTitles
            });
            alert("êµ¬ë§¤ ì„±ê³µ! [ì¥ì°©í•˜ê¸°] ë²„íŠ¼ì„ ëˆŒëŸ¬ ì ìš©í•˜ì„¸ìš”.");
            location.reload();
        } catch(e) { console.error(e); alert("ì˜¤ë¥˜ ë°œìƒ"); }
    };

    // [ê¸°ëŠ¥ 3] ì¹­í˜¸ ì¥ì°©
    window.equipTitle = async (titleStr) => {
        try {
            // í˜„ì¬ ì´ë¦„ì—ì„œ ì¹­í˜¸ ë¶€ë¶„ë§Œ êµì²´í•˜ëŠ” ê²Œ ì•„ë‹ˆë¼,
            // 'equippedTitle' í•„ë“œë¥¼ ë”°ë¡œ ë‘ê³  ë­í‚¹ì´ë‚˜ ë¡œë¹„ì—ì„œ ì¡°í•©í•´ì„œ ë³´ì—¬ì£¼ëŠ” ë°©ì‹ì´ ì•ˆì „í•¨.
            // í•˜ì§€ë§Œ ì—¬ê¸°ì„  ê°„ë‹¨íˆ DBì— 'equippedTitle' í•„ë“œë¥¼ ì €ì¥.
            await updateDoc(userRef, {
                equippedTitle: titleStr
            });
            alert(titleStr ? "ì¹­í˜¸ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!" : "ì¹­í˜¸ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            location.reload();
        } catch(e) { console.error(e); }
    };

    init();
</script>
</body>
</html>