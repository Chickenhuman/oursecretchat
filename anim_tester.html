<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Chrono Tape - SVG Visual Editor (Drag Enabled)</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    
    <script src="js/data.js"></script>         
    <script src="js/data/SVGdata.js"></script> 
    <script src="js/managers/SVGManager.js"></script>
    <script src="js/objects/Unit.js"></script>
    <script src="js/objects/Projectile.js"></script>
    
    <style>
        body { background: #1a1a1a; color: #eee; font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; margin: 0; overflow: hidden; }
        
        /* ÏôºÏ™Ω: Í≤åÏûÑ ÌôîÎ©¥ */
        #game-wrapper { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #222; position: relative; }
        #game-container { box-shadow: 0 0 30px rgba(0,0,0,0.5); border: 2px solid #444; position: relative; }
        
        /* Î°úÎî© Ïä§ÌÅ¨Î¶∞ */
        #loading-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #00ffcc; font-size: 24px; font-weight: bold;
            transition: opacity 0.5s;
        }

        /* Ïò§Î•∏Ï™Ω: Ïª®Ìä∏Î°§ Ìå®ÎÑê */
        #controls { width: 320px; background: #2a2a2a; padding: 20px; border-left: 1px solid #444; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        h2 { margin: 0 0 10px 0; color: #00ffcc; font-size: 18px; border-bottom: 2px solid #444; padding-bottom: 5px; }
        
        .control-group { background: #333; padding: 10px; border-radius: 8px; }
        label { display: block; margin-bottom: 5px; font-size: 13px; color: #aaa; }
        select, button, input { width: 100%; padding: 8px; margin-bottom: 5px; background: #444; border: 1px solid #555; color: white; border-radius: 4px; cursor: pointer; }
        button:hover { background: #555; }
        button:active { background: #00ffcc; color: black; }
        
        .anim-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .anim-btn { font-size: 12px; }

        .zoom-controls { display: flex; gap: 5px; align-items: center; }
        .zoom-val { width: 40px; text-align: center; font-weight: bold; }
    </style>
</head>
<body>

    <div id="game-wrapper">
        <div id="game-container">
            <div id="loading-screen">
                <div>üé® ÌÖçÏä§Ï≤ò ÍµΩÎäî Ï§ë...</div>
                <div style="font-size: 14px; color: #888; margin-top: 10px;">Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî</div>
            </div>
        </div>
        <div style="margin-top: 10px; color: #666; font-size: 12px;">
            üñ±Ô∏è <b>ÌååÏ∏† ÎìúÎûòÍ∑∏</b>: ÏúÑÏπò Ï°∞Ï†ï | Ìú†: Ï§å | Î∞∞Í≤Ω ÎìúÎûòÍ∑∏: Ïπ¥Î©îÎùº Ïù¥Îèô
        </div>
    </div>

    <div id="controls">
        <h2>Visual Editor</h2>
        
        <div class="control-group">
            <label>Unit Base (Stats)</label>
            <select id="unit-select" onchange="changeUnitBase(this.value)"></select>
        </div>

        <div class="control-group">
            <label>Parts Config</label>
            <label>Body</label>
            <select id="part-body" onchange="updateParts()"></select>
            
            <label>Weapon</label>
            <select id="part-weapon" onchange="updateParts()"></select>
            
            <label>Accessory</label>
            <select id="part-acc" onchange="updateParts()"></select>
        </div>

        <div class="control-group">
            <label>Animations</label>
            <div class="anim-grid">
                <button class="anim-btn" onclick="playAnim('SWING')">Swing</button>
                <button class="anim-btn" onclick="playAnim('HEAVY')">Heavy</button>
                <button class="anim-btn" onclick="playAnim('STAB')">Stab</button>
                <button class="anim-btn" onclick="playAnim('SHOOT')">Shoot</button>
                <button class="anim-btn" onclick="playAnim('CAST')">Cast</button>
                <button class="anim-btn" onclick="resetPose()" style="background:#552222">Reset Pose</button>
            </div>
        </div>
        
        <div class="control-group">
            <label>View Options</label>
            <div class="zoom-controls">
                <span>Zoom:</span>
                <input type="range" min="0.5" max="3.0" step="0.1" value="1.5" oninput="setZoom(this.value)">
                <span id="zoom-text" class="zoom-val">1.5x</span>
            </div>
            <br>
            <button onclick="toggleTeam()">Toggle Team (ALLY/ENEMY)</button>
        </div>
    </div>

    <script>
        // Ï†ÑÏó≠ ÏÑ§Ï†ï
        const config = {
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            parent: 'game-container',
            backgroundColor: '#222222',
            scene: {
                preload: preload,
                create: create,
                update: update
            },
            physics: {
                default: 'arcade',
                arcade: { debug: true }
            }
        };

        let game = new Phaser.Game(config);
        let sceneRef = null;
        let unit = null;
        let currentTeam = 'ALLY';
        let currentUnitName = 'Í≤ÄÏÇ¨';
        let coordText = null; // Ï¢åÌëú ÌëúÏãúÏö© ÌÖçÏä§Ìä∏

        window.onload = function() {
            // Ïú†Îãõ Î™©Î°ù Ï±ÑÏö∞Í∏∞
            const unitSelect = document.getElementById('unit-select');
            if (typeof UNIT_STATS !== 'undefined') {
                Object.keys(UNIT_STATS).forEach(key => {
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.innerText = key;
                    unitSelect.appendChild(opt);
                });
                unitSelect.value = 'Í≤ÄÏÇ¨';
            }

            // ÌååÏ∏† Î™©Î°ù Ï±ÑÏö∞Í∏∞
            const parts = { body: [], weapon: [], acc: [] };
            if (typeof SVG_DATA !== 'undefined') {
                Object.keys(SVG_DATA).forEach(key => {
                    if (key.startsWith('body_')) parts.body.push(key);
                    else if (key.startsWith('weapon_')) parts.weapon.push(key);
                    else if (key.startsWith('acc_')) parts.acc.push(key);
                });
            }
            
            ['body', 'weapon', 'acc'].forEach(type => {
                const sel = document.getElementById(`part-${type}`);
                const none = document.createElement('option');
                none.value = ''; none.innerText = '(None)';
                sel.appendChild(none);
                parts[type].forEach(key => {
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.innerText = key;
                    sel.appendChild(opt);
                });
            });
        };

        function preload() {}

        function create() {
            sceneRef = this;
            
            // Í≤©Ïûê Î∞è Ï§ëÏã¨ÏÑ†
            this.add.grid(400, 300, 800, 600, 40, 40, 0x000000, 0, 0x333333, 0.5);
            this.add.line(0, 0, 400, 0, 400, 600, 0x00ffcc, 0.3).setOrigin(0);
            this.add.line(0, 0, 0, 300, 800, 300, 0x00ffcc, 0.3).setOrigin(0);

            // ‚òÖ [Ï¢åÌëú ÌëúÏãú UI]
            coordText = this.add.text(10, 10, 'ÌååÏ∏†Î•º ÎìúÎûòÍ∑∏ÌïòÏó¨ Ï¢åÌëú ÌôïÏù∏', { 
                font: '16px monospace', fill: '#00ff00', backgroundColor: '#000000aa', padding: { x: 5, y: 5 } 
            }).setScrollFactor(0).setDepth(1000);

            // ‚òÖ [ÎìúÎûòÍ∑∏ Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨]
            this.input.on('dragstart', (pointer, gameObject) => {
                gameObject.setTint(0xffff00); // ÏÑ†ÌÉùÎêú ÌååÏ∏† ÎÖ∏ÎûÄÏÉâÏúºÎ°ú ÌëúÏãú
                updateCoordInfo(gameObject);
            });

            this.input.on('drag', (pointer, gameObject, dragX, dragY) => {
                // Ï§å ÎπÑÏú®ÏùÑ Í≥†Î†§Ìïú Îç∏ÌÉÄ Ïù¥Îèô (Ïª®ÌÖåÏù¥ÎÑà ÎÇ¥Î∂Ä Ï¢åÌëú Ïú†ÏßÄ)
                const dx = (pointer.x - pointer.prevPosition.x) / this.cameras.main.zoom;
                const dy = (pointer.y - pointer.prevPosition.y) / this.cameras.main.zoom;
                
                gameObject.x += dx;
                gameObject.y += dy;
                
                updateCoordInfo(gameObject);
            });

            this.input.on('dragend', (pointer, gameObject) => {
                gameObject.clearTint();
                // ÏΩòÏÜîÏóê Î≥µÏÇ¨ÌïòÍ∏∞ Ï¢ãÍ≤å Ï∂úÎ†•
                console.log(`‚úÖ [${gameObject.partKey}] Final Offset: { x: ${Math.round(gameObject.x)}, y: ${Math.round(gameObject.y)} }`);
            });

            // Î∞∞Í≤Ω ÎìúÎûòÍ∑∏ Ïãú Ïπ¥Î©îÎùº Ïù¥Îèô
            this.input.on('pointermove', (p) => {
                if (p.isDown && sceneRef.input.getDragState(p) === 0) { // ÌååÏ∏† ÎìúÎûòÍ∑∏ Ï§ëÏù¥ ÏïÑÎãê ÎïåÎßå
                    this.cameras.main.scrollX -= (p.x - p.prevPosition.x) / this.cameras.main.zoom;
                    this.cameras.main.scrollY -= (p.y - p.prevPosition.y) / this.cameras.main.zoom;
                }
            });

            // SVG ÍµΩÍ∏∞ ÏãúÏûë
            this.svgManager = new SVGManager(this);
            this.svgManager.prebakeAllTextures(() => {
                const loading = document.getElementById('loading-screen');
                if(loading) loading.style.opacity = 0;
                setTimeout(() => { if(loading) loading.style.display = 'none'; }, 500);
                spawnUnit();
            });

            this.cameras.main.setZoom(1.5);
        }

        function update() {
            if (unit) unit.update(0.016);
        }

        function updateCoordInfo(part) {
            if (coordText) {
                const x = Math.round(part.x);
                const y = Math.round(part.y);
                coordText.setText(`[${part.partKey}] x: ${x}, y: ${y}`);
            }
        }

        function spawnUnit() {
            if (unit) unit.destroy();
            if (!sceneRef) return;

            const baseStats = UNIT_STATS[currentUnitName];
            
            const customParts = {};
            const b = document.getElementById('part-body').value;
            const w = document.getElementById('part-weapon').value;
            const a = document.getElementById('part-acc').value;

            if (b) customParts.body = b;
            if (w) customParts.weapon = w;
            if (a) customParts.acc = a;
            
            const finalStats = JSON.parse(JSON.stringify(baseStats));
            finalStats.parts = { ...finalStats.parts, ...customParts };

            unit = new Unit(sceneRef, 400, 300, currentUnitName, currentTeam, finalStats);
            
            // ‚òÖ [ÎìúÎûòÍ∑∏ Í∏∞Îä• ÌôúÏÑ±Ìôî] ÏÉùÏÑ±Îêú ÌååÏ∏†Îì§Ïóê Ïù∏ÌÑ∞ÎûôÌã∞Î∏å ÏÑ§Ï†ï
            if (unit.parts) {
                Object.keys(unit.parts).forEach(key => {
                    const part = unit.parts[key];
                    part.setInteractive({ draggable: true, pixelPerfect: true }); // pixelPerfectÎ°ú Ï†ïÎ∞ÄÌïú ÏÑ†ÌÉù
                    part.partKey = key; // ÏãùÎ≥ÑÏûê Ï†ÄÏû• (body, weapon Îì±)
                });
            }

            if (!b && finalStats.parts.body) document.getElementById('part-body').value = finalStats.parts.body;
            if (!w && finalStats.parts.weapon) document.getElementById('part-weapon').value = finalStats.parts.weapon;
            if (!a && finalStats.parts.acc) document.getElementById('part-acc').value = finalStats.parts.acc;
        }

        function changeUnitBase(name) {
            currentUnitName = name;
            document.getElementById('part-body').value = '';
            document.getElementById('part-weapon').value = '';
            document.getElementById('part-acc').value = '';
            spawnUnit();
        }

        function updateParts() { spawnUnit(); }
        
        function toggleTeam() {
            currentTeam = (currentTeam === 'ALLY') ? 'ENEMY' : 'ALLY';
            spawnUnit();
        }

        function playAnim(type) {
            if (!unit) return;
            console.log("Playing Anim:", type);
            switch(type) {
                case 'SWING': unit.playSwingAnim(); break;
                case 'HEAVY': unit.playHeavySwingAnim(); break;
                case 'STAB':  unit.playStabAnim(); break;
                case 'SHOOT': unit.playShootAnim(); break;
                case 'CAST':  unit.playCastAnim(); break;
            }
        }

        function resetPose() {
            if (!unit) return;
            spawnUnit(); 
        }

        function setZoom(val) {
            if (sceneRef) sceneRef.cameras.main.setZoom(parseFloat(val));
            document.getElementById('zoom-text').innerText = val + "x";
        }
    </script>
</body>
</html>